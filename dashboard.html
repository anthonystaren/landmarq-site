<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,300;0,400;0,600;0,700;1,300;1,400;1,600&family=Syne:wght@400;500;600;700;800&family=JetBrains+Mono:wght@300;400;500&display=swap" rel="stylesheet">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>LandMarq ‚Äî Executive Intelligence Dashboard</title>
<style>
:root {
  --bg: #0B0D0F;
  --surface: #111418;
  --surface-2: #181C22;
  --surface-3: #1E232B;
  --border: rgba(255,255,255,0.07);
  --border-gold: rgba(196,158,84,0.25);
  --gold: #C49E54;
  --gold-dim: rgba(196,158,84,0.12);
  --gold-bright: #E8C97A;
  --cream: #F0EAD6;
  --text: #D4CCBA;
  --text-dim: #6B6558;
  --text-mid: #9B9080;
  --green: #4A9B6F;
  --green-dim: rgba(74,155,111,0.15);
  --red: #C0533A;
  --red-dim: rgba(192,83,58,0.15);
  --blue: #4A7FA5;
  --blue-dim: rgba(74,127,165,0.15);
  --amber: #D4883A;
}

*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
html, body { height: 100%; overflow: hidden; }

/* Auth gate: hide everything until verified */
body:not(.auth-ready) > *:not(script) { opacity: 0; }
body.auth-ready > * { transition: opacity 0.3s ease; opacity: 1; }

body {
  font-family: 'Syne', sans-serif;
  background: var(--bg);
  color: var(--text);
  display: flex;
  height: 100vh;
  overflow: hidden;
}

/* ‚îÄ‚îÄ‚îÄ ONBOARDING OVERLAY ‚îÄ‚îÄ‚îÄ */
#onboarding-overlay {
  position: fixed;
  inset: 0;
  z-index: 1000;
  display: flex;
  align-items: center;
  justify-content: center;
  background: rgba(11,13,15,0.92);
  backdrop-filter: blur(8px);
  transition: opacity 0.4s;
}

#onboarding-overlay.hidden {
  opacity: 0;
  pointer-events: none;
}

.onboarding-modal {
  background: var(--surface);
  border: 1px solid var(--border-gold);
  border-radius: 12px;
  width: 620px;
  max-width: 95vw;
  overflow: hidden;
  box-shadow: 0 40px 120px rgba(0,0,0,0.6), 0 0 0 1px rgba(196,158,84,0.1);
  animation: modalIn 0.5s cubic-bezier(0.34,1.56,0.64,1);
}

@keyframes modalIn {
  from { opacity: 0; transform: translateY(30px) scale(0.95); }
  to { opacity: 1; transform: translateY(0) scale(1); }
}

.ob-header {
  padding: 28px 32px 0;
  display: flex;
  align-items: flex-start;
  justify-content: space-between;
}

.ob-logo {
  font-family: 'Cormorant Garamond', serif;
  font-size: 24px;
  font-weight: 600;
  color: var(--cream);
  letter-spacing: 0.04em;
}

.ob-logo span { color: var(--gold); }

.ob-step-counter {
  font-family: 'JetBrains Mono', monospace;
  font-size: 10px;
  letter-spacing: 0.15em;
  color: var(--text-dim);
  text-transform: uppercase;
  margin-top: 4px;
}

.ob-progress {
  height: 2px;
  background: var(--surface-3);
  margin: 20px 32px 0;
  border-radius: 1px;
  overflow: hidden;
}

.ob-progress-fill {
  height: 100%;
  background: linear-gradient(90deg, var(--gold), var(--gold-bright));
  border-radius: 1px;
  transition: width 0.5s cubic-bezier(0.4,0,0.2,1);
}

.ob-body {
  padding: 28px 32px;
  min-height: 260px;
}

.ob-step { display: none; }
.ob-step.active { display: block; animation: stepIn 0.3s ease-out; }

@keyframes stepIn {
  from { opacity: 0; transform: translateX(16px); }
  to { opacity: 1; transform: translateX(0); }
}

.ob-step-icon {
  font-size: 36px;
  margin-bottom: 16px;
  display: block;
}

.ob-step-title {
  font-family: 'Cormorant Garamond', serif;
  font-size: 28px;
  font-weight: 600;
  color: var(--cream);
  line-height: 1.2;
  margin-bottom: 12px;
}

.ob-step-title em { font-style: italic; color: var(--gold); }

.ob-step-desc {
  font-size: 14px;
  color: var(--text-mid);
  line-height: 1.7;
  margin-bottom: 20px;
  font-weight: 400;
}

.ob-features {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 10px;
  margin-top: 16px;
}

.ob-feature {
  background: var(--surface-3);
  border: 1px solid rgba(255,255,255,0.09);
  border-radius: 6px;
  padding: 12px 14px;
  display: flex;
  align-items: flex-start;
  gap: 10px;
  transition: border-color 0.2s;
}

.ob-feature:hover { border-color: var(--border-gold); }

.ob-feature-icon { font-size: 16px; flex-shrink: 0; margin-top: 1px; }

.ob-feature-text { font-size: 12px; color: var(--text); line-height: 1.4; }
.ob-feature-text strong { color: var(--cream); display: block; margin-bottom: 2px; font-size: 12px; }

/* Onboarding interactive steps */
.ob-input-group { margin-bottom: 12px; }
.ob-label {
  font-family: 'JetBrains Mono', monospace;
  font-size: 9px;
  letter-spacing: 0.15em;
  text-transform: uppercase;
  color: var(--text-dim);
  margin-bottom: 6px;
  display: block;
}

.ob-input {
  width: 100%;
  background: var(--surface-2);
  border: 1px solid var(--border);
  border-radius: 5px;
  padding: 10px 14px;
  color: var(--cream);
  font-family: 'Syne', sans-serif;
  font-size: 13px;
  outline: none;
  transition: border-color 0.2s;
}

.ob-input:focus { border-color: var(--gold); }

.ob-chips-row {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  margin-top: 10px;
}

.ob-chip {
  padding: 7px 14px;
  border-radius: 4px;
  font-family: 'JetBrains Mono', monospace;
  font-size: 9px;
  letter-spacing: 0.1em;
  text-transform: uppercase;
  cursor: pointer;
  border: 1px solid var(--border);
  background: var(--surface-2);
  color: var(--text-dim);
  transition: all 0.15s;
  user-select: none;
}

.ob-chip:hover { color: var(--text); border-color: rgba(255,255,255,0.15); }
.ob-chip.selected { background: var(--gold-dim); color: var(--gold); border-color: var(--border-gold); }

.ob-agent-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 8px;
  margin-top: 10px;
}

.ob-agent-toggle {
  background: var(--surface-2);
  border: 1px solid var(--border);
  border-radius: 6px;
  padding: 12px 14px;
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 10px;
  transition: all 0.15s;
}

.ob-agent-toggle.on { border-color: var(--border-gold); background: var(--gold-dim); }

.ob-agent-toggle .toggle-icon { font-size: 16px; }

.ob-agent-toggle .toggle-info {}
.ob-agent-toggle .toggle-name { font-size: 11px; color: var(--cream); font-weight: 600; }
.ob-agent-toggle .toggle-desc { font-size: 10px; color: var(--text-dim); margin-top: 1px; }

.ob-agent-toggle .toggle-dot {
  width: 8px; height: 8px; border-radius: 50%;
  background: var(--surface-3);
  border: 1px solid var(--border);
  margin-left: auto;
  flex-shrink: 0;
  transition: all 0.2s;
}

.ob-agent-toggle.on .toggle-dot { background: var(--green); border-color: var(--green); box-shadow: 0 0 6px rgba(74,155,111,0.5); }

.ob-footer {
  padding: 20px 32px 28px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  border-top: 1px solid var(--border);
}

.ob-btn-skip {
  font-family: 'JetBrains Mono', monospace;
  font-size: 9px;
  letter-spacing: 0.12em;
  text-transform: uppercase;
  color: var(--text-dim);
  cursor: pointer;
  transition: color 0.15s;
  background: none;
  border: none;
}

.ob-btn-skip:hover { color: var(--text); }

.ob-btn-next {
  background: var(--gold);
  color: var(--bg);
  font-family: 'Syne', sans-serif;
  font-size: 13px;
  font-weight: 600;
  padding: 11px 28px;
  border-radius: 5px;
  border: none;
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 8px;
  transition: all 0.2s;
}

.ob-btn-next:hover { background: var(--gold-bright); transform: translateY(-1px); box-shadow: 0 6px 20px rgba(196,158,84,0.25); }

/* Spotlight highlight for tour steps */
.spotlight-ring {
  position: fixed;
  border: 2px solid var(--gold);
  border-radius: 8px;
  box-shadow: 0 0 0 4000px rgba(11,13,15,0.7), 0 0 30px rgba(196,158,84,0.3);
  transition: all 0.4s cubic-bezier(0.4,0,0.2,1);
  z-index: 990;
  pointer-events: none;
  display: none;
}

.spotlight-ring.visible { display: block; }

.spotlight-tooltip {
  position: fixed;
  background: var(--surface-3);
  border: 1px solid var(--border-gold);
  border-radius: 8px;
  padding: 16px 20px;
  width: 280px;
  z-index: 995;
  display: none;
  box-shadow: 0 20px 60px rgba(0,0,0,0.5);
  animation: tooltipIn 0.3s ease-out;
}

@keyframes tooltipIn {
  from { opacity: 0; transform: translateY(8px); }
  to { opacity: 1; transform: translateY(0); }
}

.spotlight-tooltip.visible { display: block; }

.tooltip-step { font-family: 'JetBrains Mono', monospace; font-size: 8px; letter-spacing: 0.15em; color: var(--gold); text-transform: uppercase; margin-bottom: 6px; }
.tooltip-title { font-family: 'Cormorant Garamond', serif; font-size: 17px; font-weight: 600; color: var(--cream); margin-bottom: 6px; }
.tooltip-desc { font-size: 12px; color: var(--text-mid); line-height: 1.55; }
.tooltip-nav { display: flex; justify-content: space-between; align-items: center; margin-top: 14px; }
.tooltip-nav-btn {
  font-family: 'JetBrains Mono', monospace; font-size: 8px; letter-spacing: 0.1em; text-transform: uppercase;
  padding: 6px 14px; border-radius: 4px; cursor: pointer; border: 1px solid var(--border-gold);
  background: var(--gold-dim); color: var(--gold); transition: all 0.15s;
}
.tooltip-nav-btn:hover { background: rgba(196,158,84,0.25); }
.tooltip-close { font-family: 'JetBrains Mono', monospace; font-size: 8px; color: var(--text-dim); cursor: pointer; letter-spacing: 0.08em; text-transform: uppercase; }
.tooltip-close:hover { color: var(--text); }

/* ‚îÄ‚îÄ‚îÄ SIDEBAR ‚îÄ‚îÄ‚îÄ */
.sidebar {
  width: 220px;
  flex-shrink: 0;
  background: var(--surface);
  border-right: 1px solid var(--border);
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

.sidebar-logo {
  padding: 22px 22px 18px;
  border-bottom: 1px solid var(--border);
}

.logo-wordmark {
  font-family: 'Cormorant Garamond', serif;
  font-size: 22px;
  font-weight: 600;
  color: var(--cream);
  letter-spacing: 0.04em;
  line-height: 1;
}

.logo-wordmark .lm-land { color: var(--cream); }
.logo-wordmark .lm-marq { color: var(--gold); }

.logo-sub {
  font-family: 'JetBrains Mono', monospace;
  font-size: 7.5px;
  letter-spacing: 0.2em;
  color: var(--text-dim);
  text-transform: uppercase;
  margin-top: 4px;
}

.user-card {
  padding: 14px 22px;
  border-bottom: 1px solid var(--border);
  display: flex;
  align-items: center;
  gap: 10px;
}

.user-avatar {
  width: 32px; height: 32px; border-radius: 50%;
  background: linear-gradient(135deg, var(--gold), #8B6A2E);
  display: flex; align-items: center; justify-content: center;
  font-family: 'Cormorant Garamond', serif;
  font-size: 14px; font-weight: 600; color: var(--bg); flex-shrink: 0;
}

.user-name { font-size: 12px; font-weight: 600; color: var(--cream); line-height: 1.2; }
.user-title { font-family: 'JetBrains Mono', monospace; font-size: 7.5px; color: var(--text-dim); letter-spacing: 0.05em; margin-top: 2px; }

.nav-section { padding: 14px 0 6px; }
.nav-label { font-family: 'JetBrains Mono', monospace; font-size: 7px; letter-spacing: 0.2em; text-transform: uppercase; color: var(--text-dim); padding: 0 22px 8px; }

.nav-item {
  display: flex; align-items: center; gap: 10px;
  padding: 9px 22px; cursor: pointer; transition: all 0.15s;
  border-left: 2px solid transparent; font-size: 12px; font-weight: 500; color: var(--text-dim);
}

.nav-item:hover { color: var(--text); background: rgba(255,255,255,0.03); }
.nav-item.active { color: var(--gold); border-left-color: var(--gold); background: var(--gold-dim); }
.nav-icon { width: 15px; text-align: center; font-size: 11px; }

.nav-badge {
  margin-left: auto; background: var(--red); color: white;
  font-family: 'JetBrains Mono', monospace; font-size: 8px;
  padding: 2px 6px; border-radius: 10px;
}
.nav-badge.green { background: var(--green); }
.nav-badge.gold { background: var(--gold); color: var(--bg); }

.sidebar-footer {
  margin-top: auto; padding: 14px 22px; border-top: 1px solid var(--border);
}

.pulse-dot {
  width: 7px; height: 7px; background: var(--green); border-radius: 50%;
  animation: pulseDot 2.5s ease-in-out infinite; flex-shrink: 0;
}
@keyframes pulseDot {
  0%,100% { box-shadow: 0 0 0 0 rgba(74,155,111,0.4); }
  50% { box-shadow: 0 0 0 5px rgba(74,155,111,0); }
}

.status-indicator { display: flex; align-items: center; gap: 8px; }
.status-text { font-family: 'JetBrains Mono', monospace; font-size: 9px; color: var(--green); letter-spacing: 0.08em; }

/* ‚îÄ‚îÄ‚îÄ MAIN ‚îÄ‚îÄ‚îÄ */
.main { flex: 1; display: flex; flex-direction: column; overflow: hidden; min-width: 0; min-height: 0; }

.topbar {
  height: 54px; border-bottom: 1px solid var(--border);
  display: flex; align-items: center; padding: 0 24px; gap: 16px;
  flex-shrink: 0; background: var(--surface);
}

.topbar-title { font-family: 'Cormorant Garamond', serif; font-size: 18px; font-weight: 600; color: var(--cream); letter-spacing: 0.02em; }
.topbar-date { font-family: 'JetBrains Mono', monospace; font-size: 9px; color: var(--text-dim); letter-spacing: 0.1em; text-transform: uppercase; }

.topbar-right { margin-left: auto; display: flex; align-items: center; gap: 10px; }

.topbar-chip {
  display: flex; align-items: center; gap: 6px;
  background: var(--gold-dim); border: 1px solid var(--border-gold);
  border-radius: 3px; padding: 5px 12px;
  font-family: 'JetBrains Mono', monospace; font-size: 9px; color: var(--gold);
  letter-spacing: 0.1em; text-transform: uppercase;
}

/* ‚îÄ‚îÄ ADD INTELLIGENCE BUTTON ‚îÄ‚îÄ */
.add-intel-btn {
  display: flex; align-items: center; gap: 7px;
  background: var(--gold); color: var(--bg);
  border: none; border-radius: 4px; padding: 7px 16px;
  font-family: 'Syne', sans-serif; font-size: 12px; font-weight: 600;
  cursor: pointer; transition: all 0.2s; white-space: nowrap;
}
.add-intel-btn:hover { background: var(--gold-bright); transform: translateY(-1px); box-shadow: 0 4px 16px rgba(196,158,84,0.25); }

.add-deal-btn {
  background: var(--surface-2); color: var(--gold); border: 1px solid var(--border-gold);
  border-radius: 4px; padding: 5px 12px; font-family: 'Syne', sans-serif;
  font-size: 10px; font-weight: 600; cursor: pointer; transition: all 0.2s;
  letter-spacing: 0.02em;
}
.add-deal-btn:hover { background: var(--gold-dim); }

.icon-btn {
  width: 32px; height: 32px; border-radius: 4px;
  background: var(--surface-2); border: 1px solid var(--border);
  display: flex; align-items: center; justify-content: center;
  cursor: pointer; font-size: 13px; color: var(--text-dim); transition: all 0.15s;
}
.icon-btn:hover { color: var(--text); border-color: rgba(255,255,255,0.15); }

/* ‚îÄ‚îÄ‚îÄ CONTENT ‚îÄ‚îÄ‚îÄ */
.content {
  flex: 1; overflow-y: auto; overflow-x: hidden; padding: 18px 20px 40px;
  min-height: 0;
  display: grid;
  grid-template-columns: 1fr 1fr 1fr 310px;
  grid-template-rows: auto auto auto auto auto;
  gap: 12px; align-content: start;
}

.content::-webkit-scrollbar { width: 3px; }
.content::-webkit-scrollbar-thumb { background: var(--surface-3); border-radius: 2px; }

/* ‚îÄ‚îÄ‚îÄ CARDS ‚îÄ‚îÄ‚îÄ */
.card {
  background: var(--surface); border: 1px solid var(--border);
  border-radius: 6px; overflow: hidden; transition: border-color 0.2s;
}
.card:hover { border-color: rgba(255,255,255,0.11); }

.card-header {
  padding: 13px 16px 0;
  display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;
}

.card-title {
  font-family: 'JetBrains Mono', monospace; font-size: 8.5px;
  letter-spacing: 0.18em; text-transform: uppercase; color: var(--text-dim);
  display: flex; align-items: center; gap: 7px;
}
.card-title::before { content: ''; width: 3px; height: 3px; background: var(--gold); border-radius: 50%; }

.card-action { font-family: 'JetBrains Mono', monospace; font-size: 8px; letter-spacing: 0.1em; color: var(--text-dim); cursor: pointer; transition: color 0.15s; text-transform: uppercase; }
.card-action:hover { color: var(--gold); }

/* ‚îÄ‚îÄ‚îÄ KPI ROW ‚îÄ‚îÄ‚îÄ */
.kpi-row { grid-column: 1 / -1; display: grid; grid-template-columns: repeat(6,1fr); gap: 12px; }

.kpi-card {
  background: var(--surface); border: 1px solid var(--border); border-radius: 6px;
  padding: 14px 16px; position: relative; overflow: hidden; cursor: default; transition: all 0.2s;
}

.kpi-card::after {
  content: ''; position: absolute; bottom: 0; left: 0; right: 0; height: 2px;
  background: var(--gold); transform: scaleX(0); transform-origin: left; transition: transform 0.3s;
}
.kpi-card:hover::after { transform: scaleX(1); }
.kpi-card:hover { border-color: var(--border-gold); }

.kpi-label { font-family: 'JetBrains Mono', monospace; font-size: 7px; letter-spacing: 0.2em; text-transform: uppercase; color: var(--text-dim); margin-bottom: 8px; }
.kpi-value { font-family: 'Cormorant Garamond', serif; font-size: 30px; font-weight: 300; color: var(--cream); line-height: 1; letter-spacing: -0.01em; }
.kpi-value.gold { color: var(--gold); }
.kpi-delta { display: flex; align-items: center; gap: 4px; margin-top: 5px; font-family: 'JetBrains Mono', monospace; font-size: 8.5px; }
.delta-up { color: var(--green); }
.delta-down { color: var(--red); }
.delta-neutral { color: var(--text-dim); }
.kpi-sub { font-size: 9px; color: var(--text-dim); margin-left: 3px; }

/* ‚îÄ‚îÄ‚îÄ HEATMAP ‚îÄ‚îÄ‚îÄ */
.heatmap-card { grid-column: 1 / 3; }
.heatmap-body { padding: 0 16px 14px; overflow: visible; }
.heatmap-tabs { display: flex; gap: 0; padding: 0 16px 10px; overflow-x: auto; }
.heatmap-tab { padding: 6px 14px; font-family: 'JetBrains Mono', monospace; font-size: 8px; letter-spacing: 0.1em; text-transform: uppercase; color: var(--text-dim); cursor: pointer; border: 1px solid var(--border); border-radius: 3px; background: transparent; transition: all 0.15s; white-space: nowrap; margin-right: 4px; }
.heatmap-tab:hover { color: var(--text); border-color: rgba(255,255,255,0.15); }
.heatmap-tab.active { background: var(--gold-dim); color: var(--gold); border-color: var(--border-gold); }
.heatmap-grid { display: grid; grid-template-columns: repeat(5,1fr); gap: 5px; grid-auto-rows: minmax(52px, auto); }
.heatmap-cell { border-radius: 4px; padding: 9px 7px; cursor: pointer; transition: all 0.2s; min-height: 52px; overflow: visible; }
.heatmap-cell:hover { filter: brightness(1.25); transform: scale(1.05); z-index: 1; position: relative; }
.heat-market { font-size: 8px; font-weight: 600; color: rgba(255,255,255,0.9); margin-bottom: 2px; line-height: 1.2; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.heat-val { font-family: 'JetBrains Mono', monospace; font-size: 10px; color: rgba(255,255,255,0.7); }

/* ‚îÄ‚îÄ‚îÄ AGENT FEED ‚îÄ‚îÄ‚îÄ */
.agents-card { grid-column: 3 / 4; }
.agent-stream { padding: 0 16px 14px; display: flex; flex-direction: column; gap: 1px; max-height: 230px; overflow-y: auto; }
.agent-stream::-webkit-scrollbar { width: 2px; }
.agent-stream::-webkit-scrollbar-thumb { background: var(--border); }

.stream-item { display: flex; gap: 9px; padding: 8px 0; border-bottom: 1px solid var(--border); animation: streamIn 0.4s ease-out; }
@keyframes streamIn { from { opacity:0; transform:translateX(-8px); } to { opacity:1; transform:translateX(0); } }

.stream-icon { width: 22px; height: 22px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 10px; flex-shrink: 0; margin-top: 1px; }
.icon-intel { background: var(--blue-dim); border: 1px solid rgba(74,127,165,0.3); }
.icon-lead { background: var(--gold-dim); border: 1px solid var(--border-gold); }
.icon-doc { background: var(--green-dim); border: 1px solid rgba(74,155,111,0.3); }
.icon-alert { background: var(--red-dim); border: 1px solid rgba(192,83,58,0.3); }

.stream-text { font-size: 11px; color: var(--text); line-height: 1.4; font-weight: 400; }
.stream-text strong { color: var(--cream); font-weight: 600; }
.stream-meta { font-family: 'JetBrains Mono', monospace; font-size: 7.5px; color: var(--text-dim); margin-top: 2px; letter-spacing: 0.04em; display: flex; align-items: center; gap: 6px; }
.stream-tag { padding: 1px 5px; border-radius: 2px; font-size: 7px; letter-spacing: 0.08em; text-transform: uppercase; }
.tag-intel { background: var(--blue-dim); color: var(--blue); }
.tag-lead { background: var(--gold-dim); color: var(--gold); }
.tag-doc { background: var(--green-dim); color: var(--green); }
.tag-alert { background: var(--red-dim); color: var(--red); }

.typing-dot { display: inline-block; width: 4px; height: 4px; background: var(--gold); border-radius: 50%; animation: typeDot 1.4s ease-in-out infinite; margin: 0 1px; }
.typing-dot:nth-child(2) { animation-delay: 0.2s; }
.typing-dot:nth-child(3) { animation-delay: 0.4s; }
@keyframes typeDot { 0%,60%,100% { transform:translateY(0);opacity:0.3; } 30% { transform:translateY(-4px);opacity:1; } }

/* ‚îÄ‚îÄ‚îÄ ALERTS (right column) ‚îÄ‚îÄ‚îÄ */
.alerts-card { grid-column: 4/5; grid-row: 2/6; align-self: start; }
.alerts-body { padding: 0 13px 14px; display: flex; flex-direction: column; gap: 7px; max-height: 660px; overflow-y: auto; }
.alerts-body::-webkit-scrollbar { width: 2px; }
.alerts-body::-webkit-scrollbar-thumb { background: var(--border); }

.alert-item { border-radius: 5px; padding: 11px 12px; cursor: pointer; transition: all 0.2s; border: 1px solid transparent; }
.alert-item:hover { filter: brightness(1.1); }
.alert-high { background: var(--red-dim); border-color: rgba(192,83,58,0.2); border-left: 3px solid var(--red); }
.alert-med { background: rgba(212,136,58,0.08); border-color: rgba(212,136,58,0.2); border-left: 3px solid var(--amber); }
.alert-low { background: var(--blue-dim); border-color: rgba(74,127,165,0.2); border-left: 3px solid var(--blue); }

.alert-priority { font-family: 'JetBrains Mono', monospace; font-size: 7px; letter-spacing: 0.15em; text-transform: uppercase; margin-bottom: 4px; }
.alert-high .alert-priority { color: var(--red); }
.alert-med .alert-priority { color: var(--amber); }
.alert-low .alert-priority { color: var(--blue); }
.alert-title { font-size: 11px; font-weight: 600; color: var(--cream); line-height: 1.3; margin-bottom: 3px; }
.alert-body { font-size: 9.5px; color: var(--text-dim); line-height: 1.5; }
.alert-footer { display: flex; justify-content: space-between; align-items: center; margin-top: 6px; }
.alert-agent { font-family: 'JetBrains Mono', monospace; font-size: 7px; color: var(--text-dim); }
.alert-time { font-family: 'JetBrains Mono', monospace; font-size: 7px; color: var(--text-dim); }
.alert-action-btn {
  display: block; width: 100%; text-align: center; margin-top: 5px; padding: 5px;
  border-radius: 3px; font-family: 'JetBrains Mono', monospace; font-size: 8px;
  letter-spacing: 0.1em; text-transform: uppercase; cursor: pointer;
  border: 1px solid rgba(196,158,84,0.3); color: var(--gold); background: var(--gold-dim);
  transition: all 0.15s;
}
.alert-action-btn:hover { background: rgba(196,158,84,0.22); }

/* ‚îÄ‚îÄ‚îÄ SPARKLINES ‚îÄ‚îÄ‚îÄ */
.sparkline-row { grid-column: 1/4; display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; }
.spark-body { padding: 0 16px 14px; }
.spark-stat { display: flex; justify-content: space-between; align-items: baseline; margin-bottom: 8px; }
.spark-big { font-family: 'Cormorant Garamond', serif; font-size: 26px; font-weight: 300; color: var(--cream); line-height: 1; }
.spark-delta { font-family: 'JetBrains Mono', monospace; font-size: 9px; }
.spark-main { display: flex; align-items: flex-end; gap: 2px; height: 46px; }
.spark-bar { flex: 1; border-radius: 2px 2px 0 0; transition: all 0.3s; cursor: pointer; }
.spark-bar:hover { filter: brightness(1.4); }
.spark-bar.gold-bar { background: var(--gold-dim); border: 1px solid rgba(196,158,84,0.2); }
.spark-bar.gold-bar.current { background: var(--gold); }
.spark-bar.green-bar { background: var(--green-dim); border: 1px solid rgba(74,155,111,0.2); }
.spark-bar.green-bar.current { background: var(--green); }
.spark-bar.blue-bar { background: var(--blue-dim); border: 1px solid rgba(74,127,165,0.2); }
.spark-bar.blue-bar.current { background: var(--blue); }
.spark-labels { display: flex; justify-content: space-between; margin-top: 5px; }
.spark-label { font-family: 'JetBrains Mono', monospace; font-size: 7px; color: var(--text-dim); }

/* ‚îÄ‚îÄ‚îÄ PIPELINE ‚îÄ‚îÄ‚îÄ */
.pipeline-card { grid-column: 1/4; }
.pipeline-body { padding: 0 16px 14px; }
.pipeline-table { width: 100%; border-collapse: collapse; font-size: 11px; }
.pipeline-table th { font-family: 'JetBrains Mono', monospace; font-size: 7px; letter-spacing: 0.18em; text-transform: uppercase; color: var(--text-dim); text-align: left; padding: 0 8px 8px 0; border-bottom: 1px solid var(--border); white-space: nowrap; }
.pipeline-table td { padding: 10px 8px 10px 0; border-bottom: 1px solid var(--border); color: var(--text); vertical-align: middle; }
.pipeline-table tr:last-child td { border-bottom: none; }
.pipeline-table tr:hover td { color: var(--cream); background: rgba(255,255,255,0.015); }
.tenant-name { font-weight: 600; color: var(--cream); font-size: 11.5px; }
.tenant-sub { font-family: 'JetBrains Mono', monospace; font-size: 7.5px; color: var(--text-dim); margin-top: 2px; }
.size-val { font-family: 'JetBrains Mono', monospace; font-size: 10.5px; }
.value-cell { font-family: 'Cormorant Garamond', serif; font-size: 15px; font-weight: 600; color: var(--cream); }
.market-tag { font-family: 'JetBrains Mono', monospace; font-size: 8px; padding: 2px 7px; background: var(--surface-3); border-radius: 2px; color: var(--text-dim); white-space: nowrap; }
.stage-pill { display: inline-flex; align-items: center; gap: 4px; padding: 2px 8px; border-radius: 20px; font-family: 'JetBrains Mono', monospace; font-size: 7.5px; letter-spacing: 0.08em; text-transform: uppercase; white-space: nowrap; }
.stage-prospect { background: var(--blue-dim); color: var(--blue); border: 1px solid rgba(74,127,165,0.2); }
.stage-qualify { background: rgba(212,136,58,0.1); color: var(--amber); border: 1px solid rgba(212,136,58,0.2); }
.stage-proposal { background: var(--gold-dim); color: var(--gold); border: 1px solid var(--border-gold); }
.stage-loi { background: var(--green-dim); color: var(--green); border: 1px solid rgba(74,155,111,0.2); }
.stage-closing { background: rgba(74,155,111,0.25); color: #5ed49b; border: 1px solid rgba(74,155,111,0.35); }
.prob-bar-wrap { display: flex; align-items: center; gap: 7px; }
.prob-bar-bg { flex: 1; height: 3px; background: var(--surface-3); border-radius: 2px; overflow: hidden; min-width: 40px; }
.prob-bar-fill { height: 100%; border-radius: 2px; background: var(--gold); }
.prob-bar-fill.green { background: var(--green); }
.prob-bar-fill.blue { background: var(--blue); }
.prob-bar-fill.amber { background: var(--amber); }
.prob-val { font-family: 'JetBrains Mono', monospace; font-size: 8.5px; color: var(--text-mid); white-space: nowrap; }
.action-dots { display: flex; gap: 3px; cursor: pointer; padding: 4px; }
.action-dots span { width: 3px; height: 3px; background: var(--text-dim); border-radius: 50%; }

/* ‚îÄ‚îÄ‚îÄ ADD INTELLIGENCE PANEL ‚îÄ‚îÄ‚îÄ */
#intel-panel {
  position: fixed; right: 0; top: 0; bottom: 0; width: 440px;
  background: var(--surface); border-left: 1px solid var(--border-gold);
  z-index: 500; transform: translateX(100%);
  transition: transform 0.35s cubic-bezier(0.4,0,0.2,1);
  display: flex; flex-direction: column;
  box-shadow: -20px 0 60px rgba(0,0,0,0.4);
}

#intel-panel.open { transform: translateX(0); }

.panel-header {
  padding: 22px 24px 18px;
  border-bottom: 1px solid var(--border);
  display: flex; align-items: flex-start; justify-content: space-between;
  flex-shrink: 0;
}

.panel-title { font-family: 'Cormorant Garamond', serif; font-size: 22px; font-weight: 600; color: var(--cream); }
.panel-sub { font-family: 'JetBrains Mono', monospace; font-size: 8.5px; color: var(--text-dim); letter-spacing: 0.1em; text-transform: uppercase; margin-top: 3px; }
.panel-close { width: 28px; height: 28px; border-radius: 4px; background: var(--surface-2); border: 1px solid var(--border); display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 14px; color: var(--text-dim); transition: all 0.15s; }
.panel-close:hover { color: var(--cream); border-color: rgba(255,255,255,0.15); }

.panel-body { flex: 1; overflow-y: auto; padding: 20px 24px; }
.panel-body::-webkit-scrollbar { width: 3px; }
.panel-body::-webkit-scrollbar-thumb { background: var(--surface-3); }

.panel-section { margin-bottom: 24px; }
.panel-section-title { font-family: 'JetBrains Mono', monospace; font-size: 8px; letter-spacing: 0.2em; text-transform: uppercase; color: var(--gold); margin-bottom: 12px; display: flex; align-items: center; gap: 8px; }
.panel-section-title::after { content: ''; flex: 1; height: 1px; background: var(--border); }

/* Category selector */
.cat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
.cat-btn {
  padding: 12px 14px; border-radius: 5px; cursor: pointer;
  border: 1px solid var(--border); background: var(--surface-2);
  text-align: left; transition: all 0.15s; display: flex; align-items: center; gap: 10px;
}
.cat-btn:hover { border-color: rgba(255,255,255,0.15); }
.cat-btn.active { border-color: var(--border-gold); background: var(--gold-dim); }
.cat-btn-icon { font-size: 18px; flex-shrink: 0; }
.cat-btn-info {}
.cat-btn-name { font-size: 11px; font-weight: 600; color: var(--cream); }
.cat-btn-desc { font-size: 9.5px; color: var(--text-dim); margin-top: 1px; }

/* NLP input */
.nlp-input-wrap { position: relative; }
.nlp-input {
  width: 100%; background: var(--surface-2); border: 1px solid var(--border);
  border-radius: 5px; padding: 12px 46px 12px 14px; color: var(--cream);
  font-family: 'Syne', sans-serif; font-size: 13px; outline: none;
  transition: border-color 0.2s; resize: none; height: 80px; line-height: 1.5;
}
.nlp-input:focus { border-color: var(--gold); }
.nlp-input::placeholder { color: var(--text-dim); font-size: 12px; }
.nlp-send-btn {
  position: absolute; right: 10px; bottom: 10px; width: 28px; height: 28px;
  background: var(--gold); border-radius: 3px; border: none; cursor: pointer;
  display: flex; align-items: center; justify-content: center;
  font-size: 13px; transition: all 0.15s; color: var(--bg);
}
.nlp-send-btn:hover { background: var(--gold-bright); }

.nlp-suggestions { margin-top: 10px; display: flex; flex-direction: column; gap: 5px; }
.nlp-suggestion {
  padding: 8px 12px; border-radius: 4px; cursor: pointer;
  background: var(--surface-2); border: 1px solid var(--border);
  font-size: 11.5px; color: var(--text-mid); transition: all 0.15s; line-height: 1.4;
}
.nlp-suggestion:hover { color: var(--cream); border-color: var(--border-gold); background: var(--gold-dim); }
.nlp-suggestion::before { content: '"'; color: var(--gold); margin-right: 2px; }
.nlp-suggestion::after { content: '"'; color: var(--gold); margin-left: 2px; }

/* Active watches */
.watch-list { display: flex; flex-direction: column; gap: 7px; }
.watch-item {
  background: var(--surface-2); border: 1px solid var(--border); border-radius: 5px;
  padding: 10px 13px; display: flex; align-items: flex-start; gap: 10px; transition: all 0.2s;
}
.watch-item:hover { border-color: rgba(255,255,255,0.12); }
.watch-item-icon { font-size: 14px; margin-top: 1px; flex-shrink: 0; }
.watch-item-info { flex: 1; }
.watch-item-title { font-size: 11.5px; font-weight: 600; color: var(--cream); margin-bottom: 2px; }
.watch-item-meta { font-family: 'JetBrains Mono', monospace; font-size: 8px; color: var(--text-dim); letter-spacing: 0.04em; }
.watch-item-freq {
  font-family: 'JetBrains Mono', monospace; font-size: 7.5px; letter-spacing: 0.08em;
  padding: 2px 7px; border-radius: 2px; background: var(--gold-dim); color: var(--gold);
  border: 1px solid var(--border-gold); white-space: nowrap; margin-top: 4px; display: inline-block;
}
.watch-remove { width: 20px; height: 20px; border-radius: 3px; background: none; border: 1px solid var(--border); display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 10px; color: var(--text-dim); transition: all 0.15s; flex-shrink: 0; }
.watch-remove:hover { border-color: var(--red); color: var(--red); background: var(--red-dim); }

/* area/zip input */
.panel-row { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 10px; }
.panel-input {
  width: 100%; background: var(--surface-2); border: 1px solid var(--border); border-radius: 4px;
  padding: 9px 12px; color: var(--cream); font-family: 'Syne', sans-serif; font-size: 12px; outline: none; transition: border-color 0.2s;
}
.panel-input:focus { border-color: var(--gold); }
.panel-input::placeholder { color: var(--text-dim); font-size: 11px; }
.panel-label { font-family: 'JetBrains Mono', monospace; font-size: 8px; letter-spacing: 0.15em; text-transform: uppercase; color: var(--text-dim); margin-bottom: 5px; display: block; }

.panel-add-btn {
  width: 100%; padding: 11px; background: var(--gold); color: var(--bg);
  font-family: 'Syne', sans-serif; font-size: 12px; font-weight: 600;
  border: none; border-radius: 4px; cursor: pointer; transition: all 0.2s; margin-top: 4px;
}
.panel-add-btn:hover { background: var(--gold-bright); }

/* Frequency selector */
.freq-row { display: flex; gap: 6px; }
.freq-btn {
  flex: 1; padding: 7px 5px; border-radius: 4px; cursor: pointer; text-align: center;
  border: 1px solid var(--border); background: var(--surface-2);
  font-family: 'JetBrains Mono', monospace; font-size: 8px; letter-spacing: 0.1em;
  text-transform: uppercase; color: var(--text-dim); transition: all 0.15s;
}
.freq-btn:hover { color: var(--text); border-color: rgba(255,255,255,0.15); }
.freq-btn.active { border-color: var(--border-gold); background: var(--gold-dim); color: var(--gold); }

/* Success toast */
.toast {
  position: fixed; bottom: 24px; right: 24px; z-index: 900;
  background: var(--surface); border: 1px solid var(--green);
  border-radius: 6px; padding: 13px 18px; display: flex; align-items: center; gap: 10px;
  box-shadow: 0 10px 40px rgba(0,0,0,0.4);
  transform: translateY(80px); opacity: 0; transition: all 0.35s cubic-bezier(0.34,1.56,0.64,1);
}
.toast.show { transform: translateY(0); opacity: 1; }
.toast-icon { font-size: 16px; }
.toast-text { font-size: 12px; color: var(--cream); }
.toast-text strong { color: var(--green); }

/* Animations */
@keyframes fadeSlideUp { from { opacity:0; transform:translateY(14px); } to { opacity:1; transform:translateY(0); } }
.card, .kpi-card { animation: fadeSlideUp 0.5s ease-out both; }
.kpi-card:nth-child(1) { animation-delay: 0.05s; }
.kpi-card:nth-child(2) { animation-delay: 0.10s; }
.kpi-card:nth-child(3) { animation-delay: 0.15s; }
.kpi-card:nth-child(4) { animation-delay: 0.20s; }
.kpi-card:nth-child(5) { animation-delay: 0.25s; }
.kpi-card:nth-child(6) { animation-delay: 0.30s; }

::-webkit-scrollbar { width: 3px; height: 3px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: var(--surface-3); border-radius: 2px; }

/* ‚îÄ‚îÄ HAMBURGER MENU ‚îÄ‚îÄ */
.sidebar-toggle {
  display: none;
  flex-direction: column;
  background: none;
  border: none;
  cursor: pointer;
  gap: 4px;
  padding: 8px;
  position: fixed;
  top: 8px;
  left: 8px;
  z-index: 102;
}

.sidebar-toggle span {
  width: 20px;
  height: 2px;
  background: var(--cream);
  border-radius: 1px;
  transition: all 0.3s ease;
}

.sidebar-toggle.active span:nth-child(1) {
  transform: rotate(45deg) translateY(9px);
}

.sidebar-toggle.active span:nth-child(2) {
  opacity: 0;
}

.sidebar-toggle.active span:nth-child(3) {
  transform: rotate(-45deg) translateY(-9px);
}

/* ‚îÄ‚îÄ RESPONSIVE DASHBOARD ‚îÄ‚îÄ */
@media (max-width: 1200px) {
  .content {
    grid-template-columns: 1fr 1fr;
    gap: 12px;
  }

  .kpi-row {
    grid-template-columns: repeat(3, 1fr);
  }

  .heatmap-card,
  .sparkline-row,
  .pipeline-card {
    grid-column: 1 / -1;
  }

  .sparkline-row {
    grid-template-columns: 1fr 1fr;
  }

  .agents-card {
    grid-column: auto;
  }

  .alerts-card {
    grid-column: 1 / -1;
    grid-row: auto;
  }

  .alerts-body {
    max-height: 300px;
  }

  #intel-panel {
    width: 360px;
  }
}

@media (max-width: 900px) {
  body {
    flex-direction: column;
  }

  .sidebar {
    position: fixed;
    left: 0;
    top: 0;
    height: 100%;
    width: 220px;
    z-index: 99;
    transform: translateX(-100%);
    transition: transform 0.3s ease;
    box-shadow: 2px 0 16px rgba(0, 0, 0, 0.3);
  }

  .sidebar.active {
    transform: translateX(0);
  }

  .sidebar-toggle {
    display: flex;
  }

  .main {
    flex: 1;
    width: 100%;
  }

  .content {
    grid-template-columns: 1fr;
    gap: 12px;
  }

  .kpi-row {
    grid-template-columns: repeat(2, 1fr);
  }

  .heatmap-card,
  .sparkline-row,
  .pipeline-card,
  .agents-card,
  .alerts-card {
    grid-column: 1 / -1;
    grid-row: auto;
  }

  .sparkline-row {
    grid-template-columns: 1fr;
  }

  .alerts-body {
    max-height: 300px;
  }

  .cat-grid {
    grid-template-columns: 1fr;
  }

  #intel-panel {
    width: 100%;
  }

  .pipeline-body {
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
  }

  .pipeline-table {
    min-width: 700px;
  }

  .onboarding-modal {
    width: 95vw;
    max-width: 95vw;
  }

  .ob-features {
    grid-template-columns: 1fr;
  }

  .ob-agent-grid {
    grid-template-columns: 1fr;
  }

  .topbar {
    height: auto;
    flex-wrap: wrap;
    gap: 12px;
    padding: 12px 16px;
  }

  .topbar-title {
    font-size: 16px;
  }

  .topbar-right {
    width: 100%;
    margin-left: 0;
  }

  html, body {
    height: auto;
    overflow: auto;
  }

  body {
    height: auto;
    min-height: 100vh;
  }

  .main {
    overflow: visible;
    height: auto;
  }

  .content {
    overflow: visible;
    height: auto;
  }
}

@media (max-width: 600px) {
  .sidebar-toggle {
    top: 12px;
    left: 12px;
  }

  .sidebar {
    width: 100%;
  }

  .content {
    grid-template-columns: 1fr;
    padding: 12px 16px 16px;
    gap: 10px;
  }

  .kpi-row {
    grid-template-columns: repeat(2, 1fr);
    gap: 10px;
  }

  .kpi-label {
    font-size: 6px;
  }

  .kpi-value {
    font-size: 24px;
  }

  .card {
    border-radius: 4px;
  }

  .card-header {
    padding: 10px 12px 0;
  }

  .card-title {
    font-size: 8px;
  }

  .topbar {
    padding: 10px 12px;
    height: auto;
  }

  .topbar-title {
    font-size: 14px;
  }

  .topbar-date {
    font-size: 8px;
  }

  .topbar-right {
    flex-direction: column;
    width: 100%;
  }

  .add-intel-btn {
    font-size: 11px;
    padding: 6px 12px;
    width: 100%;
    justify-content: center;
  }

  .ob-modal {
    width: 95vw;
    max-width: 95vw;
  }

  .heatmap-grid {
    grid-template-columns: repeat(3, 1fr);
  }

  .ob-body {
    padding: 20px 16px;
  }

  .ob-header {
    padding: 20px 16px 0;
  }

  .ob-footer {
    padding: 16px;
  }

  .ob-progress {
    margin: 16px 16px 0;
  }

  .panel-header {
    padding: 16px 16px 14px;
  }

  .panel-body {
    padding: 16px;
  }
}
</style>
</head>
<body>

<!-- Sidebar Toggle Button -->
<button class="sidebar-toggle" id="sidebar-toggle" aria-label="Toggle sidebar">
  <span></span>
  <span></span>
  <span></span>
</button>

<!-- ‚ïê‚ïê ONBOARDING OVERLAY ‚ïê‚ïê -->
<div id="onboarding-overlay">
  <div class="onboarding-modal" id="ob-modal">
    <div class="ob-header">
      <div>
        <div class="ob-logo">Land<span>Marq</span></div>
        <div class="ob-step-counter" id="ob-counter">Step 1 of 5</div>
      </div>
    </div>
    <div class="ob-progress"><div class="ob-progress-fill" id="ob-progress" style="width:20%"></div></div>

    <div class="ob-body">

      <!-- STEP 1: Welcome -->
      <div class="ob-step active" id="ob-step-1">
        <span class="ob-step-icon">üèõÔ∏è</span>
        <div class="ob-step-title">Welcome to <em>LandMarq</em></div>
        <div class="ob-step-desc">Your personal AI intelligence platform for commercial real estate. LandMarq deploys a fleet of specialized agents that monitor markets, surface leads, and flag opportunities ‚Äî all delivered to a single executive dashboard, every morning.</div>
        <div class="ob-features">
          <div class="ob-feature"><div class="ob-feature-icon">üåê</div><div class="ob-feature-text"><strong>Market Intelligence</strong>Submarket vacancy, rents, permit filings, competitor moves.</div></div>
          <div class="ob-feature"><div class="ob-feature-icon">üéØ</div><div class="ob-feature-text"><strong>Tenant Lead Engine</strong>LLC filings, job postings, lease expirations ‚Äî found before the RFP.</div></div>
          <div class="ob-feature"><div class="ob-feature-icon">üìã</div><div class="ob-feature-text"><strong>Document Review</strong>LOI clause flagging, NDA drafting, vs. your gold standard template.</div></div>
          <div class="ob-feature"><div class="ob-feature-icon">üì°</div><div class="ob-feature-text"><strong>Zoning & Permits</strong>Real-time government portal monitoring across all your markets.</div></div>
        </div>
      </div>

      <!-- STEP 2: Profile Setup -->
      <div class="ob-step" id="ob-step-2">
        <span class="ob-step-icon">üë§</span>
        <div class="ob-step-title">Set up your <em>profile</em></div>
        <div class="ob-step-desc">This helps LandMarq personalize your briefings and filter intelligence to what's relevant to your role and focus areas.</div>
        <div class="ob-input-group">
          <label class="ob-label">Your Name</label>
          <input class="ob-input" id="ob-name" type="text" placeholder="e.g. Mark Sullivan" />
        </div>
        <div class="ob-input-group">
          <label class="ob-label">Firm</label>
          <input class="ob-input" type="text" placeholder="e.g. Savills North America" />
        </div>
        <div class="ob-input-group">
          <label class="ob-label">Your Role / Focus</label>
          <div style="display:flex;gap:8px;">
            <input class="ob-input" type="text" placeholder="Title" style="flex:1" />
            <input class="ob-input" type="text" placeholder="Specialty" style="flex:1" />
          </div>
        </div>
      </div>

      <!-- STEP 3: Markets -->
      <div class="ob-step" id="ob-step-3">
        <span class="ob-step-icon">üìç</span>
        <div class="ob-step-title">Choose your <em>markets</em></div>
        <div class="ob-step-desc">Select the submarkets you want LandMarq to monitor. You can add zip codes and area codes, or pick from major metros. You can always change these later.</div>
        <div class="ob-chips-row" id="market-chips">
          <div class="ob-chip selected" onclick="toggleChip(this)">Los Angeles</div>
          <div class="ob-chip selected" onclick="toggleChip(this)">Santa Monica</div>
          <div class="ob-chip selected" onclick="toggleChip(this)">Culver City</div>
          <div class="ob-chip selected" onclick="toggleChip(this)">Century City</div>
          <div class="ob-chip" onclick="toggleChip(this)">San Francisco</div>
          <div class="ob-chip" onclick="toggleChip(this)">Seattle</div>
          <div class="ob-chip selected" onclick="toggleChip(this)">Playa Vista</div>
          <div class="ob-chip" onclick="toggleChip(this)">Burbank</div>
          <div class="ob-chip" onclick="toggleChip(this)">El Segundo</div>
          <div class="ob-chip" onclick="toggleChip(this)">Manhattan Beach</div>
          <div class="ob-chip" onclick="toggleChip(this)">West Hollywood</div>
          <div class="ob-chip" onclick="toggleChip(this)">DTLA</div>
        </div>
        <div style="margin-top:14px;">
          <label class="ob-label">Or add a specific ZIP / Area Code</label>
          <div style="display:flex;gap:8px;">
            <input class="ob-input" id="market-zip-input" type="text" placeholder="e.g. 90401, Phoenix, 90064..." style="flex:1;" onkeydown="if(event.key==='Enter'){addMarketChip();}" />
            <button onclick="addMarketChip()" style="background:var(--gold);color:var(--bg);border:none;border-radius:4px;padding:0 16px;font-family:'Syne',sans-serif;font-size:12px;font-weight:600;cursor:pointer;">Add</button>
          </div>
        </div>
      </div>

      <!-- STEP 4: Agents -->
      <div class="ob-step" id="ob-step-4">
        <span class="ob-step-icon">‚öôÔ∏è</span>
        <div class="ob-step-title">Activate your <em>agents</em></div>
        <div class="ob-step-desc">Each agent runs continuously in the background. Toggle on the ones relevant to your day-to-day. You can adjust anytime.</div>
        <div class="ob-agent-grid">
          <div class="ob-agent-toggle on" onclick="this.classList.toggle('on')">
            <div class="toggle-icon">üåê</div>
            <div class="toggle-info"><div class="toggle-name">Market Intel</div><div class="toggle-desc">Vacancy, rents, comps</div></div>
            <div class="toggle-dot"></div>
          </div>
          <div class="ob-agent-toggle on" onclick="this.classList.toggle('on')">
            <div class="toggle-icon">üéØ</div>
            <div class="toggle-info"><div class="toggle-name">Lead Finder</div><div class="toggle-desc">Tenant expansion signals</div></div>
            <div class="toggle-dot"></div>
          </div>
          <div class="ob-agent-toggle on" onclick="this.classList.toggle('on')">
            <div class="toggle-icon">üìã</div>
            <div class="toggle-info"><div class="toggle-name">LOI Review</div><div class="toggle-desc">Clause flagging</div></div>
            <div class="toggle-dot"></div>
          </div>
          <div class="ob-agent-toggle" onclick="this.classList.toggle('on')">
            <div class="toggle-icon">‚úâÔ∏è</div>
            <div class="toggle-info"><div class="toggle-name">Outreach</div><div class="toggle-desc">Personalized pitches</div></div>
            <div class="toggle-dot"></div>
          </div>
          <div class="ob-agent-toggle on" onclick="this.classList.toggle('on')">
            <div class="toggle-icon">üì°</div>
            <div class="toggle-info"><div class="toggle-name">Zoning Monitor</div><div class="toggle-desc">Permits & variances</div></div>
            <div class="toggle-dot"></div>
          </div>
          <div class="ob-agent-toggle" onclick="this.classList.toggle('on')">
            <div class="toggle-icon">üèõÔ∏è</div>
            <div class="toggle-info"><div class="toggle-name">Portfolio Analyst</div><div class="toggle-desc">Hold vs. sell analysis</div></div>
            <div class="toggle-dot"></div>
          </div>
        </div>
      </div>

      <!-- STEP 5: Ready -->
      <div class="ob-step" id="ob-step-5">
        <span class="ob-step-icon" style="font-size:42px;display:inline-flex;align-items:center;justify-content:center;width:56px;height:56px;border-radius:50%;background:linear-gradient(135deg,var(--gold),#B08A3E);color:#0A0C0E;font-family:'Syne',sans-serif;font-weight:700;line-height:1;">
          <svg width="26" height="26" viewBox="0 0 24 24" fill="none" stroke="#0A0C0E" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>
        </span>
        <div class="ob-step-title">You're all set<em id="welcome-name"></em>.</div>
        <div class="ob-step-desc">Your agents are now running across your selected markets. Your first morning brief will be ready within minutes. As you use the dashboard, click <strong style="color:var(--gold);">+ Add Intelligence</strong> anytime to configure new watches ‚Äî just tell us in plain English what you want to track.</div>
        <div class="ob-features">
          <div class="ob-feature"><div class="ob-feature-icon">üí¨</div><div class="ob-feature-text"><strong>Natural Language</strong>"Show me CRE growth projections in 310 area for tech tenants" ‚Äî just type it.</div></div>
          <div class="ob-feature"><div class="ob-feature-icon">üîî</div><div class="ob-feature-text"><strong>Custom Alerts</strong>Set thresholds for vacancy %, interest rate changes, specific submarkets.</div></div>
          <div class="ob-feature"><div class="ob-feature-icon">üìä</div><div class="ob-feature-text"><strong>Daily Brief</strong>Curated to your markets and role. Delivered 6 AM sharp.</div></div>
          <div class="ob-feature"><div class="ob-feature-icon">üîç</div><div class="ob-feature-text"><strong>Guided Tour</strong>After this, we'll highlight each part of your dashboard.</div></div>
        </div>
      </div>

    </div>

    <div class="ob-footer">
      <button class="ob-btn-skip" onclick="skipOnboarding()">Skip Tour</button>
      <button class="ob-btn-next" id="ob-next-btn" onclick="nextStep()">
        <span id="ob-btn-label">Get Started</span> ‚Üí
      </button>
    </div>
  </div>
</div>

<!-- SPOTLIGHT RING -->
<div class="spotlight-ring" id="spotlight-ring"></div>

<!-- SPOTLIGHT TOOLTIP -->
<div class="spotlight-tooltip" id="spotlight-tooltip">
  <div class="tooltip-step" id="tt-step">Tour ¬∑ 1 of 5</div>
  <div class="tooltip-title" id="tt-title">Title</div>
  <div class="tooltip-desc" id="tt-desc">Description</div>
  <div class="tooltip-nav">
    <div class="tooltip-close" onclick="endTour()">End Tour</div>
    <button class="tooltip-nav-btn" id="tt-next-btn" onclick="nextTourStep()">Next ‚Üí</button>
  </div>
</div>

<!-- ‚ïê‚ïê SIDEBAR ‚ïê‚ïê -->
<div class="sidebar" id="sidebar">
  <div class="sidebar-logo">
    <div class="logo-wordmark"><span class="lm-land">Land</span><span class="lm-marq">Marq</span></div>
    <div class="logo-sub">Executive Intelligence ¬∑ ai</div>
  </div>

  <div class="user-card" id="nav-profile">
    <div class="user-avatar">‚Äî</div>
    <div>
      <div class="user-name">Your Profile</div>
      <div class="user-title">Complete onboarding to set up</div>
    </div>
  </div>

  <div class="nav-section">
    <div class="nav-label">Workspace</div>
    <div class="nav-item active" id="nav-brief">
      <span class="nav-icon">‚óà</span> Morning Brief
    </div>
    <div class="nav-item" id="nav-agents">
      <span class="nav-icon">‚¨°</span> Agent Fleet
      <span class="nav-badge green">6</span>
    </div>
    <div class="nav-item" id="nav-pipeline">
      <span class="nav-icon">‚óé</span> Deal Pipeline
      <span class="nav-badge gold">14</span>
    </div>
    <div class="nav-item">
      <span class="nav-icon">‚ñ≥</span> Market Intel
    </div>
    <div class="nav-item" id="nav-leads">
      <span class="nav-icon">‚óª</span> Tenant Leads
      <span class="nav-badge">3</span>
    </div>
  </div>

  <div class="nav-section">
    <div class="nav-label">Reports</div>
    <div class="nav-item"><span class="nav-icon">‚â°</span> West Coast Markets</div>
    <div class="nav-item"><span class="nav-icon">‚ó∑</span> Submarket Tracker</div>
    <div class="nav-item"><span class="nav-icon">‚äï</span> Portfolio Analysis</div>
  </div>

  <div class="nav-section">
    <div class="nav-label">Settings</div>
    <div class="nav-item"><span class="nav-icon">‚öô</span> Preferences</div>
    <div class="nav-item"><span class="nav-icon">‚ó∑</span> Brief Schedule</div>
    <div class="nav-item" onclick="LandMarqAuth.signOut()" style="cursor:pointer;color:var(--text-dim);">
      <span class="nav-icon">‚Ü©</span> Sign Out
    </div>
  </div>

  <div class="sidebar-footer">
    <div class="status-indicator"><div class="pulse-dot"></div><div class="status-text">6 agents active</div></div>
  </div>
</div>

<!-- ‚ïê‚ïê MAIN ‚ïê‚ïê -->
<div class="main">
  <div class="topbar" id="topbar">
    <div class="topbar-title">Morning Brief</div>
    <div class="topbar-date" id="topbar-date"></div>
    <div class="topbar-right">
      <div class="topbar-chip"><div class="pulse-dot" style="background:var(--gold);animation:pulseGold 2s ease-in-out infinite;width:6px;height:6px;border-radius:50%;"></div>&nbsp;Agents Running</div>
      <button class="add-intel-btn" id="add-intel-btn" onclick="openIntelPanel()">+ Add Intelligence</button>
      <div class="icon-btn" id="topbar-bell" onclick="showNotificationsPanel()" style="cursor:pointer;" title="Notifications">üîî</div>
      <div class="icon-btn" id="topbar-gear" onclick="switchView('preferences')" style="cursor:pointer;" title="Settings">‚öô</div>
    </div>
  </div>

  <div class="content">

    <!-- KPI ROW -->
    <div class="kpi-row" id="kpi-row">
      <div class="kpi-card"><div class="kpi-label">Total Pipeline Value</div><div class="kpi-value gold">$218M</div><div class="kpi-delta delta-up">‚ñ≤ 12.4% <span class="kpi-sub">vs last quarter</span></div></div>
      <div class="kpi-card"><div class="kpi-label">Active Deals</div><div class="kpi-value">14</div><div class="kpi-delta delta-up">‚ñ≤ 3 <span class="kpi-sub">this month</span></div></div>
      <div class="kpi-card"><div class="kpi-label">Avg. LA Office Vacancy</div><div class="kpi-value">14.2%</div><div class="kpi-delta delta-down">‚ñº 0.8% <span class="kpi-sub">90-day trend</span></div></div>
      <div class="kpi-card"><div class="kpi-label">Agent-Sourced Leads (30d)</div><div class="kpi-value">31</div><div class="kpi-delta delta-up">‚ñ≤ 8 <span class="kpi-sub">this month</span></div></div>
      <div class="kpi-card"><div class="kpi-label">Avg. NNN PSF ¬∑ SF</div><div class="kpi-value">$62</div><div class="kpi-delta delta-up">‚ñ≤ $1.20 <span class="kpi-sub">MoM</span></div></div>
      <div class="kpi-card"><div class="kpi-label">Unread Alerts</div><div class="kpi-value">7</div><div class="kpi-delta delta-neutral">‚¨§ <span class="kpi-sub">3 high priority</span></div></div>
    </div>

    <!-- HEATMAP -->
    <div class="card heatmap-card" id="heatmap-card">
      <div class="card-header"><div class="card-title">Submarket Pulse</div><div class="card-action" id="heatmap-full-map">Full Map ‚Üí</div></div>
      <div class="heatmap-tabs" id="heatmap-tabs">
        <div class="heatmap-tab active" onclick="switchHeatmapRegion('west-coast',this)">West Coast</div>
        <div class="heatmap-tab" onclick="switchHeatmapRegion('southwest',this)">Southwest</div>
        <div class="heatmap-tab" onclick="switchHeatmapRegion('northwest',this)">Northwest</div>
        <div class="heatmap-tab" onclick="switchHeatmapRegion('mountain',this)">Mountain</div>
        <div class="heatmap-tab" onclick="switchHeatmapRegion('national',this)">National</div>
      </div>
      <div class="heatmap-body">
        <div class="heatmap-grid" id="heatmap-grid">
          <div class="heatmap-cell" style="background:rgba(192,83,58,0.55)"><div class="heat-market">DTLA</div><div class="heat-val">18.4%</div></div>
          <div class="heatmap-cell" style="background:rgba(196,158,84,0.45)"><div class="heat-market">Culver City</div><div class="heat-val">11.2%</div></div>
          <div class="heatmap-cell" style="background:rgba(74,127,165,0.5)"><div class="heat-market">Santa Monica</div><div class="heat-val">9.8%</div></div>
          <div class="heatmap-cell" style="background:rgba(74,127,165,0.35)"><div class="heat-market">Playa Vista</div><div class="heat-val">8.1%</div></div>
          <div class="heatmap-cell" style="background:rgba(74,155,111,0.45)"><div class="heat-market">El Segundo</div><div class="heat-val">6.7%</div></div>
          <div class="heatmap-cell" style="background:rgba(196,158,84,0.35)"><div class="heat-market">Century City</div><div class="heat-val">12.6%</div></div>
          <div class="heatmap-cell" style="background:rgba(74,155,111,0.35)"><div class="heat-market">West Hollywood</div><div class="heat-val">7.3%</div></div>
          <div class="heatmap-cell" style="background:rgba(192,83,58,0.4)"><div class="heat-market">Wilshire Corridor</div><div class="heat-val">16.1%</div></div>
          <div class="heatmap-cell" style="background:rgba(74,127,165,0.42)"><div class="heat-market">Burbank</div><div class="heat-val">10.4%</div></div>
          <div class="heatmap-cell" style="background:rgba(74,155,111,0.5)"><div class="heat-market">Manhattan Bch</div><div class="heat-val">5.9%</div></div>
          <div class="heatmap-cell" style="background:rgba(192,83,58,0.65)"><div class="heat-market">SF Financial</div><div class="heat-val">26.3%</div></div>
          <div class="heatmap-cell" style="background:rgba(192,83,58,0.45)"><div class="heat-market">SF SOMA</div><div class="heat-val">22.1%</div></div>
          <div class="heatmap-cell" style="background:rgba(74,127,165,0.4)"><div class="heat-market">SF Mission</div><div class="heat-val">14.8%</div></div>
          <div class="heatmap-cell" style="background:rgba(74,155,111,0.45)"><div class="heat-market">Bellevue WA</div><div class="heat-val">9.2%</div></div>
          <div class="heatmap-cell" style="background:rgba(74,127,165,0.38)"><div class="heat-market">Seattle SLU</div><div class="heat-val">11.0%</div></div>
        </div>
        <div style="display:flex;gap:16px;align-items:center;margin-top:9px;">
          <div style="font-family:'JetBrains Mono',monospace;font-size:7px;color:var(--text-dim);letter-spacing:0.12em;">VACANCY:</div>
          <div style="display:flex;gap:12px;">
            <div style="display:flex;gap:5px;align-items:center;"><div style="width:20px;height:5px;border-radius:1px;background:rgba(74,155,111,0.5)"></div><span style="font-family:'JetBrains Mono',monospace;font-size:7px;color:var(--text-dim)">&lt;10%</span></div>
            <div style="display:flex;gap:5px;align-items:center;"><div style="width:20px;height:5px;border-radius:1px;background:rgba(74,127,165,0.5)"></div><span style="font-family:'JetBrains Mono',monospace;font-size:7px;color:var(--text-dim)">10‚Äì15%</span></div>
            <div style="display:flex;gap:5px;align-items:center;"><div style="width:20px;height:5px;border-radius:1px;background:rgba(196,158,84,0.5)"></div><span style="font-family:'JetBrains Mono',monospace;font-size:7px;color:var(--text-dim)">15‚Äì20%</span></div>
            <div style="display:flex;gap:5px;align-items:center;"><div style="width:20px;height:5px;border-radius:1px;background:rgba(192,83,58,0.6)"></div><span style="font-family:'JetBrains Mono',monospace;font-size:7px;color:var(--text-dim)">&gt;20%</span></div>
          </div>
        </div>
      </div>
    </div>

    <!-- AGENT FEED -->
    <div class="card agents-card" id="agent-card">
      <div class="card-header"><div class="card-title">Live Agent Feed</div><div class="card-action" onclick="switchView('agent-fleet')">Full Activity Log ‚Üí</div></div>
      <div class="agent-stream" id="agentStream">
        <div class="stream-item"><div class="stream-icon icon-alert">‚ö°</div><div><div class="stream-text"><strong>Snap Inc.</strong> vacating 42K SF at 2101 Colorado Ave SM ‚Äî 3 tenants circling.</div><div class="stream-meta"><span class="stream-tag tag-alert">High Priority</span> 2 min ago ¬∑ Intel Agent</div></div></div>
        <div class="stream-item"><div class="stream-icon icon-lead">üéØ</div><div><div class="stream-text"><strong>TechCo Inc.</strong> (Series C) posted 40+ LA jobs. Office expansion signal.</div><div class="stream-meta"><span class="stream-tag tag-lead">New Lead</span> 14 min ago ¬∑ Lead Agent</div></div></div>
        <div class="stream-item"><div class="stream-icon icon-doc">üìã</div><div><div class="stream-text"><strong>LOI Agent</strong> flagged non-standard exclusivity clause ‚Äî Apex Capital draft.</div><div class="stream-meta"><span class="stream-tag tag-doc">Document</span> 31 min ago ¬∑ LOI Agent</div></div></div>
        <div class="stream-item"><div class="stream-icon icon-intel">üîç</div><div><div class="stream-text">Zoning variance filed for <strong>1150 S Olive St</strong> ‚Äî mixed-use conversion.</div><div class="stream-meta"><span class="stream-tag tag-intel">Zoning</span> 1 hr ago ¬∑ Permit Agent</div></div></div>
        <div class="stream-item"><div class="stream-icon icon-lead">‚úâÔ∏è</div><div><div class="stream-text"><strong>Outreach Agent</strong> drafting personalized pitch for Netflix HQ expansion&nbsp;<span class="typing-dot"></span><span class="typing-dot"></span><span class="typing-dot"></span></div><div class="stream-meta"><span class="stream-tag tag-lead">In Progress</span> now ¬∑ Outreach Agent</div></div></div>
      </div>
      <!-- AI Bot Chat -->
      <div id="agent-chat" style="border-top:1px solid var(--border);padding:10px 16px 12px;">
        <div id="agent-chat-messages" style="max-height:140px;overflow-y:auto;margin-bottom:8px;display:none;"></div>
        <div style="display:flex;gap:8px;align-items:center;">
          <input id="agent-chat-input" type="text" placeholder="Ask your agents anything... e.g. 'What's the latest on Snap vacancy?'" style="flex:1;padding:10px 14px;background:var(--surface-2);border:1px solid var(--border);border-radius:6px;color:var(--cream);font-family:'Syne',sans-serif;font-size:12px;outline:none;" onkeydown="if(event.key==='Enter')sendAgentChat()" />
          <button onclick="sendAgentChat()" style="padding:10px 16px;background:var(--gold);color:#0A0C0E;border:none;border-radius:6px;font-weight:700;font-family:'Syne',sans-serif;font-size:12px;cursor:pointer;white-space:nowrap;">Ask ‚Üí</button>
        </div>
      </div>
    </div>

    <!-- ALERTS (right column spans rows) -->
    <div class="card alerts-card" id="alerts-card">
      <div class="card-header"><div class="card-title">Priority Alerts</div><div class="card-action">Mark All Read</div></div>
      <div class="alerts-body">
        <div class="alert-item alert-high"><div class="alert-priority">‚óè High Priority</div><div class="alert-title">Snap vacating 42K SF ‚Äî Santa Monica</div><div class="alert-body">Lease expires Q2. 3 TAMI tenants in same submarket searching. First-mover window: ~6 weeks.</div><div class="alert-footer"><div class="alert-agent">Intel Agent</div><div class="alert-time">2m ago</div></div><div class="alert-action-btn">Draft Outreach ‚Üí</div></div>
        <div class="alert-item alert-high"><div class="alert-priority">‚óè High Priority</div><div class="alert-title">LOI Clause Mismatch ‚Äî Apex Capital</div><div class="alert-body">Non-standard "co-tenancy" clause on Sections 4.2 & 7. Differs from Savills gold template.</div><div class="alert-footer"><div class="alert-agent">LOI Agent</div><div class="alert-time">31m ago</div></div><div class="alert-action-btn">Review Comparison ‚Üí</div></div>
        <div class="alert-item alert-med"><div class="alert-priority">‚óÜ Medium</div><div class="alert-title">TechCo Inc. Expansion Signal</div><div class="alert-body">40+ LA job postings. Badge-in at current WeWork up 62%. Likely seeking 15‚Äì25K SF.</div><div class="alert-footer"><div class="alert-agent">Lead Agent</div><div class="alert-time">14m ago</div></div><div class="alert-action-btn">View Lead Profile ‚Üí</div></div>
        <div class="alert-item alert-med"><div class="alert-priority">‚óÜ Medium</div><div class="alert-title">Interest Rate Watch Triggered</div><div class="alert-body">Fed signals pause. Model projects cap rate compression in industrial by 25bps over 90 days.</div><div class="alert-footer"><div class="alert-agent">Macro Agent</div><div class="alert-time">1h ago</div></div><div class="alert-action-btn">View Impact Report ‚Üí</div></div>
        <div class="alert-item alert-low"><div class="alert-priority">‚ñ∏ Intel Update</div><div class="alert-title">Playa Vista Occupancy Up</div><div class="alert-body">Badge-in data: Playa Vista 74% vs. 61% DTLA avg. Tenant preference shifting toward submarket.</div><div class="alert-footer"><div class="alert-agent">Intel Agent</div><div class="alert-time">4h ago</div></div><div class="alert-action-btn">View Submarket Data ‚Üí</div></div>
        <div class="alert-item alert-low"><div class="alert-priority">‚ñ∏ Intel Update</div><div class="alert-title">CBRE Deal Closed ‚Äî Water Garden</div><div class="alert-body">18,500 SF closed. 3 remaining comparable availabilities in SM. Market tightening.</div><div class="alert-footer"><div class="alert-agent">Intel Agent</div><div class="alert-time">2h ago</div></div><div class="alert-action-btn">Update Comp Set ‚Üí</div></div>
      </div>
    </div>

    <!-- SPARKLINES -->
    <div class="sparkline-row">
      <div class="card spark-card" id="spark-deal-value">
        <div class="card-header"><div class="card-title">Deal Value ¬∑ Q1 2026</div><div class="card-action" style="font-size:8px;cursor:pointer;" onclick="showSparkDataModal('deal-value')">Edit Data ‚úé</div></div>
        <div class="spark-body"><div class="spark-stat"><div class="spark-big" id="spark-deal-big">$218M</div><div class="spark-delta delta-up" id="spark-deal-delta">‚ñ≤ 12.4%</div></div><div class="spark-main" id="spark-deal-bars"><div class="spark-bar gold-bar" data-val="98" data-label="Mar '25" style="height:45%"></div><div class="spark-bar gold-bar" data-val="131" data-label="Apr '25" style="height:60%"></div><div class="spark-bar gold-bar" data-val="109" data-label="May '25" style="height:50%"></div><div class="spark-bar gold-bar" data-val="153" data-label="Jun '25" style="height:70%"></div><div class="spark-bar gold-bar" data-val="120" data-label="Jul '25" style="height:55%"></div><div class="spark-bar gold-bar" data-val="175" data-label="Aug '25" style="height:80%"></div><div class="spark-bar gold-bar" data-val="142" data-label="Sep '25" style="height:65%"></div><div class="spark-bar gold-bar" data-val="192" data-label="Oct '25" style="height:88%"></div><div class="spark-bar gold-bar" data-val="157" data-label="Nov '25" style="height:72%"></div><div class="spark-bar gold-bar" data-val="197" data-label="Dec '25" style="height:90%"></div><div class="spark-bar gold-bar" data-val="184" data-label="Jan '26" style="height:84%"></div><div class="spark-bar gold-bar current" data-val="218" data-label="Feb '26" style="height:100%"></div></div><div class="spark-labels"><span class="spark-label">Mar '25</span><span class="spark-label">Aug '25</span><span class="spark-label">Feb '26</span></div></div>
      </div>
      <div class="card spark-card" id="spark-leads">
        <div class="card-header"><div class="card-title">Agent-Sourced Leads ¬∑ 12mo</div><div class="card-action" style="font-size:8px;cursor:pointer;" onclick="showSparkDataModal('leads')">Edit Data ‚úé</div></div>
        <div class="spark-body"><div class="spark-stat"><div class="spark-big" id="spark-leads-big">31</div><div class="spark-delta delta-up" id="spark-leads-delta">‚ñ≤ 8 this month</div></div><div class="spark-main" id="spark-leads-bars"><div class="spark-bar green-bar" data-val="9" data-label="Mar '25" style="height:30%"></div><div class="spark-bar green-bar" data-val="12" data-label="Apr '25" style="height:40%"></div><div class="spark-bar green-bar" data-val="11" data-label="May '25" style="height:35%"></div><div class="spark-bar green-bar" data-val="17" data-label="Jun '25" style="height:55%"></div><div class="spark-bar green-bar" data-val="15" data-label="Jul '25" style="height:48%"></div><div class="spark-bar green-bar" data-val="19" data-label="Aug '25" style="height:62%"></div><div class="spark-bar green-bar" data-val="22" data-label="Sep '25" style="height:70%"></div><div class="spark-bar green-bar" data-val="18" data-label="Oct '25" style="height:60%"></div><div class="spark-bar green-bar" data-val="24" data-label="Nov '25" style="height:78%"></div><div class="spark-bar green-bar" data-val="26" data-label="Dec '25" style="height:85%"></div><div class="spark-bar green-bar" data-val="28" data-label="Jan '26" style="height:90%"></div><div class="spark-bar green-bar current" data-val="31" data-label="Feb '26" style="height:100%"></div></div><div class="spark-labels"><span class="spark-label">Mar '25</span><span class="spark-label">Aug '25</span><span class="spark-label">Feb '26</span></div></div>
      </div>
      <div class="card spark-card" id="spark-vacancy">
        <div class="card-header"><div class="card-title">Vacancy Rate ¬∑ LA Metro</div><div class="card-action" style="font-size:8px;cursor:pointer;" onclick="showSparkDataModal('vacancy')">Edit Data ‚úé</div></div>
        <div class="spark-body"><div class="spark-stat"><div class="spark-big" id="spark-vacancy-big">14.2%</div><div class="spark-delta delta-down" id="spark-vacancy-delta">‚ñº 0.8% (90d)</div></div><div class="spark-main" id="spark-vacancy-bars"><div class="spark-bar blue-bar" data-val="17.8" data-label="Mar '25" style="height:100%"></div><div class="spark-bar blue-bar" data-val="17.1" data-label="Apr '25" style="height:96%"></div><div class="spark-bar blue-bar" data-val="16.4" data-label="May '25" style="height:92%"></div><div class="spark-bar blue-bar" data-val="17.5" data-label="Jun '25" style="height:98%"></div><div class="spark-bar blue-bar" data-val="15.7" data-label="Jul '25" style="height:88%"></div><div class="spark-bar blue-bar" data-val="15.2" data-label="Aug '25" style="height:85%"></div><div class="spark-bar blue-bar" data-val="14.6" data-label="Sep '25" style="height:82%"></div><div class="spark-bar blue-bar" data-val="13.9" data-label="Oct '25" style="height:78%"></div><div class="spark-bar blue-bar" data-val="14.3" data-label="Nov '25" style="height:80%"></div><div class="spark-bar blue-bar" data-val="13.2" data-label="Dec '25" style="height:74%"></div><div class="spark-bar blue-bar" data-val="12.5" data-label="Jan '26" style="height:70%"></div><div class="spark-bar blue-bar current" data-val="14.2" data-label="Feb '26" style="height:66%"></div></div><div class="spark-labels"><span class="spark-label">Mar '25</span><span class="spark-label">Aug '25</span><span class="spark-label">Feb '26</span></div></div>
      </div>
    </div>

    <!-- PIPELINE TABLE -->
    <div class="card pipeline-card" id="pipeline-card">
      <div class="card-header"><div class="card-title">Active Deal Pipeline</div><div style="display:flex;gap:12px;align-items:center;"><button class="add-deal-btn" id="add-deal-btn" onclick="openAddDealModal()">+ Add Deal</button><div class="card-action" style="font-size:8px;cursor:pointer;" onclick="showPipelineImport()">Import CSV ‚Üë</div></div></div>
      <div class="pipeline-body">
        <table class="pipeline-table" id="dashboard-pipeline-table">
          <thead><tr><th>Tenant</th><th>Market</th><th>SF</th><th>Value</th><th>Stage</th><th>Probability</th><th>Close</th><th></th></tr></thead>
          <tbody id="dashboard-pipeline-tbody">
            <tr><td><div class="tenant-name">Netflix Inc.</div><div class="tenant-sub">HQ Expansion ¬∑ TAMI</div></td><td><span class="market-tag">Culver City</span></td><td><span class="size-val">~60K</span></td><td><span class="value-cell">$42M</span></td><td><span class="stage-pill stage-proposal">Proposal</span></td><td><div class="prob-bar-wrap"><div class="prob-bar-bg"><div class="prob-bar-fill green" style="width:72%"></div></div><span class="prob-val">72%</span></div></td><td style="font-family:'JetBrains Mono',monospace;font-size:8.5px;color:var(--text-mid)">Apr '26</td><td><div class="action-dots"><span></span><span></span><span></span></div></td></tr>
            <tr><td><div class="tenant-name">Apex Capital Group</div><div class="tenant-sub">Relocation ¬∑ Financial</div></td><td><span class="market-tag">Century City</span></td><td><span class="size-val">28,500</span></td><td><span class="value-cell">$19M</span></td><td><span class="stage-pill stage-loi">LOI Signed</span></td><td><div class="prob-bar-wrap"><div class="prob-bar-bg"><div class="prob-bar-fill green" style="width:88%"></div></div><span class="prob-val">88%</span></div></td><td style="font-family:'JetBrains Mono',monospace;font-size:8.5px;color:var(--text-mid)">Mar '26</td><td><div class="action-dots"><span></span><span></span><span></span></div></td></tr>
            <tr><td><div class="tenant-name">Pinnacle Studios</div><div class="tenant-sub">Expansion ¬∑ Entertainment</div></td><td><span class="market-tag">Burbank</span></td><td><span class="size-val">45K</span></td><td><span class="value-cell">$30M</span></td><td><span class="stage-pill stage-closing">Closing</span></td><td><div class="prob-bar-wrap"><div class="prob-bar-bg"><div class="prob-bar-fill green" style="width:94%"></div></div><span class="prob-val">94%</span></div></td><td style="font-family:'JetBrains Mono',monospace;font-size:8.5px;color:var(--text-mid)">Mar '26</td><td><div class="action-dots"><span></span><span></span><span></span></div></td></tr>
            <tr><td><div class="tenant-name">TechCo Inc.</div><div class="tenant-sub">New Requirement ¬∑ SaaS</div></td><td><span class="market-tag">Playa Vista</span></td><td><span class="size-val">~20K</span></td><td><span class="value-cell">$11M</span></td><td><span class="stage-pill stage-qualify">Qualifying</span></td><td><div class="prob-bar-wrap"><div class="prob-bar-bg"><div class="prob-bar-fill amber" style="width:38%"></div></div><span class="prob-val">38%</span></div></td><td style="font-family:'JetBrains Mono',monospace;font-size:8.5px;color:var(--text-mid)">Q3 '26</td><td><div class="action-dots"><span></span><span></span><span></span></div></td></tr>
            <tr><td><div class="tenant-name">WestShore Media</div><div class="tenant-sub">Expansion ¬∑ Media</div></td><td><span class="market-tag">Santa Monica</span></td><td><span class="size-val">14,200</span></td><td><span class="value-cell">$8.5M</span></td><td><span class="stage-pill stage-proposal">Proposal</span></td><td><div class="prob-bar-wrap"><div class="prob-bar-bg"><div class="prob-bar-fill" style="width:61%"></div></div><span class="prob-val">61%</span></div></td><td style="font-family:'JetBrains Mono',monospace;font-size:8.5px;color:var(--text-mid)">May '26</td><td><div class="action-dots"><span></span><span></span><span></span></div></td></tr>
            <tr><td><div class="tenant-name">Meridian Health Partners</div><div class="tenant-sub">New Req. ¬∑ Healthcare</div></td><td><span class="market-tag">Burbank</span></td><td><span class="size-val">9,000</span></td><td><span class="value-cell">$4.2M</span></td><td><span class="stage-pill stage-prospect">Prospect</span></td><td><div class="prob-bar-wrap"><div class="prob-bar-bg"><div class="prob-bar-fill blue" style="width:24%"></div></div><span class="prob-val">24%</span></div></td><td style="font-family:'JetBrains Mono',monospace;font-size:8.5px;color:var(--text-mid)">Q4 '26</td><td><div class="action-dots"><span></span><span></span><span></span></div></td></tr>
            <tr><td><div class="tenant-name">Summit Legal Group</div><div class="tenant-sub">Expansion ¬∑ Legal</div></td><td><span class="market-tag">Century City</span></td><td><span class="size-val">18K</span></td><td><span class="value-cell">$16M</span></td><td><span class="stage-pill stage-loi">LOI Signed</span></td><td><div class="prob-bar-wrap"><div class="prob-bar-bg"><div class="prob-bar-fill green" style="width:82%"></div></div><span class="prob-val">82%</span></div></td><td style="font-family:'JetBrains Mono',monospace;font-size:8.5px;color:var(--text-mid)">Apr '26</td><td><div class="action-dots"><span></span><span></span><span></span></div></td></tr>
            <tr><td><div class="tenant-name">Horizon Biotech</div><div class="tenant-sub">Expansion ¬∑ Life Sci</div></td><td><span class="market-tag">El Segundo</span></td><td><span class="size-val">22K</span></td><td><span class="value-cell">$14M</span></td><td><span class="stage-pill stage-qualify">Qualifying</span></td><td><div class="prob-bar-wrap"><div class="prob-bar-bg"><div class="prob-bar-fill amber" style="width:42%"></div></div><span class="prob-val">42%</span></div></td><td style="font-family:'JetBrains Mono',monospace;font-size:8.5px;color:var(--text-mid)">Q3 '26</td><td><div class="action-dots"><span></span><span></span><span></span></div></td></tr>
            <tr><td><div class="tenant-name">Pacific Ventures</div><div class="tenant-sub">Relocation ¬∑ VC</div></td><td><span class="market-tag">Santa Monica</span></td><td><span class="size-val">12K</span></td><td><span class="value-cell">$7.8M</span></td><td><span class="stage-pill stage-proposal">Proposal</span></td><td><div class="prob-bar-wrap"><div class="prob-bar-bg"><div class="prob-bar-fill" style="width:55%"></div></div><span class="prob-val">55%</span></div></td><td style="font-family:'JetBrains Mono',monospace;font-size:8.5px;color:var(--text-mid)">Jun '26</td><td><div class="action-dots"><span></span><span></span><span></span></div></td></tr>
            <tr><td><div class="tenant-name">Catalyst Media</div><div class="tenant-sub">New Req. ¬∑ Media</div></td><td><span class="market-tag">Culver City</span></td><td><span class="size-val">8,500</span></td><td><span class="value-cell">$5.1M</span></td><td><span class="stage-pill stage-qualify">Qualifying</span></td><td><div class="prob-bar-wrap"><div class="prob-bar-bg"><div class="prob-bar-fill amber" style="width:35%"></div></div><span class="prob-val">35%</span></div></td><td style="font-family:'JetBrains Mono',monospace;font-size:8.5px;color:var(--text-mid)">Q4 '26</td><td><div class="action-dots"><span></span><span></span><span></span></div></td></tr>
            <tr><td><div class="tenant-name">CloudNine Software</div><div class="tenant-sub">New Req. ¬∑ SaaS</div></td><td><span class="market-tag">Playa Vista</span></td><td><span class="size-val">11K</span></td><td><span class="value-cell">$6.8M</span></td><td><span class="stage-pill stage-prospect">Prospect</span></td><td><div class="prob-bar-wrap"><div class="prob-bar-bg"><div class="prob-bar-fill blue" style="width:18%"></div></div><span class="prob-val">18%</span></div></td><td style="font-family:'JetBrains Mono',monospace;font-size:8.5px;color:var(--text-mid)">2027</td><td><div class="action-dots"><span></span><span></span><span></span></div></td></tr>
            <tr><td><div class="tenant-name">Verde Architects</div><div class="tenant-sub">Relocation ¬∑ Design</div></td><td><span class="market-tag">W. Hollywood</span></td><td><span class="size-val">5,500</span></td><td><span class="value-cell">$3.2M</span></td><td><span class="stage-pill stage-proposal">Proposal</span></td><td><div class="prob-bar-wrap"><div class="prob-bar-bg"><div class="prob-bar-fill" style="width:58%"></div></div><span class="prob-val">58%</span></div></td><td style="font-family:'JetBrains Mono',monospace;font-size:8.5px;color:var(--text-mid)">May '26</td><td><div class="action-dots"><span></span><span></span><span></span></div></td></tr>
            <tr><td><div class="tenant-name">Arclight Partners</div><div class="tenant-sub">Expansion ¬∑ Finance</div></td><td><span class="market-tag">DTLA</span></td><td><span class="size-val">35K</span></td><td><span class="value-cell">$18M</span></td><td><span class="stage-pill stage-qualify">Qualifying</span></td><td><div class="prob-bar-wrap"><div class="prob-bar-bg"><div class="prob-bar-fill amber" style="width:45%"></div></div><span class="prob-val">45%</span></div></td><td style="font-family:'JetBrains Mono',monospace;font-size:8.5px;color:var(--text-mid)">Q3 '26</td><td><div class="action-dots"><span></span><span></span><span></span></div></td></tr>
            <tr><td><div class="tenant-name">Zenith Healthcare</div><div class="tenant-sub">New Req. ¬∑ Healthcare</div></td><td><span class="market-tag">Burbank</span></td><td><span class="size-val">7,000</span></td><td><span class="value-cell">$3.4M</span></td><td><span class="stage-pill stage-prospect">Prospect</span></td><td><div class="prob-bar-wrap"><div class="prob-bar-bg"><div class="prob-bar-fill blue" style="width:22%"></div></div><span class="prob-val">22%</span></div></td><td style="font-family:'JetBrains Mono',monospace;font-size:8.5px;color:var(--text-mid)">Q4 '26</td><td><div class="action-dots"><span></span><span></span><span></span></div></td></tr>
          </tbody>
        </table>
      </div>
    </div>

  </div><!-- /content -->
</div><!-- /main -->

<!-- ‚ïê‚ïê ADD INTELLIGENCE PANEL ‚ïê‚ïê -->
<div id="intel-panel">
  <div class="panel-header">
    <div>
      <div class="panel-title">Add Intelligence</div>
      <div class="panel-sub">Tell us what you want to watch</div>
    </div>
    <div class="panel-close" onclick="closeIntelPanel()">‚úï</div>
  </div>

  <div class="panel-body">

    <!-- Natural Language Input -->
    <div class="panel-section">
      <div class="panel-section-title">Tell us what you want</div>
      <div class="nlp-input-wrap">
        <textarea class="nlp-input" id="nlp-input" placeholder="e.g. Show me CRE growth projections in the 310 area for tech tenants over the next 12 months..."></textarea>
        <button class="nlp-send-btn" onclick="submitNLP()">‚Üí</button>
      </div>
      <div class="nlp-suggestions">
        <div class="nlp-suggestion" onclick="fillNLP(this)">I want updates on commercial real estate in area code 310</div>
        <div class="nlp-suggestion" onclick="fillNLP(this)">Show me how interest rate changes will impact CRE industries differently</div>
        <div class="nlp-suggestion" onclick="fillNLP(this)">Track CRE growth projections in LA for healthcare and tech tenants</div>
        <div class="nlp-suggestion" onclick="fillNLP(this)">Alert me when any office vacancy in Santa Monica drops below 8%</div>
      </div>
    </div>

    <!-- Category Selector -->
    <div class="panel-section">
      <div class="panel-section-title">Or choose a category</div>
      <div class="cat-grid">
        <div class="cat-btn active" onclick="selectCat(this)">
          <div class="cat-btn-icon">üìç</div>
          <div class="cat-btn-info"><div class="cat-btn-name">By Area / ZIP</div><div class="cat-btn-desc">Track a specific geography</div></div>
        </div>
        <div class="cat-btn" onclick="selectCat(this)">
          <div class="cat-btn-icon">üè≠</div>
          <div class="cat-btn-info"><div class="cat-btn-name">By Industry</div><div class="cat-btn-desc">Tech, healthcare, finance...</div></div>
        </div>
        <div class="cat-btn" onclick="selectCat(this)">
          <div class="cat-btn-icon">üìà</div>
          <div class="cat-btn-info"><div class="cat-btn-name">Macro Signal</div><div class="cat-btn-desc">Rates, inflation, cap rates</div></div>
        </div>
        <div class="cat-btn" onclick="selectCat(this)">
          <div class="cat-btn-icon">üè¢</div>
          <div class="cat-btn-info"><div class="cat-btn-name">Property Type</div><div class="cat-btn-desc">Office, industrial, retail...</div></div>
        </div>
        <div class="cat-btn" onclick="selectCat(this)">
          <div class="cat-btn-icon">üéØ</div>
          <div class="cat-btn-info"><div class="cat-btn-name">Tenant Watch</div><div class="cat-btn-desc">Track specific companies</div></div>
        </div>
        <div class="cat-btn" onclick="selectCat(this)">
          <div class="cat-btn-icon">‚öñÔ∏è</div>
          <div class="cat-btn-info"><div class="cat-btn-name">Regulatory</div><div class="cat-btn-desc">Zoning, permits, variances</div></div>
        </div>
      </div>
    </div>

    <!-- Configuration fields -->
    <div class="panel-section">
      <div class="panel-section-title">Configure</div>
      <div class="panel-row">
        <div>
          <label class="panel-label">Area / ZIP / Metro</label>
          <input class="panel-input" type="text" placeholder="e.g. 90401, 310, Los Angeles" />
        </div>
        <div>
          <label class="panel-label">Industry Focus</label>
          <input class="panel-input" type="text" placeholder="e.g. Tech, Healthcare, All" />
        </div>
      </div>
      <div class="panel-row">
        <div>
          <label class="panel-label">Property Type</label>
          <input class="panel-input" type="text" placeholder="e.g. Office, Industrial, All" />
        </div>
        <div>
          <label class="panel-label">Alert Threshold</label>
          <input class="panel-input" type="text" placeholder="e.g. Vacancy &lt;8%, Rate +25bps" />
        </div>
      </div>
      <div>
        <label class="panel-label" style="margin-bottom:8px;">Update Frequency</label>
        <div class="freq-row">
          <div class="freq-btn" onclick="selectFreq(this)">Realtime</div>
          <div class="freq-btn active" onclick="selectFreq(this)">Daily</div>
          <div class="freq-btn" onclick="selectFreq(this)">Weekly</div>
          <div class="freq-btn" onclick="selectFreq(this)">Monthly</div>
        </div>
      </div>
      <button class="panel-add-btn" onclick="addWatch()">Add to My Intelligence ‚Üí</button>
    </div>

    <!-- Active Watches -->
    <div class="panel-section">
      <div class="panel-section-title">Active Watches</div>
      <div class="watch-list" id="watch-list">
        <div class="watch-item">
          <div class="watch-item-icon">üìç</div>
          <div class="watch-item-info">
            <div class="watch-item-title">West Coast Office Markets</div>
            <div class="watch-item-meta">Vacancy rate ¬∑ All industries ¬∑ 15 submarkets</div>
            <div class="watch-item-freq">Daily ¬∑ 6:00 AM</div>
          </div>
          <div class="watch-remove">‚úï</div>
        </div>
        <div class="watch-item">
          <div class="watch-item-icon">üìà</div>
          <div class="watch-item-info">
            <div class="watch-item-title">Interest Rate ‚Üí Cap Rate Impact</div>
            <div class="watch-item-meta">Fed signals ¬∑ Office, Industrial, Retail ¬∑ All markets</div>
            <div class="watch-item-freq">Realtime alerts</div>
          </div>
          <div class="watch-remove">‚úï</div>
        </div>
        <div class="watch-item">
          <div class="watch-item-icon">üéØ</div>
          <div class="watch-item-info">
            <div class="watch-item-title">TAMI Tenant Expansion ¬∑ LA Metro</div>
            <div class="watch-item-meta">Tech, Advertising, Media, Info ¬∑ 310 / 424 area codes</div>
            <div class="watch-item-freq">Daily</div>
          </div>
          <div class="watch-remove">‚úï</div>
        </div>
        <div class="watch-item">
          <div class="watch-item-icon">üì°</div>
          <div class="watch-item-info">
            <div class="watch-item-title">Zoning Variances ¬∑ Santa Monica + Culver City</div>
            <div class="watch-item-meta">Permit filings ¬∑ All property types ¬∑ ZIP 90401, 90232</div>
            <div class="watch-item-freq">Realtime alerts</div>
          </div>
          <div class="watch-remove">‚úï</div>
        </div>
      </div>
    </div>

  </div>
</div>

<!-- TOAST -->
<div class="toast" id="toast">
  <div class="toast-icon">‚úÖ</div>
  <div class="toast-text"><strong>Intelligence watch added.</strong> Your agent will begin monitoring now.</div>
</div>

<style>
@keyframes pulseGold {
  0%,100% { box-shadow: 0 0 0 0 rgba(196,158,84,0.4); }
  50% { box-shadow: 0 0 0 5px rgba(196,158,84,0); }
}
</style>

<script>
// ‚îÄ‚îÄ‚îÄ ONBOARDING ‚îÄ‚îÄ‚îÄ
let currentStep = 1;
const totalSteps = 5;

const stepLabels = ['Get Started', 'Next ‚Üí', 'Next ‚Üí', 'Next ‚Üí', 'Launch Dashboard ‚Üí'];

function nextStep() {
  if (currentStep < totalSteps) {
    document.getElementById(`ob-step-${currentStep}`).classList.remove('active');
    currentStep++;
    document.getElementById(`ob-step-${currentStep}`).classList.add('active');
    document.getElementById('ob-counter').textContent = `Step ${currentStep} of ${totalSteps}`;
    document.getElementById('ob-progress').style.width = `${(currentStep / totalSteps) * 100}%`;
    document.getElementById('ob-btn-label').textContent = stepLabels[currentStep - 1];
    // update welcome name
    const nameVal = document.getElementById('ob-name').value.trim().split(' ')[0];
    document.getElementById('welcome-name').textContent = nameVal ? ', ' + nameVal : '';
  } else {
    finishOnboarding();
  }
}

function skipOnboarding() {
  finishOnboarding();
}

function finishOnboarding() {
  // Update sidebar profile card with onboarding data
  const nameVal = document.getElementById('ob-name')?.value.trim() || '';
  const firmInputs = document.querySelectorAll('#ob-step-2 .ob-input');
  const firmVal = firmInputs[1]?.value.trim() || '';
  const titleVal = firmInputs[2]?.value.trim() || '';

  if (nameVal) {
    const avatarEl = document.querySelector('#nav-profile .user-avatar');
    const nameEl = document.querySelector('#nav-profile .user-name');
    const titleEl = document.querySelector('#nav-profile .user-title');
    if (avatarEl) avatarEl.textContent = nameVal.charAt(0).toUpperCase();
    if (nameEl) nameEl.textContent = nameVal;
    if (titleEl) titleEl.textContent = [titleVal, firmVal].filter(Boolean).join(' ¬∑ ') || 'CRE Professional';
  }

  const overlay = document.getElementById('onboarding-overlay');
  overlay.classList.add('hidden');
  setTimeout(() => { overlay.style.display = 'none'; startTour(); }, 400);
}

function toggleChip(el) { el.classList.toggle('selected'); }

function addMarketChip() {
  const input = document.getElementById('market-zip-input');
  const val = input.value.trim();
  if (!val) return;
  // Support comma-separated entries
  val.split(',').forEach(entry => {
    const text = entry.trim();
    if (!text) return;
    const chip = document.createElement('div');
    chip.className = 'ob-chip selected';
    chip.setAttribute('onclick', 'toggleChip(this)');
    chip.textContent = text;
    document.getElementById('market-chips').appendChild(chip);
  });
  input.value = '';
  input.focus();
}

// ‚îÄ‚îÄ‚îÄ DASHBOARD TOUR ‚îÄ‚îÄ‚îÄ
const tourSteps = [
  {
    target: 'kpi-row',
    title: 'Your KPI Summary',
    desc: 'At a glance: pipeline value, active deals, vacancy trends, agent-sourced leads, and unread alerts. Updated every morning.',
    pos: 'bottom'
  },
  {
    target: 'heatmap-card',
    title: 'Submarket Heatmap',
    desc: 'Color-coded vacancy rates across every submarket you cover. Red = high vacancy, green = tight. Click any cell to drill in.',
    pos: 'bottom'
  },
  {
    target: 'agent-card',
    title: 'Live Agent Feed',
    desc: 'Real-time stream of everything your AI agents are doing right now ‚Äî alerts, leads found, documents reviewed, pitches being written.',
    pos: 'bottom'
  },
  {
    target: 'alerts-card',
    title: 'Priority Alerts',
    desc: 'Ranked by urgency. Each alert has a one-click action button so you can act immediately ‚Äî draft outreach, review a document, or deep-dive.',
    pos: 'left'
  },
  {
    target: 'add-intel-btn',
    title: '+ Add Intelligence',
    desc: 'This is how you tell LandMarq what to watch. Say it in plain English ‚Äî "track CRE growth in 310 for tech tenants" ‚Äî and an agent starts immediately.',
    pos: 'bottom'
  }
];

let tourIdx = 0;
let tourActive = false;

function startTour() {
  tourActive = true;
  tourIdx = 0;
  showTourStep();
}

function showTourStep() {
  const ring = document.getElementById('spotlight-ring');
  const tip = document.getElementById('spotlight-tooltip');
  const step = tourSteps[tourIdx];

  if (!step) { endTour(); return; }

  const target = document.getElementById(step.target);
  if (!target) { endTour(); return; }

  const rect = target.getBoundingClientRect();
  const pad = 8;

  ring.style.top = (rect.top - pad) + 'px';
  ring.style.left = (rect.left - pad) + 'px';
  ring.style.width = (rect.width + pad * 2) + 'px';
  ring.style.height = (rect.height + pad * 2) + 'px';
  ring.classList.add('visible');

  document.getElementById('tt-step').textContent = `Tour ¬∑ ${tourIdx + 1} of ${tourSteps.length}`;
  document.getElementById('tt-title').textContent = step.title;
  document.getElementById('tt-desc').textContent = step.desc;
  document.getElementById('tt-next-btn').textContent = tourIdx < tourSteps.length - 1 ? 'Next ‚Üí' : 'Done ‚úì';

  // position tooltip
  const tipW = 280, tipH = 150;
  let top, left;

  if (step.pos === 'bottom') {
    top = rect.bottom + pad + 14;
    left = rect.left;
  } else if (step.pos === 'left') {
    top = rect.top;
    left = rect.left - tipW - 20;
  } else {
    top = rect.bottom + 14;
    left = rect.left;
  }

  // clamp
  if (left + tipW > window.innerWidth - 10) left = window.innerWidth - tipW - 10;
  if (left < 10) left = 10;
  if (top + tipH > window.innerHeight - 10) top = rect.top - tipH - 14;

  tip.style.top = top + 'px';
  tip.style.left = left + 'px';
  tip.classList.add('visible');
}

function nextTourStep() {
  tourIdx++;
  if (tourIdx >= tourSteps.length) { endTour(); return; }
  showTourStep();
}

function endTour() {
  document.getElementById('spotlight-ring').classList.remove('visible');
  document.getElementById('spotlight-tooltip').classList.remove('visible');
  tourActive = false;
}

// ‚îÄ‚îÄ‚îÄ INTEL PANEL ‚îÄ‚îÄ‚îÄ
function openIntelPanel() {
  document.getElementById('intel-panel').classList.add('open');
}

function closeIntelPanel() {
  document.getElementById('intel-panel').classList.remove('open');
}

function selectCat(el) {
  document.querySelectorAll('.cat-btn').forEach(b => b.classList.remove('active'));
  el.classList.add('active');
}

function selectFreq(el) {
  document.querySelectorAll('.freq-btn').forEach(b => b.classList.remove('active'));
  el.classList.add('active');
}

function fillNLP(el) {
  const text = el.textContent;
  document.getElementById('nlp-input').value = text;
  document.getElementById('nlp-input').focus();
}

function submitNLP() {
  addWatch(document.getElementById('nlp-input').value);
  document.getElementById('nlp-input').value = '';
}

function addWatch(customTitle) {
  const list = document.getElementById('watch-list');
  const title = customTitle || 'New Intelligence Watch';

  const item = document.createElement('div');
  item.className = 'watch-item';
  item.style.animation = 'streamIn 0.4s ease-out';
  item.innerHTML = `
    <div class="watch-item-icon">üîç</div>
    <div class="watch-item-info">
      <div class="watch-item-title">${title.length > 60 ? title.substring(0, 60) + '...' : title}</div>
      <div class="watch-item-meta">Agent configured ¬∑ Monitoring active</div>
      <div class="watch-item-freq">Daily ¬∑ Starting now</div>
    </div>
    <div class="watch-remove" onclick="this.parentElement.remove()">‚úï</div>
  `;
  list.prepend(item);

  // Scroll to and highlight the new watch in the panel
  setTimeout(() => {
    item.scrollIntoView({ behavior: 'smooth', block: 'center' });
    item.style.boxShadow = '0 0 0 2px var(--gold), 0 0 20px rgba(196,158,84,0.3)';
    item.style.transition = 'box-shadow 0.3s ease';
    setTimeout(() => { item.style.boxShadow = 'none'; }, 3000);
  }, 100);

  // Also add a live agent feed item to show it on the dashboard
  const stream = document.getElementById('agentStream');
  if (stream) {
    const el = document.createElement('div');
    el.className = 'stream-item';
    el.style.cursor = 'pointer';
    el.innerHTML = `<div class="stream-icon icon-intel">üîç</div><div><div class="stream-text"><strong>New Watch Active:</strong> ${title.length > 50 ? title.substring(0, 50) + '...' : title}</div><div class="stream-meta"><span class="stream-tag tag-intel">Intelligence</span> just now ¬∑ Agent Configured</div></div>`;
    stream.prepend(el);
    // Highlight the new feed item
    el.style.background = 'var(--gold-dim)';
    el.style.borderLeft = '3px solid var(--gold)';
    el.style.transition = 'all 0.5s ease';
    setTimeout(() => { el.style.background = ''; el.style.borderLeft = ''; }, 4000);
    while (stream.children.length > 7) stream.removeChild(stream.lastChild);
  }

  // Close panel after short delay so user sees the feed update
  setTimeout(() => { closeIntelPanel(); }, 800);

  // Toast
  const toast = document.getElementById('toast');
  toast.classList.add('show');
  setTimeout(() => toast.classList.remove('show'), 3500);

  // After panel closes, scroll to and highlight the feed item on the main dashboard
  setTimeout(() => {
    const feedItem = document.querySelector('#agentStream .stream-item');
    if (feedItem) {
      feedItem.scrollIntoView({ behavior: 'smooth', block: 'center' });
      feedItem.style.boxShadow = '0 0 0 2px var(--gold), 0 0 20px rgba(196,158,84,0.3)';
      setTimeout(() => { feedItem.style.boxShadow = 'none'; }, 3000);
    }
  }, 1200);
}

// ‚îÄ‚îÄ‚îÄ ADD DEAL MODAL ‚îÄ‚îÄ‚îÄ
function openAddDealModal() {
  const formStyle = `style="width:100%;padding:8px 10px;background:var(--surface-2);border:1px solid var(--border);border-radius:4px;color:var(--cream);font-family:'Syne',sans-serif;font-size:12px;outline:none;"`;
  const labelStyle = `style="font-family:'JetBrains Mono',monospace;font-size:9px;letter-spacing:0.12em;text-transform:uppercase;color:var(--text-dim);margin-bottom:4px;display:block;"`;
  const groupStyle = `style="margin-bottom:12px;"`;

  showModal('New Deal', 'Add Deal to Pipeline',
    `<div ${groupStyle}><label ${labelStyle}>Tenant Name</label><input id="deal-tenant" ${formStyle} placeholder="e.g. Acme Corp"></div>`
    + `<div ${groupStyle}><label ${labelStyle}>Deal Type</label><input id="deal-type" ${formStyle} placeholder="e.g. New Requirement, Expansion, Relocation"></div>`
    + `<div style="display:flex;gap:8px;margin-bottom:12px;">`
    + `<div style="flex:1;"><label ${labelStyle}>Market</label><input id="deal-market" ${formStyle} placeholder="e.g. Santa Monica"></div>`
    + `<div style="flex:1;"><label ${labelStyle}>Square Footage</label><input id="deal-sf" ${formStyle} placeholder="e.g. 15,000"></div></div>`
    + `<div style="display:flex;gap:8px;margin-bottom:12px;">`
    + `<div style="flex:1;"><label ${labelStyle}>Est. Value</label><input id="deal-value" ${formStyle} placeholder="e.g. $8M"></div>`
    + `<div style="flex:1;"><label ${labelStyle}>Stage</label><select id="deal-stage" ${formStyle}><option>Prospect</option><option>Qualifying</option><option>Proposal</option><option>LOI Signed</option><option>Closing</option></select></div></div>`
    + `<div style="display:flex;gap:8px;margin-bottom:12px;">`
    + `<div style="flex:1;"><label ${labelStyle}>Key Contact</label><input id="deal-contact" ${formStyle} placeholder="e.g. Jane Smith, VP"></div>`
    + `<div style="flex:1;"><label ${labelStyle}>Expected Close</label><input id="deal-close" ${formStyle} placeholder="e.g. Q3 2026"></div></div>`
    + `<div ${groupStyle}><label ${labelStyle}>Notes</label><textarea id="deal-notes" ${formStyle} rows="2" placeholder="Key details, requirements, competitive situation..."></textarea></div>`
    + `<button onclick="submitNewDeal()" style="width:100%;padding:12px;background:var(--gold);color:#0A0C0E;border:none;border-radius:4px;font-weight:700;font-family:'Syne',sans-serif;font-size:13px;cursor:pointer;">Add to Pipeline ‚Üí</button>`
  );
}

function submitNewDeal() {
  const tenant = document.getElementById('deal-tenant')?.value || 'New Deal';
  const type = document.getElementById('deal-type')?.value || 'New Requirement';
  const market = document.getElementById('deal-market')?.value || 'TBD';
  const sf = document.getElementById('deal-sf')?.value || 'TBD';
  const value = document.getElementById('deal-value')?.value || 'TBD';
  const stage = document.getElementById('deal-stage')?.value || 'Prospect';
  const contact = document.getElementById('deal-contact')?.value || 'TBD';
  const close = document.getElementById('deal-close')?.value || 'TBD';

  // Add row to pipeline table
  const tbody = document.querySelector('.pipeline-table tbody');
  if (tbody) {
    const stageClass = stage === 'Prospect' ? 'stage-prospect' : stage === 'Qualifying' ? 'stage-qualify' : stage === 'Proposal' ? 'stage-proposal' : stage === 'LOI Signed' ? 'stage-loi' : 'stage-prospect';
    const tr = document.createElement('tr');
    tr.style.animation = 'streamIn 0.4s ease-out';
    tr.style.cursor = 'pointer';
    tr.innerHTML = `<td><div class="tenant-name">${tenant}</div><div class="tenant-sub">${type}</div></td><td><span class="market-tag">${market}</span></td><td><span class="size-val">${sf}</span></td><td><span class="value-cell">${value}</span></td><td><span class="stage-pill ${stageClass}">${stage}</span></td><td><div class="prob-bar-wrap"><div class="prob-bar-bg"><div class="prob-bar-fill blue" style="width:20%"></div></div><span class="prob-val">20%</span></div></td><td style="font-family:'JetBrains Mono',monospace;font-size:8.5px;color:var(--text-mid)">${close}</td><td><div class="action-dots"><span></span><span></span><span></span></div></td>`;
    tbody.appendChild(tr);

    // Make the new row clickable
    tr.addEventListener('click', () => {
      showModal('Deal Detail', tenant,
        `<div style="font-size:13px;color:var(--text-mid);margin-bottom:16px;">${type} ¬∑ ${market}</div>`
        + detailRow('Square Footage', sf, 'var(--cream)')
        + detailRow('Estimated Value', value, 'var(--gold)')
        + detailRow('Stage', stage, 'var(--cream)')
        + detailRow('Expected Close', close, 'var(--text-mid)')
        + detailRow('Key Contact', contact, 'var(--cream)')
      );
    });
  }

  closeModal();

  // Scroll to pipeline and highlight
  setTimeout(() => {
    const pipeline = document.getElementById('pipeline-card');
    if (pipeline) {
      pipeline.scrollIntoView({ behavior: 'smooth', block: 'center' });
      pipeline.style.boxShadow = '0 0 0 2px var(--gold), 0 0 20px rgba(196,158,84,0.3)';
      pipeline.style.transition = 'box-shadow 0.5s ease';
      setTimeout(() => { pipeline.style.boxShadow = 'none'; }, 3000);
    }
  }, 200);

  // Toast
  const toast = document.getElementById('toast');
  toast.innerHTML = `<div class="toast-icon">‚úÖ</div><div class="toast-text"><strong>${tenant}</strong> added to pipeline.</div>`;
  toast.classList.add('show');
  setTimeout(() => toast.classList.remove('show'), 3500);
}

// watch remove
document.querySelectorAll('.watch-remove').forEach(btn => {
  btn.addEventListener('click', () => btn.parentElement.remove());
});

// Nav
document.querySelectorAll('.nav-item').forEach(item => {
  item.addEventListener('click', () => {
    document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
    item.classList.add('active');
  });
});

// Live agent stream
const streamContainer = document.getElementById('agentStream');
const newAlerts = [
  { icon: 'üåê', cls: 'icon-intel', text: '<strong>Market Agent</strong> updated SF Financial District vacancy to 26.3% ‚Äî highest in 18 months.', tagCls: 'tag-intel', tag: 'Market' },
  { icon: 'üéØ', cls: 'icon-lead', text: '<strong>Lead Agent</strong> identified Shopify subletting 18K SF in Santa Monica ‚Äî window opening.', tagCls: 'tag-lead', tag: 'New Lead' },
  { icon: 'üìã', cls: 'icon-doc', text: '<strong>LOI Agent</strong> completed Apex Capital clause comparison. 2 items flagged for review.', tagCls: 'tag-doc', tag: 'Document' }
];
let alertIdx = 0;
setInterval(() => {
  const a = newAlerts[alertIdx % newAlerts.length]; alertIdx++;
  const el = document.createElement('div');
  el.className = 'stream-item';
  el.innerHTML = `<div class="stream-icon ${a.cls}">${a.icon}</div><div><div class="stream-text">${a.text}</div><div class="stream-meta"><span class="stream-tag ${a.tagCls}">${a.tag}</span> just now ¬∑ Agent</div></div>`;
  streamContainer.prepend(el);
  while (streamContainer.children.length > 7) streamContainer.removeChild(streamContainer.lastChild);
}, 11000);

// ‚îÄ‚îÄ‚îÄ DETAIL MODAL SYSTEM ‚îÄ‚îÄ‚îÄ
const modalOverlay = document.createElement('div');
modalOverlay.id = 'detail-modal';
modalOverlay.style.cssText = 'position:fixed;inset:0;z-index:900;display:none;align-items:center;justify-content:center;background:rgba(10,12,14,0.85);backdrop-filter:blur(6px);';
modalOverlay.innerHTML = `
  <div id="modal-card" style="background:var(--surface);border:1px solid var(--border-gold);border-radius:12px;width:600px;max-width:90vw;max-height:85vh;overflow-y:auto;box-shadow:0 40px 100px rgba(0,0,0,0.6);animation:modalIn 0.3s ease-out;">
    <div id="modal-header" style="display:flex;justify-content:space-between;align-items:center;padding:20px 24px;border-bottom:1px solid var(--border);">
      <div>
        <div id="modal-badge" style="font-family:'JetBrains Mono',monospace;font-size:8px;letter-spacing:0.15em;text-transform:uppercase;color:var(--gold);margin-bottom:4px;"></div>
        <div id="modal-title" style="font-family:'Cormorant Garamond',serif;font-size:22px;font-weight:600;color:var(--cream);"></div>
      </div>
      <div onclick="closeModal()" style="cursor:pointer;font-size:18px;color:var(--text-dim);padding:4px 8px;">&times;</div>
    </div>
    <div id="modal-body" style="padding:24px;"></div>
  </div>
`;
document.body.appendChild(modalOverlay);
modalOverlay.addEventListener('click', (e) => { if (e.target === modalOverlay) closeModal(); });

function showModal(badge, title, bodyHTML) {
  document.getElementById('modal-badge').textContent = badge;
  document.getElementById('modal-title').textContent = title;
  document.getElementById('modal-body').innerHTML = bodyHTML;
  modalOverlay.style.display = 'flex';
}
function closeModal() { modalOverlay.style.display = 'none'; }
document.addEventListener('keydown', (e) => { if (e.key === 'Escape') closeModal(); });

// Helper for detail rows
function detailRow(label, value, color) {
  return `<div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border);">
    <span style="font-size:12px;color:var(--text-mid);">${label}</span>
    <span style="font-size:12px;font-weight:600;color:${color || 'var(--cream)'};">${value}</span>
  </div>`;
}

// ‚îÄ‚îÄ‚îÄ KPI CARD CLICKS ‚îÄ‚îÄ‚îÄ
const kpiData = [
  { badge: 'Pipeline', title: 'Total Pipeline Value ‚Äî $218M', body: () =>
    `<div style="margin-bottom:16px;font-size:13px;color:var(--text);line-height:1.6;">Pipeline value increased 12.4% vs. last quarter, driven by Netflix HQ expansion and 3 new TAMI requirements entering qualifying stage.</div>`
    + detailRow('Netflix Inc. ‚Äî Culver City', '$42M', 'var(--gold)')
    + detailRow('Apex Capital ‚Äî Century City', '$19M', 'var(--gold)')
    + detailRow('TechCo Inc. ‚Äî Playa Vista', '$11M', 'var(--cream)')
    + detailRow('WestShore Media ‚Äî Santa Monica', '$8.5M', 'var(--cream)')
    + detailRow('Meridian Health ‚Äî Burbank', '$4.2M', 'var(--cream)')
    + detailRow('Other deals (9)', '$133.3M', 'var(--text-mid)')
    + `<div style="margin-top:16px;padding:12px;background:var(--green-dim);border:1px solid rgba(74,155,111,0.2);border-radius:6px;font-size:12px;color:var(--green);">‚ñ≤ Weighted pipeline up $24M from Q4 2025. 4 deals expected to close by May.</div>`
  },
  { badge: 'Deals', title: 'Active Deals ‚Äî 14', body: () =>
    `<div style="margin-bottom:16px;font-size:13px;color:var(--text);line-height:1.6;">3 new deals entered pipeline this month. 2 deals advanced stages (Qualifying ‚Üí Proposal).</div>`
    + detailRow('Prospect', '3 deals', 'var(--text-mid)')
    + detailRow('Qualifying', '4 deals', 'var(--blue)')
    + detailRow('Proposal', '4 deals', 'var(--amber)')
    + detailRow('LOI Signed', '2 deals', 'var(--gold)')
    + detailRow('Closing', '1 deal', 'var(--green)')
    + `<div style="margin-top:16px;padding:12px;background:var(--gold-dim);border:1px solid var(--border-gold);border-radius:6px;font-size:12px;color:var(--gold);">Next milestone: Apex Capital closing expected Mar '26. Netflix proposal due Apr 1.</div>`
  },
  { badge: 'Vacancy', title: 'Avg. LA Office Vacancy ‚Äî 14.2%', body: () =>
    `<div style="margin-bottom:16px;font-size:13px;color:var(--text);line-height:1.6;">LA metro vacancy trending down 0.8% over 90 days. TAMI sector absorption driving tightening in Westside submarkets.</div>`
    + detailRow('Santa Monica', '9.8%', 'var(--green)')
    + detailRow('Playa Vista', '8.1%', 'var(--green)')
    + detailRow('Culver City', '11.2%', 'var(--cream)')
    + detailRow('Century City', '12.6%', 'var(--amber)')
    + detailRow('DTLA', '18.4%', 'var(--red)')
    + detailRow('Wilshire Corridor', '16.1%', 'var(--red)')
    + `<div style="margin-top:16px;padding:12px;background:var(--blue-dim);border:1px solid rgba(74,127,165,0.2);border-radius:6px;font-size:12px;color:var(--blue);">‚ñº Westside vacancy at lowest since 2022. Expect upward rent pressure in Q2.</div>`
  },
  { badge: 'Leads', title: 'Agent-Sourced Leads ‚Äî 31 (30d)', body: () =>
    `<div style="margin-bottom:16px;font-size:13px;color:var(--text);line-height:1.6;">8 new leads this month, up from 23 last month. Lead Agent accuracy: 78% qualification rate.</div>`
    + detailRow('TAMI Sector', '14 leads', 'var(--gold)')
    + detailRow('Healthcare', '6 leads', 'var(--green)')
    + detailRow('Financial Services', '5 leads', 'var(--blue)')
    + detailRow('Professional Services', '4 leads', 'var(--cream)')
    + detailRow('Other', '2 leads', 'var(--text-mid)')
    + `<div style="margin-top:16px;padding:12px;background:var(--green-dim);border:1px solid rgba(74,155,111,0.2);border-radius:6px;font-size:12px;color:var(--green);">Top signal: TechCo Inc. ‚Äî 40+ LA job postings, WeWork badge-in up 62%. High intent.</div>`
  },
  { badge: 'Market', title: 'Avg. NNN PSF ‚Äî $62 (SF Metro)', body: () =>
    `<div style="margin-bottom:16px;font-size:13px;color:var(--text);line-height:1.6;">NNN asking rents up $1.20/SF MoM across LA metro. Class A driving the increase.</div>`
    + detailRow('Class A ‚Äî Westside', '$78/SF', 'var(--gold)')
    + detailRow('Class A ‚Äî DTLA', '$54/SF', 'var(--cream)')
    + detailRow('Class B ‚Äî Westside', '$52/SF', 'var(--cream)')
    + detailRow('Class B ‚Äî Valley', '$38/SF', 'var(--text-mid)')
    + `<div style="margin-top:16px;padding:12px;background:var(--gold-dim);border:1px solid var(--border-gold);border-radius:6px;font-size:12px;color:var(--gold);">Trend: Westside Class A rents up 6.2% YoY. Expect acceleration with declining vacancy.</div>`
  },
  { badge: 'Alerts', title: 'Unread Alerts ‚Äî 7', body: () =>
    `<div style="margin-bottom:16px;font-size:13px;color:var(--text);line-height:1.6;">3 high priority alerts require immediate attention. 2 medium alerts pending review.</div>`
    + `<div style="padding:10px 12px;background:var(--red-dim);border:1px solid rgba(192,83,58,0.2);border-left:3px solid var(--red);border-radius:4px;margin-bottom:6px;"><div style="font-size:12px;font-weight:600;color:var(--cream);">‚ö° Snap vacating 42K SF ‚Äî Santa Monica</div><div style="font-size:11px;color:var(--text-mid);margin-top:2px;">First-mover window: ~6 weeks</div></div>`
    + `<div style="padding:10px 12px;background:var(--red-dim);border:1px solid rgba(192,83,58,0.2);border-left:3px solid var(--red);border-radius:4px;margin-bottom:6px;"><div style="font-size:12px;font-weight:600;color:var(--cream);">üìã LOI Clause Mismatch ‚Äî Apex Capital</div><div style="font-size:11px;color:var(--text-mid);margin-top:2px;">Non-standard co-tenancy clause flagged</div></div>`
    + `<div style="padding:10px 12px;background:var(--gold-dim);border:1px solid var(--border-gold);border-left:3px solid var(--gold);border-radius:4px;margin-bottom:6px;"><div style="font-size:12px;font-weight:600;color:var(--cream);">üéØ TechCo Expansion Signal</div><div style="font-size:11px;color:var(--text-mid);margin-top:2px;">40+ LA job postings detected</div></div>`
  }
];

document.querySelectorAll('.kpi-card').forEach((card, i) => {
  card.style.cursor = 'pointer';
  card.addEventListener('click', () => {
    const d = kpiData[i];
    if (d) showModal(d.badge, d.title, d.body());
  });
});

// ‚îÄ‚îÄ‚îÄ HEATMAP CELL CLICKS ‚îÄ‚îÄ‚îÄ
const heatmapDetail = {
  'DTLA': { vacancy: '18.4%', trend: '‚ñ≤ 1.2%', available: '2.4M SF', avgRent: '$54/SF', topTenants: 'Wells Fargo, Deloitte, CBRE', outlook: 'High vacancy persists. Sublease space still entering market. Watch for conversions.' },
  'Culver City': { vacancy: '11.2%', trend: '‚ñº 0.6%', available: '890K SF', avgRent: '$62/SF', topTenants: 'Amazon Studios, Apple TV+, Sony', outlook: 'Tightening. Media & entertainment driving absorption. Limited new supply.' },
  'Santa Monica': { vacancy: '9.8%', trend: '‚ñº 1.1%', available: '620K SF', avgRent: '$72/SF', topTenants: 'Snap Inc., Hulu, Kite Pharma', outlook: 'Snap departure creates opportunity. 3 TAMI tenants actively searching this submarket.' },
  'Playa Vista': { vacancy: '8.1%', trend: '‚ñº 0.9%', available: '410K SF', avgRent: '$68/SF', topTenants: 'Google, Facebook, IMAX', outlook: 'Tightest Westside submarket. Badge-in data shows 74% occupancy vs 61% DTLA avg.' },
  'El Segundo': { vacancy: '6.7%', trend: '‚ñº 0.4%', available: '340K SF', avgRent: '$48/SF', topTenants: 'Northrop Grumman, Raytheon, Beyond Meat', outlook: 'Aerospace/defense anchor tenants. Very tight. New development planned 2027.' },
  'Century City': { vacancy: '12.6%', trend: '‚ñº 0.3%', available: '780K SF', avgRent: '$82/SF', topTenants: 'CAA, Greenberg Traurig, Ares Management', outlook: 'Premium rents. Financial/legal sector dominant. Apex Capital deal could tighten further.' },
  'West Hollywood': { vacancy: '7.3%', trend: '‚ñº 0.5%', available: '280K SF', avgRent: '$58/SF', topTenants: 'WME, Spotify, Various boutique', outlook: 'Creative office strong. Limited inventory. Rents rising.' },
  'Wilshire Corridor': { vacancy: '16.1%', trend: '‚ñ≤ 0.4%', available: '1.8M SF', avgRent: '$46/SF', topTenants: 'Various mid-size firms', outlook: 'Older inventory struggling. Flight to quality ongoing. Watch for repositioning opportunities.' },
  'Burbank': { vacancy: '10.4%', trend: '‚ñº 0.7%', available: '520K SF', avgRent: '$52/SF', topTenants: 'Warner Bros, Disney, Netflix (post)', outlook: 'Entertainment hub stable. Healthcare sector growing. Meridian Health actively looking.' },
  'Manhattan Bch': { vacancy: '5.9%', trend: '‚ñº 0.2%', available: '180K SF', avgRent: '$56/SF', topTenants: 'Skechers, Manhattan Beach Studios', outlook: 'Extremely tight. Almost no available Class A. Premium location driving wait lists.' },
  'SF Financial': { vacancy: '26.3%', trend: '‚ñ≤ 2.1%', available: '12.4M SF', avgRent: '$68/SF', topTenants: 'Salesforce, Wells Fargo, JPMorgan', outlook: 'Highest vacancy in 18 months. Sublease glut. Major correction potential.' },
  'SF SOMA': { vacancy: '22.1%', trend: '‚ñ≤ 1.4%', available: '6.8M SF', avgRent: '$62/SF', topTenants: 'Airbnb, Pinterest, Stripe', outlook: 'Tech downsizing continues. Some AI startups backfilling but not enough to offset.' },
  'SF Mission': { vacancy: '14.8%', trend: '‚ñº 0.3%', available: '2.1M SF', avgRent: '$54/SF', topTenants: 'Various tech startups', outlook: 'Stabilizing. Smaller suites in demand. Creative/flex space doing better than traditional.' },
  'Bellevue WA': { vacancy: '9.2%', trend: '‚ñº 1.0%', available: '1.2M SF', avgRent: '$58/SF', topTenants: 'Meta, T-Mobile, Paccar', outlook: 'Strong recovery. Tech expansion resuming. Spring Lane development 80% pre-leased.' },
  'Seattle SLU': { vacancy: '11.0%', trend: '‚ñº 0.6%', available: '2.8M SF', avgRent: '$52/SF', topTenants: 'Amazon, Google, Facebook', outlook: 'Amazon RTO driving absorption. New supply delivering but demand keeping pace.' },
  // Southwest
  'Phoenix CBD': { vacancy: '15.2%', trend: '‚ñ≤ 0.8%', available: '3.2M SF', avgRent: '$34/SF', topTenants: 'Freeport-McMoRan, Avnet, Republic Services', outlook: 'Oversupply from speculative builds. Asking rents softening. Watch for tech relocations from CA.' },
  'Scottsdale': { vacancy: '9.8%', trend: '‚ñº 0.5%', available: '1.4M SF', avgRent: '$42/SF', topTenants: 'GoDaddy, Vanguard, Axon', outlook: 'Premium AZ submarket. Strong demand from financial services and tech. Limited Class A supply.' },
  'Tempe': { vacancy: '11.4%', trend: '‚ñº 0.3%', available: '2.1M SF', avgRent: '$38/SF', topTenants: 'State Farm, Carvana, Insight', outlook: 'University-adjacent growth. ASU research corridor driving demand. Mixed-use development active.' },
  'Las Vegas Strip': { vacancy: '8.2%', trend: '‚ñº 0.7%', available: '980K SF', avgRent: '$44/SF', topTenants: 'MGM Resorts, Wynn, Caesars', outlook: 'Hospitality sector recovery complete. Entertainment-adjacent office in demand. Tight supply.' },
  'Henderson NV': { vacancy: '7.1%', trend: '‚ñº 0.4%', available: '620K SF', avgRent: '$36/SF', topTenants: 'Various healthcare, Barclays', outlook: 'Fast-growing suburban market. Healthcare and fintech driving demand. New construction delivering.' },
  'Tucson': { vacancy: '13.6%', trend: '‚ñ≤ 0.2%', available: '1.8M SF', avgRent: '$28/SF', topTenants: 'Raytheon, U of Arizona, Caterpillar', outlook: 'Defense sector stable. University research growing. Affordable rents attracting smaller tenants.' },
  'Albuquerque': { vacancy: '14.1%', trend: '‚ñ≤ 0.5%', available: '2.2M SF', avgRent: '$24/SF', topTenants: 'Sandia National Labs, Intel, Presbyterian', outlook: 'Government/defense anchor stable. Private sector soft. Film industry creating niche demand.' },
  'Mesa AZ': { vacancy: '10.8%', trend: '‚ñº 0.6%', available: '1.6M SF', avgRent: '$32/SF', topTenants: 'Banner Health, Boeing, Apple', outlook: 'Manufacturing and healthcare growth. Apple fab proximity driving secondary demand.' },
  'Chandler AZ': { vacancy: '6.9%', trend: '‚ñº 0.8%', available: '890K SF', avgRent: '$38/SF', topTenants: 'Intel, Microchip Technology, Wells Fargo', outlook: 'Semiconductor hub effect. Very tight. Tech/engineering tenants competing for space.' },
  'Gilbert AZ': { vacancy: '5.4%', trend: '‚ñº 0.5%', available: '420K SF', avgRent: '$34/SF', topTenants: 'Deloitte, GoDaddy, Various startups', outlook: 'Fastest-growing AZ submarket. Almost no Class A available. Premium suburban location.' },
  // Northwest
  'Redmond WA': { vacancy: '7.8%', trend: '‚ñº 0.4%', available: '980K SF', avgRent: '$54/SF', topTenants: 'Microsoft, Nintendo, Facebook', outlook: 'Microsoft campus effect. Very tight. Limited non-tech tenant options.' },
  'Portland Pearl': { vacancy: '14.6%', trend: '‚ñ≤ 0.3%', available: '1.8M SF', avgRent: '$38/SF', topTenants: 'Nike (satellite), Daimler, Various creative', outlook: 'Creative sector struggling. Some sublease space entering market. Rents stabilizing.' },
  'Portland Lloyd': { vacancy: '16.8%', trend: '‚ñ≤ 0.7%', available: '2.4M SF', avgRent: '$32/SF', topTenants: 'Kaiser, Banfield, Various govt', outlook: 'Highest Portland vacancy. Healthcare anchor stable but office sector soft.' },
  'Boise ID': { vacancy: '8.4%', trend: '‚ñº 0.6%', available: '680K SF', avgRent: '$28/SF', topTenants: 'Micron, HP, Albertsons', outlook: 'Strong in-migration effect. Tech relocations from CA driving demand. Limited new supply.' },
  'Tacoma WA': { vacancy: '12.3%', trend: '‚ñº 0.4%', available: '1.4M SF', avgRent: '$34/SF', topTenants: 'MultiCare, State agencies, Various', outlook: 'Affordable alternative to Seattle. Healthcare sector growing. Port-adjacent industrial strong.' },
  'Kirkland WA': { vacancy: '6.2%', trend: '‚ñº 0.3%', available: '380K SF', avgRent: '$52/SF', topTenants: 'Google, EvolutionIQ, Various biotech', outlook: 'Premium Eastside submarket. Very tight. Biotech and AI driving demand.' },
  'Eugene OR': { vacancy: '10.1%', trend: '‚ñº 0.2%', available: '580K SF', avgRent: '$24/SF', topTenants: 'U of Oregon, PeaceHealth, Various', outlook: 'University-driven market. Stable but limited growth. Affordable for remote-first companies.' },
  'Spokane WA': { vacancy: '11.7%', trend: '‚ñ≤ 0.3%', available: '920K SF', avgRent: '$22/SF', topTenants: 'Providence, Itron, Various govt', outlook: 'Affordable inland market. Healthcare anchor. Limited tech sector but growing.' },
  // Mountain
  'Denver LoDo': { vacancy: '16.4%', trend: '‚ñ≤ 0.9%', available: '4.2M SF', avgRent: '$42/SF', topTenants: 'DaVita, Arrow Electronics, Palantir', outlook: 'Oversupply from speculative builds. Sublease market competitive. Watch for rent corrections.' },
  'Denver Tech Ctr': { vacancy: '13.8%', trend: '‚ñº 0.4%', available: '3.6M SF', avgRent: '$38/SF', topTenants: 'Lockheed Martin, Comcast, Dish', outlook: 'Suburban tech corridor stabilizing. Some tenants returning from remote. New amenities driving demand.' },
  'Boulder CO': { vacancy: '8.6%', trend: '‚ñº 0.5%', available: '980K SF', avgRent: '$48/SF', topTenants: 'Google, Twitter, CU Research', outlook: 'Tight premium market. CU research proximity. Biotech and cleantech driving demand.' },
  'Salt Lake City': { vacancy: '11.2%', trend: '‚ñº 0.6%', available: '2.8M SF', avgRent: '$34/SF', topTenants: 'Goldman Sachs, Adobe, Overstock', outlook: 'Silicon Slopes effect continuing. Financial services expanding. Strong fundamentals.' },
  'Provo UT': { vacancy: '7.4%', trend: '‚ñº 0.5%', available: '680K SF', avgRent: '$30/SF', topTenants: 'Qualtrics, Vivint, BYU-adjacent', outlook: 'Very tight. University pipeline strong. Tech startups competing for limited supply.' },
  'Reno NV': { vacancy: '9.8%', trend: '‚ñº 0.4%', available: '1.2M SF', avgRent: '$28/SF', topTenants: 'Tesla (office), Panasonic, Switch', outlook: 'Tesla gigafactory effect. Growing tech sector. Affordable CA alternative.' },
  'Colorado Springs': { vacancy: '10.5%', trend: '‚ñº 0.3%', available: '1.6M SF', avgRent: '$28/SF', topTenants: 'USAA, Northrop Grumman, Various DoD', outlook: 'Military/defense anchor. Space Command HQ effect. Growing cybersecurity cluster.' },
  'Fort Collins': { vacancy: '8.1%', trend: '‚ñº 0.2%', available: '480K SF', avgRent: '$32/SF', topTenants: 'HP, Broadcom, CSU Research', outlook: 'University-adjacent growth. Clean energy and biotech. Tight supply.' },
  'Bozeman MT': { vacancy: '5.8%', trend: '‚ñº 0.4%', available: '220K SF', avgRent: '$34/SF', topTenants: 'Oracle, Various tech, MSU', outlook: 'Extremely tight. Lifestyle migration driving demand. Very limited Class A.' },
  'Park City UT': { vacancy: '6.2%', trend: '‚ñº 0.3%', available: '180K SF', avgRent: '$48/SF', topTenants: 'Various PE/VC, Skullcandy', outlook: 'Ultra-premium resort office. PE/VC firms and tech executives. Almost no availability.' },
  // National
  'Manhattan NYC': { vacancy: '13.2%', trend: '‚ñº 0.4%', available: '48M SF', avgRent: '$78/SF', topTenants: 'JPMorgan, Goldman Sachs, Meta', outlook: 'Gradual recovery. Flight to quality. Midtown outperforming Downtown.' },
  'Chicago Loop': { vacancy: '19.4%', trend: '‚ñ≤ 0.6%', available: '28M SF', avgRent: '$38/SF', topTenants: 'Boeing, United Airlines, CME Group', outlook: 'Persistent vacancy. Sublease overhang. Some brightening from financial sector expansion.' },
  'Austin TX': { vacancy: '18.6%', trend: '‚ñ≤ 1.2%', available: '12M SF', avgRent: '$48/SF', topTenants: 'Tesla, Apple, Oracle', outlook: 'Oversupply from 2021-22 boom. Absorption slowing. Long-term fundamentals strong.' },
  'Nashville TN': { vacancy: '10.8%', trend: '‚ñº 0.5%', available: '4.2M SF', avgRent: '$38/SF', topTenants: 'AllianceBernstein, Amazon, Oracle', outlook: 'Corporate relocations driving growth. Healthcare anchor stable. Music Row creative office hot.' },
  'Miami Brickell': { vacancy: '7.2%', trend: '‚ñº 0.8%', available: '2.8M SF', avgRent: '$62/SF', topTenants: 'Citadel, Microsoft, Point72', outlook: 'Tightest major market. Financial migration from NYC. Record rents. Supply constrained.' },
  'Dallas Uptown': { vacancy: '15.1%', trend: '‚ñ≤ 0.4%', available: '6.8M SF', avgRent: '$42/SF', topTenants: 'AT&T, CBRE, Various financial', outlook: 'New supply delivering. Corporate relocations offsetting some vacancy. Watch Uptown vs Frisco split.' },
  'Atlanta Midtown': { vacancy: '16.7%', trend: '‚ñ≤ 0.5%', available: '8.4M SF', avgRent: '$36/SF', topTenants: 'NCR Voyix, Honeywell, Various tech', outlook: 'Tech sector pullback affecting demand. Midtown still preferred over Downtown. Sublease competition.' },
  'Boston Seaport': { vacancy: '11.4%', trend: '‚ñº 0.3%', available: '3.8M SF', avgRent: '$68/SF', topTenants: 'Amazon, PTC, Vertex Pharma', outlook: 'Life sciences anchor strong. Some tech softening but biotech resilient. Premium rents hold.' },
  'DC Georgetown': { vacancy: '12.8%', trend: '‚ñº 0.2%', available: '2.4M SF', avgRent: '$58/SF', topTenants: 'Various law firms, Georgetown U', outlook: 'Federal adjacency. Law firms and lobbying. Steady but limited growth.' },
  'San Diego': { vacancy: '9.6%', trend: '‚ñº 0.6%', available: '3.2M SF', avgRent: '$48/SF', topTenants: 'Qualcomm, Illumina, Various biotech', outlook: 'Biotech capital. Very strong life sciences. Defense sector stable. Tight Class A.' }
};

document.querySelectorAll('.heatmap-cell').forEach(cell => {
  cell.style.cursor = 'pointer';
  cell.addEventListener('click', () => {
    const market = cell.querySelector('.heat-market').textContent;
    const d = heatmapDetail[market];
    if (!d) return;
    showModal('Submarket Detail', market,
      detailRow('Vacancy Rate', d.vacancy, parseFloat(d.vacancy) > 15 ? 'var(--red)' : parseFloat(d.vacancy) > 10 ? 'var(--amber)' : 'var(--green)')
      + detailRow('90-Day Trend', d.trend, d.trend.includes('‚ñ≤') ? 'var(--red)' : 'var(--green)')
      + detailRow('Available SF', d.available, 'var(--cream)')
      + detailRow('Avg. Asking Rent', d.avgRent, 'var(--gold)')
      + detailRow('Key Tenants', d.topTenants, 'var(--cream)')
      + `<div style="margin-top:16px;padding:12px;background:var(--surface-2);border:1px solid var(--border);border-radius:6px;font-size:12px;color:var(--text);line-height:1.5;"><strong style="color:var(--cream);">Outlook:</strong> ${d.outlook}</div>`
    );
  });
});

// ‚îÄ‚îÄ‚îÄ MODAL ACTION FUNCTIONS ‚îÄ‚îÄ‚îÄ
function actionSendToLeads() {
  closeModal();
  setTimeout(() => {
    showModal('Outreach Agent', 'Sending to 3 Leads...',
      `<div style="font-size:13px;color:var(--text);line-height:1.6;margin-bottom:16px;">Outreach Agent is personalizing and sending to matched TAMI tenants:</div>`
      + `<div style="margin-bottom:8px;padding:10px 12px;background:var(--green-dim);border:1px solid rgba(74,155,111,0.2);border-radius:6px;"><div style="font-size:12px;color:var(--cream);">‚úì <strong>TechCo Inc.</strong> ‚Äî VP Operations</div><div style="font-size:10px;color:var(--green);margin-top:2px;">Sent ¬∑ Personalized for Playa Vista expansion</div></div>`
      + `<div style="margin-bottom:8px;padding:10px 12px;background:var(--gold-dim);border:1px solid var(--border-gold);border-radius:6px;"><div style="font-size:12px;color:var(--cream);">‚è≥ <strong>WestShore Media</strong> ‚Äî Lisa Tran</div><div style="font-size:10px;color:var(--gold);margin-top:2px;">Personalizing... tailored for content production needs</div></div>`
      + `<div style="margin-bottom:8px;padding:10px 12px;background:var(--surface-2);border:1px solid var(--border);border-radius:6px;"><div style="font-size:12px;color:var(--cream);">‚è≥ <strong>Shopify</strong> ‚Äî Real Estate Team</div><div style="font-size:10px;color:var(--text-dim);margin-top:2px;">Queued ¬∑ Sublease swap pitch</div></div>`
      + `<div style="margin-top:16px;display:flex;gap:8px;">
        <button onclick="closeModal();showToast('All 3 outreach emails sent successfully')" style="flex:1;padding:10px;background:var(--gold);color:#0A0C0E;border:none;border-radius:4px;font-weight:700;font-family:'Syne',sans-serif;font-size:12px;cursor:pointer;">Confirm Send All ‚Üí</button>
        <button onclick="closeModal()" style="flex:1;padding:10px;background:var(--surface-2);border:1px solid var(--border);border-radius:4px;color:var(--text);font-family:'Syne',sans-serif;font-size:12px;cursor:pointer;">Cancel</button>
      </div>`
    );
  }, 200);
}

function actionEditDraft(context) {
  closeModal();
  setTimeout(() => {
    showModal('Outreach Agent', 'Edit Draft ‚Äî ' + (context || 'Outreach'),
      `<div style="font-size:11px;color:var(--text-dim);margin-bottom:8px;">Edit the draft below. Changes auto-save.</div>`
      + `<textarea id="draft-editor" style="width:100%;min-height:200px;padding:14px;background:var(--surface-2);border:1px solid var(--border);border-radius:6px;color:var(--cream);font-family:'JetBrains Mono',monospace;font-size:11px;line-height:1.7;resize:vertical;">Subject: Premium 42K SF ‚Äî 2101 Colorado Ave, Santa Monica\n\nHi [Contact],\n\nA unique opportunity just opened at 2101 Colorado Ave in Santa Monica ‚Äî 42,000 SF of Class A creative office with ocean proximity, previously occupied by Snap Inc.\n\nGiven [Company]'s growth trajectory and West LA focus, this could be an ideal fit. The space features open floor plans, private outdoor terraces, and fiber connectivity.\n\nWould you have 15 minutes this week to discuss?\n\nBest,\n[Your Name]</textarea>`
      + `<div style="display:flex;gap:8px;margin-top:12px;">
        <button onclick="closeModal();showToast('Draft saved successfully')" style="flex:1;padding:10px;background:var(--gold);color:#0A0C0E;border:none;border-radius:4px;font-weight:700;font-family:'Syne',sans-serif;font-size:12px;cursor:pointer;">Save Draft</button>
        <button onclick="actionSendToLeads()" style="flex:1;padding:10px;background:var(--green-dim);border:1px solid rgba(74,155,111,0.2);border-radius:4px;color:var(--green);font-family:'Syne',sans-serif;font-size:12px;cursor:pointer;">Send to Leads ‚Üí</button>
      </div>`
    );
  }, 200);
}

function actionGenerateRedline() {
  closeModal();
  setTimeout(() => {
    showModal('LOI Agent', 'Generating Redline ‚Äî Apex Capital',
      `<div style="font-size:13px;color:var(--text);line-height:1.6;margin-bottom:16px;">LOI Agent is generating a redline document with your preferred language for the 2 flagged clauses.</div>`
      + `<div style="background:var(--surface-2);border:1px solid var(--border);border-radius:8px;padding:16px;font-family:'JetBrains Mono',monospace;font-size:11px;line-height:1.7;">`
      + `<div style="color:var(--gold);margin-bottom:12px;">REDLINE DOCUMENT ¬∑ Generated</div>`
      + `<div style="margin-bottom:12px;"><span style="font-size:9px;color:var(--text-dim);letter-spacing:0.1em;">SECTION 4.2 ‚Äî CO-TENANCY</span><br><span style="color:var(--red);text-decoration:line-through;">Tenant may terminate if anchor tenant vacates >50% of premises.</span><br><span style="color:var(--green);">Tenant shall receive proportional rent abatement if anchor tenant vacates >60% of premises for a continuous period of 12 months. Termination rights excluded.</span></div>`
      + `<div><span style="font-size:9px;color:var(--text-dim);letter-spacing:0.1em;">SECTION 7 ‚Äî ASSIGNMENT</span><br><span style="color:var(--red);text-decoration:line-through;">Unrestricted assignment to affiliates without landlord consent.</span><br><span style="color:var(--green);">Landlord consent required for all assignments. Assignments to affiliates (>50% ownership) require 30-day prior written notice and landlord acknowledgment.</span></div>`
      + `</div>`
      + `<div style="display:flex;gap:8px;margin-top:16px;">
        <button onclick="closeModal();showToast('Redline exported to PDF ‚Äî check your downloads')" style="flex:1;padding:10px;background:var(--gold);color:#0A0C0E;border:none;border-radius:4px;font-weight:700;font-family:'Syne',sans-serif;font-size:12px;cursor:pointer;">Export as PDF</button>
        <button onclick="closeModal();showToast('Redline sent to David Park at Apex Capital')" style="flex:1;padding:10px;background:var(--surface-2);border:1px solid var(--border);border-radius:4px;color:var(--text);font-family:'Syne',sans-serif;font-size:12px;cursor:pointer;">Send to Apex ‚Üí</button>
      </div>`
    );
  }, 200);
}

function actionViewFullLOI() {
  closeModal();
  setTimeout(() => {
    showModal('LOI Agent', 'Full LOI ‚Äî Apex Capital Group',
      `<div style="background:var(--surface-2);border:1px solid var(--border);border-radius:8px;padding:16px;font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--text);line-height:1.8;max-height:400px;overflow-y:auto;">`
      + `<div style="color:var(--gold);font-size:9px;letter-spacing:0.1em;margin-bottom:12px;">LETTER OF INTENT ‚Äî CONFIDENTIAL</div>`
      + `<strong style="color:var(--cream);">Tenant:</strong> Apex Capital Group LLC<br>`
      + `<strong style="color:var(--cream);">Property:</strong> Century Park East, Suite 2800-3200<br>`
      + `<strong style="color:var(--cream);">Premises:</strong> 28,500 RSF (Floors 28-32)<br>`
      + `<strong style="color:var(--cream);">Term:</strong> 10 years, commencing August 1, 2026<br>`
      + `<strong style="color:var(--cream);">Base Rent:</strong> $82.00/SF NNN, 3% annual escalation<br>`
      + `<strong style="color:var(--cream);">TI Allowance:</strong> $95.00/SF<br>`
      + `<strong style="color:var(--cream);">Free Rent:</strong> 6 months<br><br>`
      + `<span style="color:var(--text-dim);">Sec 1. Premises & Use</span><br>General office, financial services...<br><br>`
      + `<span style="color:var(--text-dim);">Sec 2. Rent & Escalation</span><br>Base rent $82/SF NNN with 3% annual bumps...<br><br>`
      + `<span style="color:var(--text-dim);">Sec 3. Tenant Improvements</span><br>$95/SF TI allowance, landlord-managed buildout...<br><br>`
      + `<span style="color:var(--red);">Sec 4.2. Co-Tenancy ‚ö† FLAGGED</span><br>Tenant termination right if anchor vacates >50%...<br><br>`
      + `<span style="color:var(--text-dim);">Sec 5-6. Insurance & Maintenance</span><br>Standard commercial terms...<br><br>`
      + `<span style="color:var(--amber);">Sec 7. Assignment ‚ö† FLAGGED</span><br>Unrestricted affiliate assignment...<br><br>`
      + `<span style="color:var(--text-dim);">Sec 8-12. Standard Provisions</span><br>Default, remedies, subordination, notices...`
      + `</div>`
      + `<div style="display:flex;gap:8px;margin-top:16px;">
        <button onclick="actionGenerateRedline()" style="flex:1;padding:10px;background:var(--gold);color:#0A0C0E;border:none;border-radius:4px;font-weight:700;font-family:'Syne',sans-serif;font-size:12px;cursor:pointer;">Generate Redline ‚Üí</button>
        <button onclick="closeModal();showToast('LOI exported to PDF')" style="flex:1;padding:10px;background:var(--surface-2);border:1px solid var(--border);border-radius:4px;color:var(--text);font-family:'Syne',sans-serif;font-size:12px;cursor:pointer;">Export PDF</button>
      </div>`
    );
  }, 200);
}

function actionDraftOutreach(company, contact) {
  closeModal();
  setTimeout(() => {
    showModal('Outreach Agent', 'Draft Outreach ‚Äî ' + company,
      `<div style="font-size:13px;color:var(--text);line-height:1.6;margin-bottom:12px;">Outreach Agent is generating a personalized pitch for ${company}.</div>`
      + `<textarea id="outreach-editor" style="width:100%;min-height:180px;padding:14px;background:var(--surface-2);border:1px solid var(--border);border-radius:6px;color:var(--cream);font-family:'JetBrains Mono',monospace;font-size:11px;line-height:1.7;resize:vertical;">Subject: Office Space Opportunity ‚Äî Tailored for ${company}\n\nHi ${contact || '[Contact]'},\n\nI'm reaching out because our market intelligence indicates ${company} may be exploring office space options in the LA Metro area.\n\nWe've identified several properties that align with your requirements, including options in high-demand submarkets with competitive terms.\n\nWould you have 15 minutes this week for a quick call to discuss what you're looking for?\n\nBest regards,\n[Your Name]\nLandMarq Intelligence Platform</textarea>`
      + `<div style="display:flex;gap:8px;margin-top:12px;">
        <button onclick="closeModal();showToast('Outreach email sent to ${contact || company}')" style="flex:1;padding:10px;background:var(--gold);color:#0A0C0E;border:none;border-radius:4px;font-weight:700;font-family:'Syne',sans-serif;font-size:12px;cursor:pointer;">Send ‚Üí</button>
        <button onclick="closeModal();showToast('Draft saved for ${company}')" style="flex:1;padding:10px;background:var(--surface-2);border:1px solid var(--border);border-radius:4px;color:var(--text);font-family:'Syne',sans-serif;font-size:12px;cursor:pointer;">Save Draft</button>
      </div>`
    );
  }, 200);
}

function actionAddToPipeline(company, type) {
  closeModal();
  setTimeout(() => {
    showModal('Pipeline', 'Add to Pipeline ‚Äî ' + company,
      `<div style="font-size:13px;color:var(--text);line-height:1.6;margin-bottom:16px;">Creating a new pipeline entry for ${company}.</div>`
      + `<div style="display:flex;flex-direction:column;gap:10px;">`
      + `<div><label style="font-size:10px;color:var(--text-dim);display:block;margin-bottom:4px;">COMPANY</label><input type="text" value="${company}" style="width:100%;padding:8px 12px;background:var(--surface-2);border:1px solid var(--border);border-radius:4px;color:var(--cream);font-family:'Syne',sans-serif;font-size:12px;" /></div>`
      + `<div style="display:flex;gap:8px;"><div style="flex:1;"><label style="font-size:10px;color:var(--text-dim);display:block;margin-bottom:4px;">TYPE</label><input type="text" value="${type || 'New Requirement'}" style="width:100%;padding:8px 12px;background:var(--surface-2);border:1px solid var(--border);border-radius:4px;color:var(--cream);font-family:'Syne',sans-serif;font-size:12px;" /></div><div style="flex:1;"><label style="font-size:10px;color:var(--text-dim);display:block;margin-bottom:4px;">STAGE</label><select style="width:100%;padding:8px 12px;background:var(--surface-2);border:1px solid var(--border);border-radius:4px;color:var(--cream);font-family:'Syne',sans-serif;font-size:12px;"><option>Prospect</option><option>Qualifying</option><option>Proposal</option><option>LOI Signed</option><option>Closing</option></select></div></div>`
      + `<div style="display:flex;gap:8px;"><div style="flex:1;"><label style="font-size:10px;color:var(--text-dim);display:block;margin-bottom:4px;">EST. VALUE</label><input type="text" placeholder="$0M" style="width:100%;padding:8px 12px;background:var(--surface-2);border:1px solid var(--border);border-radius:4px;color:var(--cream);font-family:'Syne',sans-serif;font-size:12px;" /></div><div style="flex:1;"><label style="font-size:10px;color:var(--text-dim);display:block;margin-bottom:4px;">EST. SF</label><input type="text" placeholder="0 SF" style="width:100%;padding:8px 12px;background:var(--surface-2);border:1px solid var(--border);border-radius:4px;color:var(--cream);font-family:'Syne',sans-serif;font-size:12px;" /></div></div>`
      + `<div><label style="font-size:10px;color:var(--text-dim);display:block;margin-bottom:4px;">KEY CONTACT</label><input type="text" placeholder="Name, Title" style="width:100%;padding:8px 12px;background:var(--surface-2);border:1px solid var(--border);border-radius:4px;color:var(--cream);font-family:'Syne',sans-serif;font-size:12px;" /></div>`
      + `</div>`
      + `<div style="display:flex;gap:8px;margin-top:16px;">
        <button onclick="closeModal();showToast('${company} added to pipeline as Prospect')" style="flex:1;padding:10px;background:var(--gold);color:#0A0C0E;border:none;border-radius:4px;font-weight:700;font-family:'Syne',sans-serif;font-size:12px;cursor:pointer;">Add to Pipeline ‚Üí</button>
        <button onclick="closeModal()" style="flex:1;padding:10px;background:var(--surface-2);border:1px solid var(--border);border-radius:4px;color:var(--text);font-family:'Syne',sans-serif;font-size:12px;cursor:pointer;">Cancel</button>
      </div>`
    );
  }, 200);
}

function actionCustomizeNotifications() {
  showModal('Notifications', 'Customize Notifications',
    `<div style="font-size:13px;color:var(--text);line-height:1.6;margin-bottom:16px;">Configure which alerts you receive and how they're delivered.</div>`
    + `<div style="display:flex;flex-direction:column;gap:10px;">`
    + `<div style="display:flex;justify-content:space-between;align-items:center;padding:10px 12px;background:var(--surface-2);border:1px solid var(--border);border-radius:6px;"><div><div style="font-size:13px;color:var(--cream);">High Priority Alerts</div><div style="font-size:10px;color:var(--text-dim);">Vacancy events, LOI flags, closing deadlines</div></div><div onclick="this.classList.toggle('on');this.style.background=this.classList.contains('on')?'var(--gold)':'var(--surface-3)';this.querySelector('div').style.transform=this.classList.contains('on')?'translateX(16px)':'translateX(0)'" class="on" style="width:36px;height:20px;border-radius:10px;background:var(--gold);cursor:pointer;padding:2px;transition:0.2s;"><div style="width:16px;height:16px;border-radius:50%;background:white;transition:0.2s;transform:translateX(16px);"></div></div></div>`
    + `<div style="display:flex;justify-content:space-between;align-items:center;padding:10px 12px;background:var(--surface-2);border:1px solid var(--border);border-radius:6px;"><div><div style="font-size:13px;color:var(--cream);">Medium Priority</div><div style="font-size:10px;color:var(--text-dim);">Expansion signals, rate changes, lead updates</div></div><div onclick="this.classList.toggle('on');this.style.background=this.classList.contains('on')?'var(--gold)':'var(--surface-3)';this.querySelector('div').style.transform=this.classList.contains('on')?'translateX(16px)':'translateX(0)'" class="on" style="width:36px;height:20px;border-radius:10px;background:var(--gold);cursor:pointer;padding:2px;transition:0.2s;"><div style="width:16px;height:16px;border-radius:50%;background:white;transition:0.2s;transform:translateX(16px);"></div></div></div>`
    + `<div style="display:flex;justify-content:space-between;align-items:center;padding:10px 12px;background:var(--surface-2);border:1px solid var(--border);border-radius:6px;"><div><div style="font-size:13px;color:var(--cream);">Intel Updates</div><div style="font-size:10px;color:var(--text-dim);">Market data, comp set changes, zoning</div></div><div onclick="this.classList.toggle('on');this.style.background=this.classList.contains('on')?'var(--gold)':'var(--surface-3)';this.querySelector('div').style.transform=this.classList.contains('on')?'translateX(16px)':'translateX(0)'" class="on" style="width:36px;height:20px;border-radius:10px;background:var(--gold);cursor:pointer;padding:2px;transition:0.2s;"><div style="width:16px;height:16px;border-radius:50%;background:white;transition:0.2s;transform:translateX(16px);"></div></div></div>`
    + `<div style="display:flex;justify-content:space-between;align-items:center;padding:10px 12px;background:var(--surface-2);border:1px solid var(--border);border-radius:6px;"><div><div style="font-size:13px;color:var(--cream);">Email Notifications</div><div style="font-size:10px;color:var(--text-dim);">Send alerts to your email in addition to dashboard</div></div><div onclick="this.classList.toggle('on');this.style.background=this.classList.contains('on')?'var(--gold)':'var(--surface-3)';this.querySelector('div').style.transform=this.classList.contains('on')?'translateX(16px)':'translateX(0)'" style="width:36px;height:20px;border-radius:10px;background:var(--surface-3);cursor:pointer;padding:2px;transition:0.2s;"><div style="width:16px;height:16px;border-radius:50%;background:white;transition:0.2s;"></div></div></div>`
    + `<div style="padding:10px 12px;background:var(--surface-2);border:1px solid var(--border);border-radius:6px;"><div style="font-size:13px;color:var(--cream);margin-bottom:6px;">Quiet Hours</div><div style="display:flex;gap:8px;align-items:center;"><input type="time" value="22:00" style="padding:6px;background:var(--surface-3);border:1px solid var(--border);border-radius:4px;color:var(--cream);font-family:'JetBrains Mono',monospace;font-size:11px;" /><span style="color:var(--text-dim);font-size:11px;">to</span><input type="time" value="06:00" style="padding:6px;background:var(--surface-3);border:1px solid var(--border);border-radius:4px;color:var(--cream);font-family:'JetBrains Mono',monospace;font-size:11px;" /></div></div>`
    + `</div>`
    + `<div style="margin-top:16px;"><button onclick="closeModal();showToast('Notification preferences saved')" style="width:100%;padding:12px;background:var(--gold);color:#0A0C0E;border:none;border-radius:4px;font-weight:700;font-family:'Syne',sans-serif;font-size:13px;cursor:pointer;">Save Notification Preferences</button></div>`
  );
}

// ‚îÄ‚îÄ‚îÄ DEAL ACTION FUNCTIONS ‚îÄ‚îÄ‚îÄ
function actionEditDealDetail(idx) {
  const d = dealDetails[idx] || { name: 'Deal', sub: '', market: '', sf: '', value: '', stage: '', prob: '', close: '', contact: '', notes: '' };
  closeModal();
  setTimeout(() => showModal('Edit Deal', 'Edit ‚Äî ' + d.name,
    `<div style="display:flex;flex-direction:column;gap:10px;">`
    + `<div><label style="font-size:10px;color:var(--text-dim);text-transform:uppercase;letter-spacing:0.1em;">Deal Name</label><input id="ed-name" value="${d.name}" style="width:100%;padding:8px;background:var(--surface-2);border:1px solid var(--border);border-radius:4px;color:var(--cream);font-family:'Syne',sans-serif;font-size:13px;margin-top:4px;" /></div>`
    + `<div style="display:flex;gap:8px;"><div style="flex:1;"><label style="font-size:10px;color:var(--text-dim);text-transform:uppercase;letter-spacing:0.1em;">Market</label><input id="ed-market" value="${d.market}" style="width:100%;padding:8px;background:var(--surface-2);border:1px solid var(--border);border-radius:4px;color:var(--cream);font-family:'Syne',sans-serif;font-size:13px;margin-top:4px;" /></div><div style="flex:1;"><label style="font-size:10px;color:var(--text-dim);text-transform:uppercase;letter-spacing:0.1em;">SF</label><input id="ed-sf" value="${d.sf}" style="width:100%;padding:8px;background:var(--surface-2);border:1px solid var(--border);border-radius:4px;color:var(--cream);font-family:'Syne',sans-serif;font-size:13px;margin-top:4px;" /></div></div>`
    + `<div style="display:flex;gap:8px;"><div style="flex:1;"><label style="font-size:10px;color:var(--text-dim);text-transform:uppercase;letter-spacing:0.1em;">Value</label><input id="ed-value" value="${d.value}" style="width:100%;padding:8px;background:var(--surface-2);border:1px solid var(--border);border-radius:4px;color:var(--cream);font-family:'Syne',sans-serif;font-size:13px;margin-top:4px;" /></div><div style="flex:1;"><label style="font-size:10px;color:var(--text-dim);text-transform:uppercase;letter-spacing:0.1em;">Contact</label><input id="ed-contact" value="${d.contact}" style="width:100%;padding:8px;background:var(--surface-2);border:1px solid var(--border);border-radius:4px;color:var(--cream);font-family:'Syne',sans-serif;font-size:13px;margin-top:4px;" /></div></div>`
    + `<div><label style="font-size:10px;color:var(--text-dim);text-transform:uppercase;letter-spacing:0.1em;">Notes</label><textarea id="ed-notes" rows="3" style="width:100%;padding:8px;background:var(--surface-2);border:1px solid var(--border);border-radius:4px;color:var(--cream);font-family:'Syne',sans-serif;font-size:12px;margin-top:4px;resize:vertical;">${d.notes}</textarea></div>`
    + `<button onclick="dealDetails[${idx}].name=document.getElementById('ed-name').value;dealDetails[${idx}].market=document.getElementById('ed-market').value;dealDetails[${idx}].sf=document.getElementById('ed-sf').value;dealDetails[${idx}].value=document.getElementById('ed-value').value;dealDetails[${idx}].contact=document.getElementById('ed-contact').value;dealDetails[${idx}].notes=document.getElementById('ed-notes').value;closeModal();showToast('Deal updated: '+dealDetails[${idx}].name)" style="width:100%;padding:12px;background:var(--gold);color:#0A0C0E;border:none;border-radius:4px;font-weight:700;font-family:'Syne',sans-serif;font-size:13px;cursor:pointer;">Save Changes</button>`
    + `</div>`
  ), 200);
}

function actionDealFollowUp(idx) {
  const d = dealDetails[idx] || { name: 'Deal', contact: 'Contact', sub: '' };
  closeModal();
  setTimeout(() => showModal('Outreach', 'Draft Follow-Up ‚Äî ' + d.name,
    `<div style="font-size:12px;color:var(--text-dim);margin-bottom:12px;">Auto-generated based on deal history and last interaction.</div>`
    + `<textarea id="followup-draft" rows="10" style="width:100%;padding:12px;background:var(--surface-2);border:1px solid var(--border);border-radius:6px;color:var(--cream);font-family:'JetBrains Mono',monospace;font-size:11px;line-height:1.7;resize:vertical;">Subject: Following Up ‚Äî ${d.name}\n\nHi ${d.contact.split(',')[0] || d.contact},\n\nI wanted to follow up on our conversation regarding ${d.sub || d.name}. Since our last discussion, we've seen continued momentum in the ${d.market || 'local'} market.\n\nA few updates worth noting:\n‚Ä¢ Current market conditions remain favorable for this type of deal\n‚Ä¢ We've identified comparable transactions that support our proposed terms\n‚Ä¢ Timeline remains on track for a ${d.close || 'Q3 2026'} close\n\nWould you have time this week to connect and discuss next steps?\n\nBest regards,\n[Your Name]</textarea>`
    + `<div style="display:flex;gap:8px;margin-top:12px;">`
    + `<button onclick="closeModal();showToast('Follow-up email sent to ${d.contact.split(',')[0] || d.contact}')" style="flex:1;padding:10px;background:var(--gold);color:#0A0C0E;border:none;border-radius:4px;font-weight:700;font-family:'Syne',sans-serif;font-size:12px;cursor:pointer;">Send Email ‚Üí</button>`
    + `<button onclick="closeModal();showToast('Draft saved')" style="flex:1;padding:10px;background:var(--surface-2);border:1px solid var(--border);border-radius:4px;color:var(--text);font-family:'Syne',sans-serif;font-size:12px;cursor:pointer;">Save Draft</button>`
    + `</div>`
  ), 200);
}

function actionUpdateStage(idx) {
  const d = dealDetails[idx] || { name: 'Deal', stage: 'Prospecting', prob: '30%' };
  const stages = ['Prospecting', 'Qualifying', 'Touring', 'LOI', 'Negotiation', 'Closing', 'Won', 'Lost'];
  closeModal();
  setTimeout(() => showModal('Pipeline', 'Update Stage ‚Äî ' + d.name,
    `<div style="display:flex;flex-direction:column;gap:10px;">`
    + `<div><label style="font-size:10px;color:var(--text-dim);text-transform:uppercase;letter-spacing:0.1em;">Current Stage</label><div style="padding:8px 12px;background:var(--surface-2);border:1px solid var(--border);border-radius:4px;color:var(--gold);font-size:13px;margin-top:4px;">${d.stage}</div></div>`
    + `<div><label style="font-size:10px;color:var(--text-dim);text-transform:uppercase;letter-spacing:0.1em;">New Stage</label><select id="new-stage" style="width:100%;padding:8px;background:var(--surface-2);border:1px solid var(--border);border-radius:4px;color:var(--cream);font-family:'Syne',sans-serif;font-size:13px;margin-top:4px;">${stages.map(s => '<option value="'+s+'"'+(s===d.stage?' selected':'')+'>'+s+'</option>').join('')}</select></div>`
    + `<div><label style="font-size:10px;color:var(--text-dim);text-transform:uppercase;letter-spacing:0.1em;">Win Probability (%)</label><input id="new-prob" type="number" min="0" max="100" value="${parseInt(d.prob)}" style="width:100%;padding:8px;background:var(--surface-2);border:1px solid var(--border);border-radius:4px;color:var(--cream);font-family:'Syne',sans-serif;font-size:13px;margin-top:4px;" /></div>`
    + `<div><label style="font-size:10px;color:var(--text-dim);text-transform:uppercase;letter-spacing:0.1em;">Notes</label><textarea id="stage-notes" rows="2" placeholder="Reason for stage change..." style="width:100%;padding:8px;background:var(--surface-2);border:1px solid var(--border);border-radius:4px;color:var(--cream);font-family:'Syne',sans-serif;font-size:12px;margin-top:4px;resize:vertical;"></textarea></div>`
    + `<button onclick="dealDetails[${idx}].stage=document.getElementById('new-stage').value;dealDetails[${idx}].prob=document.getElementById('new-prob').value+'%';closeModal();showToast('Stage updated to '+document.getElementById('new-stage').value)" style="width:100%;padding:12px;background:var(--gold);color:#0A0C0E;border:none;border-radius:4px;font-weight:700;font-family:'Syne',sans-serif;font-size:13px;cursor:pointer;">Update Stage</button>`
    + `</div>`
  ), 200);
}

function actionExportCRM(idx) {
  const d = dealDetails[idx] || { name: 'Deal' };
  closeModal();
  setTimeout(() => showModal('Export', 'Export to CRM ‚Äî ' + d.name,
    `<div style="font-size:13px;color:var(--text);line-height:1.6;margin-bottom:16px;">Select your CRM platform to export this deal record.</div>`
    + `<div style="display:flex;flex-direction:column;gap:8px;margin-bottom:16px;">`
    + `<button onclick="closeModal();showToast('Exporting to Salesforce...')" style="padding:14px;background:var(--surface-2);border:1px solid var(--border);border-radius:6px;color:var(--cream);font-family:'Syne',sans-serif;font-size:13px;cursor:pointer;text-align:left;display:flex;align-items:center;gap:10px;"><span style="font-size:18px;">‚òÅÔ∏è</span> <div><div>Salesforce</div><div style="font-size:10px;color:var(--text-dim);">Create or update Opportunity record</div></div></button>`
    + `<button onclick="closeModal();showToast('Exporting to HubSpot...')" style="padding:14px;background:var(--surface-2);border:1px solid var(--border);border-radius:6px;color:var(--cream);font-family:'Syne',sans-serif;font-size:13px;cursor:pointer;text-align:left;display:flex;align-items:center;gap:10px;"><span style="font-size:18px;">üî∂</span> <div><div>HubSpot</div><div style="font-size:10px;color:var(--text-dim);">Sync deal to HubSpot pipeline</div></div></button>`
    + `<button onclick="closeModal();showToast('Generating CSV export...')" style="padding:14px;background:var(--surface-2);border:1px solid var(--border);border-radius:6px;color:var(--cream);font-family:'Syne',sans-serif;font-size:13px;cursor:pointer;text-align:left;display:flex;align-items:center;gap:10px;"><span style="font-size:18px;">üìÑ</span> <div><div>Export CSV</div><div style="font-size:10px;color:var(--text-dim);">Download deal data as spreadsheet</div></div></button>`
    + `</div>`
  ), 200);
}

function actionAddNote(idx) {
  const d = dealDetails[idx] || { name: 'Deal' };
  closeModal();
  setTimeout(() => showModal('Notes', 'Add Note ‚Äî ' + d.name,
    `<div style="display:flex;flex-direction:column;gap:10px;">`
    + `<div><label style="font-size:10px;color:var(--text-dim);text-transform:uppercase;letter-spacing:0.1em;">Note Type</label><select id="note-type" style="width:100%;padding:8px;background:var(--surface-2);border:1px solid var(--border);border-radius:4px;color:var(--cream);font-family:'Syne',sans-serif;font-size:13px;margin-top:4px;"><option>General Note</option><option>Meeting Notes</option><option>Call Summary</option><option>Document Upload</option><option>Market Intel</option></select></div>`
    + `<div><label style="font-size:10px;color:var(--text-dim);text-transform:uppercase;letter-spacing:0.1em;">Content</label><textarea id="note-content" rows="5" placeholder="Enter your note or paste content..." style="width:100%;padding:8px;background:var(--surface-2);border:1px solid var(--border);border-radius:4px;color:var(--cream);font-family:'Syne',sans-serif;font-size:12px;margin-top:4px;resize:vertical;"></textarea></div>`
    + `<div style="padding:16px;border:2px dashed var(--border);border-radius:6px;text-align:center;cursor:pointer;color:var(--text-dim);font-size:12px;" onclick="document.getElementById('note-file-input').click()">üìé Drop file here or click to upload<input type="file" id="note-file-input" style="display:none;" onchange="this.parentElement.innerHTML='üìé '+this.files[0].name+' attached'" /></div>`
    + `<button onclick="closeModal();showToast('Note added to ${d.name}')" style="width:100%;padding:12px;background:var(--gold);color:#0A0C0E;border:none;border-radius:4px;font-weight:700;font-family:'Syne',sans-serif;font-size:13px;cursor:pointer;">Save Note</button>`
    + `</div>`
  ), 200);
}

function actionArchiveDeal(idx) {
  const d = dealDetails[idx] || { name: 'Deal' };
  closeModal();
  setTimeout(() => showModal('Archive', 'Archive Deal ‚Äî ' + d.name,
    `<div style="padding:16px;background:var(--red-dim);border:1px solid rgba(192,83,58,0.2);border-radius:8px;margin-bottom:16px;">`
    + `<div style="font-size:14px;color:var(--red);font-weight:600;margin-bottom:6px;">‚ö† Confirm Archive</div>`
    + `<div style="font-size:13px;color:var(--text);line-height:1.6;">This will move <strong style="color:var(--cream);">${d.name}</strong> to the archived deals folder. You can restore it later from Settings ‚Üí Archived Deals.</div>`
    + `</div>`
    + `<div><label style="font-size:10px;color:var(--text-dim);text-transform:uppercase;letter-spacing:0.1em;">Reason for Archiving</label><select id="archive-reason" style="width:100%;padding:8px;background:var(--surface-2);border:1px solid var(--border);border-radius:4px;color:var(--cream);font-family:'Syne',sans-serif;font-size:13px;margin-top:4px;"><option>Deal Lost</option><option>Client Unresponsive</option><option>Budget/Timing Issue</option><option>Went with Competitor</option><option>Duplicate Entry</option><option>Other</option></select></div>`
    + `<div style="display:flex;gap:8px;margin-top:16px;">`
    + `<button onclick="closeModal();showToast('${d.name} archived')" style="flex:1;padding:12px;background:var(--red);color:white;border:none;border-radius:4px;font-weight:700;font-family:'Syne',sans-serif;font-size:13px;cursor:pointer;">Archive Deal</button>`
    + `<button onclick="closeModal()" style="flex:1;padding:12px;background:var(--surface-2);border:1px solid var(--border);border-radius:4px;color:var(--text);font-family:'Syne',sans-serif;font-size:13px;cursor:pointer;">Cancel</button>`
    + `</div>`
  ), 200);
}

// ‚îÄ‚îÄ‚îÄ AGENT FEED EXTRA ACTIONS ‚îÄ‚îÄ‚îÄ
function actionDraftOutreachAll(companies, context) {
  closeModal();
  setTimeout(() => showModal('Outreach Agent', 'Batch Outreach ‚Äî ' + context,
    `<div style="font-size:13px;color:var(--text);line-height:1.6;margin-bottom:16px;">Generating personalized outreach for ${companies.length} matching tenants regarding <strong style="color:var(--gold);">${context}</strong>.</div>`
    + companies.map((c, i) => `<div style="padding:12px;background:var(--surface-2);border:1px solid var(--border);border-radius:6px;margin-bottom:8px;"><div style="display:flex;justify-content:space-between;align-items:center;"><div style="font-size:13px;color:var(--cream);font-weight:600;">${c}</div><div style="font-size:10px;color:var(--green);">‚óè Draft Ready</div></div><div style="font-size:11px;color:var(--text-dim);margin-top:4px;">Personalized pitch based on company profile and space requirements</div><div style="margin-top:6px;"><button onclick="actionEditDraft('${c} ‚Äî ${context}')" style="padding:6px 12px;background:var(--surface-3);border:1px solid var(--border);border-radius:4px;color:var(--cream);font-family:'Syne',sans-serif;font-size:10px;cursor:pointer;">Preview & Edit</button></div></div>`).join('')
    + `<div style="display:flex;gap:8px;margin-top:12px;">`
    + `<button onclick="closeModal();showToast('Sending outreach to ${companies.length} leads...')" style="flex:1;padding:12px;background:var(--gold);color:#0A0C0E;border:none;border-radius:4px;font-weight:700;font-family:'Syne',sans-serif;font-size:13px;cursor:pointer;">Send All ${companies.length} Drafts ‚Üí</button>`
    + `<button onclick="closeModal()" style="padding:12px;background:var(--surface-2);border:1px solid var(--border);border-radius:4px;color:var(--text);font-family:'Syne',sans-serif;font-size:13px;cursor:pointer;">Cancel</button>`
    + `</div>`
  ), 200);
}

function actionViewProperty(address, city, sf, type, rent) {
  closeModal();
  setTimeout(() => showModal('Property Intel', address + ' ¬∑ ' + city,
    `<div style="background:var(--surface-2);border:1px solid var(--border);border-radius:8px;padding:16px;margin-bottom:12px;">`
    + `<div style="font-family:'JetBrains Mono',monospace;font-size:9px;color:var(--gold);letter-spacing:0.1em;margin-bottom:10px;">PROPERTY DETAILS</div>`
    + detailRow('Address', address + ', ' + city, 'var(--cream)')
    + detailRow('Size', sf, 'var(--cream)')
    + detailRow('Type', type, 'var(--cream)')
    + detailRow('Asking Rent', rent, 'var(--gold)')
    + detailRow('Year Built', '2018', 'var(--text-mid)')
    + detailRow('Parking', '3.5/1,000 SF', 'var(--text-mid)')
    + detailRow('Zoning', 'C-2 Commercial', 'var(--text-mid)')
    + `</div>`
    + `<div style="font-family:'JetBrains Mono',monospace;font-size:9px;color:var(--text-dim);letter-spacing:0.1em;margin-bottom:8px;">COMPARABLE TRANSACTIONS</div>`
    + `<div style="padding:8px 10px;background:var(--surface-2);border:1px solid var(--border);border-radius:4px;font-size:11px;color:var(--cream);margin-bottom:4px;">2200 Colorado Ave ‚Äî $68/SF NNN ¬∑ 38K SF ¬∑ Q4 2025</div>`
    + `<div style="padding:8px 10px;background:var(--surface-2);border:1px solid var(--border);border-radius:4px;font-size:11px;color:var(--cream);margin-bottom:12px;">1520 2nd St ‚Äî $74/SF NNN ¬∑ 28K SF ¬∑ Q1 2026</div>`
    + `<div style="display:flex;gap:8px;"><button onclick="actionDraftOutreachAll(['TechCo Inc.','WestShore Media','Shopify'],'${address}')" style="flex:1;padding:10px;background:var(--gold);color:#0A0C0E;border:none;border-radius:4px;font-weight:700;font-family:'Syne',sans-serif;font-size:12px;cursor:pointer;">Draft Outreach ‚Üí</button><button onclick="actionAddToPipeline('${address}','Vacancy ¬∑ ${type}')" style="flex:1;padding:10px;background:var(--surface-2);border:1px solid var(--border);border-radius:4px;color:var(--text);font-family:'Syne',sans-serif;font-size:12px;cursor:pointer;">Add to Pipeline</button></div>`
  ), 200);
}

function actionViewFiling(address, type, conversion) {
  closeModal();
  setTimeout(() => showModal('Permit Agent', 'Filing ‚Äî ' + address,
    `<div style="background:var(--surface-2);border:1px solid var(--border);border-radius:8px;padding:16px;margin-bottom:12px;">`
    + `<div style="font-family:'JetBrains Mono',monospace;font-size:9px;color:var(--gold);letter-spacing:0.1em;margin-bottom:10px;">ZONING VARIANCE FILING</div>`
    + detailRow('Address', address, 'var(--cream)')
    + detailRow('Filing Type', type, 'var(--cream)')
    + detailRow('Proposed Change', conversion, 'var(--amber)')
    + detailRow('Filing Date', 'Feb 23, 2026', 'var(--text-mid)')
    + detailRow('Public Hearing', 'Mar 15, 2026 (est.)', 'var(--cream)')
    + detailRow('Case Number', 'ZV-2026-00847-DTLA', 'var(--text-mid)')
    + `</div>`
    + `<div style="font-family:'JetBrains Mono',monospace;font-size:9px;color:var(--text-dim);letter-spacing:0.1em;margin-bottom:8px;">IMPACT ANALYSIS</div>`
    + `<div style="padding:12px;background:var(--surface-2);border:1px solid var(--border);border-radius:6px;font-size:12px;color:var(--text);line-height:1.6;margin-bottom:12px;">This conversion removes 180,000 SF of Class B office inventory from DTLA. Combined with 3 other pending conversions, total projected removal is ~420K SF by 2027, potentially tightening vacancy rates from 22.1% to 19.4%.</div>`
    + `<div style="display:flex;gap:8px;"><button onclick="closeModal();showToast('Filing exported as PDF')" style="flex:1;padding:10px;background:var(--gold);color:#0A0C0E;border:none;border-radius:4px;font-weight:700;font-family:'Syne',sans-serif;font-size:12px;cursor:pointer;">Export Report</button><button onclick="actionTrackProperty('${address}','DTLA','180,000 SF')" style="flex:1;padding:10px;background:var(--surface-2);border:1px solid var(--border);border-radius:4px;color:var(--text);font-family:'Syne',sans-serif;font-size:12px;cursor:pointer;">Track Property</button></div>`
  ), 200);
}

function actionTrackProperty(address, market, sf) {
  closeModal();
  setTimeout(() => showModal('Tracking', 'Track Property ‚Äî ' + address,
    `<div style="font-size:13px;color:var(--text);line-height:1.6;margin-bottom:16px;">Set up monitoring alerts for <strong style="color:var(--cream);">${address}</strong>.</div>`
    + `<div style="display:flex;flex-direction:column;gap:8px;margin-bottom:16px;">`
    + `<label style="padding:10px 12px;background:var(--surface-2);border:1px solid var(--border);border-radius:6px;display:flex;align-items:center;gap:8px;cursor:pointer;font-size:12px;color:var(--cream);"><input type="checkbox" checked style="accent-color:var(--gold);" /> Permit & Zoning Changes</label>`
    + `<label style="padding:10px 12px;background:var(--surface-2);border:1px solid var(--border);border-radius:6px;display:flex;align-items:center;gap:8px;cursor:pointer;font-size:12px;color:var(--cream);"><input type="checkbox" checked style="accent-color:var(--gold);" /> Ownership Transfers</label>`
    + `<label style="padding:10px 12px;background:var(--surface-2);border:1px solid var(--border);border-radius:6px;display:flex;align-items:center;gap:8px;cursor:pointer;font-size:12px;color:var(--cream);"><input type="checkbox" checked style="accent-color:var(--gold);" /> Lease Expirations</label>`
    + `<label style="padding:10px 12px;background:var(--surface-2);border:1px solid var(--border);border-radius:6px;display:flex;align-items:center;gap:8px;cursor:pointer;font-size:12px;color:var(--cream);"><input type="checkbox" style="accent-color:var(--gold);" /> Comp Set Updates</label>`
    + `<label style="padding:10px 12px;background:var(--surface-2);border:1px solid var(--border);border-radius:6px;display:flex;align-items:center;gap:8px;cursor:pointer;font-size:12px;color:var(--cream);"><input type="checkbox" style="accent-color:var(--gold);" /> Construction Activity</label>`
    + `</div>`
    + `<button onclick="closeModal();showToast('Now tracking ${address}')" style="width:100%;padding:12px;background:var(--gold);color:#0A0C0E;border:none;border-radius:4px;font-weight:700;font-family:'Syne',sans-serif;font-size:13px;cursor:pointer;">Start Tracking</button>`
  ), 200);
}

function actionEditOutreachParams(company, contact, deal) {
  closeModal();
  setTimeout(() => showModal('Outreach Config', 'Edit Parameters ‚Äî ' + company,
    `<div style="display:flex;flex-direction:column;gap:10px;">`
    + `<div><label style="font-size:10px;color:var(--text-dim);text-transform:uppercase;letter-spacing:0.1em;">Target Company</label><input value="${company}" style="width:100%;padding:8px;background:var(--surface-2);border:1px solid var(--border);border-radius:4px;color:var(--cream);font-family:'Syne',sans-serif;font-size:13px;margin-top:4px;" /></div>`
    + `<div><label style="font-size:10px;color:var(--text-dim);text-transform:uppercase;letter-spacing:0.1em;">Primary Contact</label><input value="${contact}" style="width:100%;padding:8px;background:var(--surface-2);border:1px solid var(--border);border-radius:4px;color:var(--cream);font-family:'Syne',sans-serif;font-size:13px;margin-top:4px;" /></div>`
    + `<div><label style="font-size:10px;color:var(--text-dim);text-transform:uppercase;letter-spacing:0.1em;">Deal Context</label><input value="${deal}" style="width:100%;padding:8px;background:var(--surface-2);border:1px solid var(--border);border-radius:4px;color:var(--cream);font-family:'Syne',sans-serif;font-size:13px;margin-top:4px;" /></div>`
    + `<div><label style="font-size:10px;color:var(--text-dim);text-transform:uppercase;letter-spacing:0.1em;">Tone</label><select style="width:100%;padding:8px;background:var(--surface-2);border:1px solid var(--border);border-radius:4px;color:var(--cream);font-family:'Syne',sans-serif;font-size:13px;margin-top:4px;"><option>Professional</option><option>Warm / Relationship</option><option>Urgent / Time-Sensitive</option><option>Data-Driven</option></select></div>`
    + `<div><label style="font-size:10px;color:var(--text-dim);text-transform:uppercase;letter-spacing:0.1em;">Key Selling Points</label><textarea rows="3" placeholder="e.g., production-adjacent, creative office, fiber connectivity..." style="width:100%;padding:8px;background:var(--surface-2);border:1px solid var(--border);border-radius:4px;color:var(--cream);font-family:'Syne',sans-serif;font-size:12px;margin-top:4px;resize:vertical;"></textarea></div>`
    + `<button onclick="closeModal();showToast('Parameters updated ‚Äî regenerating draft...')" style="width:100%;padding:12px;background:var(--gold);color:#0A0C0E;border:none;border-radius:4px;font-weight:700;font-family:'Syne',sans-serif;font-size:13px;cursor:pointer;">Regenerate Draft</button>`
    + `</div>`
  ), 200);
}

function showNotificationsPanel() {
  showModal('Notifications', '7 Unread Notifications',
    `<div style="display:flex;flex-direction:column;gap:8px;margin-bottom:16px;">`
    + `<div style="padding:10px 12px;background:var(--red-dim);border:1px solid rgba(192,83,58,0.2);border-radius:6px;cursor:pointer;" onclick="closeModal();document.querySelector('.alert-action-btn')?.click()"><div style="font-size:12px;font-weight:600;color:var(--cream);">‚ö° Snap vacating 42K SF ‚Äî Santa Monica</div><div style="font-size:10px;color:var(--text-dim);margin-top:2px;">2 min ago ¬∑ Intel Agent ¬∑ Click to take action</div></div>`
    + `<div style="padding:10px 12px;background:var(--red-dim);border:1px solid rgba(192,83,58,0.2);border-radius:6px;cursor:pointer;" onclick="closeModal()"><div style="font-size:12px;font-weight:600;color:var(--cream);">üìã LOI Clause Mismatch ‚Äî Apex Capital</div><div style="font-size:10px;color:var(--text-dim);margin-top:2px;">31 min ago ¬∑ LOI Agent</div></div>`
    + `<div style="padding:10px 12px;background:var(--gold-dim);border:1px solid var(--border-gold);border-radius:6px;cursor:pointer;" onclick="closeModal()"><div style="font-size:12px;font-weight:600;color:var(--cream);">üéØ TechCo Expansion Signal</div><div style="font-size:10px;color:var(--text-dim);margin-top:2px;">14 min ago ¬∑ Lead Agent</div></div>`
    + `<div style="padding:10px 12px;background:var(--surface-2);border:1px solid var(--border);border-radius:6px;cursor:pointer;" onclick="closeModal()"><div style="font-size:12px;font-weight:600;color:var(--cream);">üìà Interest Rate Watch Triggered</div><div style="font-size:10px;color:var(--text-dim);margin-top:2px;">1h ago ¬∑ Macro Agent</div></div>`
    + `<div style="padding:10px 12px;background:var(--surface-2);border:1px solid var(--border);border-radius:6px;cursor:pointer;" onclick="closeModal()"><div style="font-size:12px;font-weight:600;color:var(--cream);">üîç Playa Vista Occupancy Up</div><div style="font-size:10px;color:var(--text-dim);margin-top:2px;">4h ago ¬∑ Intel Agent</div></div>`
    + `</div>`
    + `<div style="display:flex;gap:8px;">
      <button onclick="closeModal();showToast('All notifications marked as read')" style="flex:1;padding:10px;background:var(--surface-2);border:1px solid var(--border);border-radius:4px;color:var(--text);font-family:'Syne',sans-serif;font-size:11px;cursor:pointer;">Mark All Read</button>
      <button onclick="closeModal();actionCustomizeNotifications()" style="flex:1;padding:10px;background:var(--gold);color:#0A0C0E;border:none;border-radius:4px;font-weight:700;font-family:'Syne',sans-serif;font-size:11px;cursor:pointer;">Customize Notifications ‚öô</button>
    </div>`
  );
}

// ‚îÄ‚îÄ‚îÄ ALERT ACTION BUTTON CLICKS ‚îÄ‚îÄ‚îÄ
document.querySelectorAll('.alert-action-btn').forEach(btn => {
  btn.style.cursor = 'pointer';
  btn.addEventListener('click', (e) => {
    e.stopPropagation();
    const text = btn.textContent.trim();
    if (text.includes('Draft Outreach')) {
      showModal('Outreach Agent', 'Draft Outreach ‚Äî Snap Inc. Space',
        `<div style="font-size:13px;color:var(--text);line-height:1.6;margin-bottom:16px;">Your Outreach Agent is drafting a personalized pitch targeting TAMI tenants for the 42K SF vacancy at 2101 Colorado Ave, Santa Monica.</div>`
        + `<div style="background:var(--surface-2);border:1px solid var(--border);border-radius:8px;padding:16px;font-family:'JetBrains Mono',monospace;font-size:11px;color:var(--text);line-height:1.7;">`
        + `<div style="color:var(--gold);margin-bottom:8px;">DRAFT ¬∑ Generated</div>`
        + `Subject: Premium 42K SF ‚Äî 2101 Colorado Ave, Santa Monica<br><br>`
        + `Hi [Contact],<br><br>`
        + `A unique opportunity just opened at 2101 Colorado Ave in Santa Monica ‚Äî 42,000 SF of Class A creative office with ocean proximity, previously occupied by Snap Inc.<br><br>`
        + `Given [Company]'s growth trajectory and West LA focus, this could be an ideal fit. The space features open floor plans, private outdoor terraces, and fiber connectivity.<br><br>`
        + `Would you have 15 minutes this week to discuss?<br><br>`
        + `Best,<br>[Your Name]`
        + `</div>`
        + `<div style="display:flex;gap:8px;margin-top:16px;"><button onclick="actionSendToLeads()" style="flex:1;padding:10px;background:var(--gold);color:#0A0C0E;border:none;border-radius:4px;font-weight:700;font-family:'Syne',sans-serif;font-size:12px;cursor:pointer;">Send to 3 Leads ‚Üí</button><button onclick="actionEditDraft('Snap Inc. Space')" style="flex:1;padding:10px;background:var(--surface-2);border:1px solid var(--border);border-radius:4px;color:var(--text);font-family:'Syne',sans-serif;font-size:12px;cursor:pointer;">Edit Draft</button></div>`
      );
    } else if (text.includes('Review Comparison')) {
      showModal('LOI Agent', 'Clause Comparison ‚Äî Apex Capital',
        `<div style="font-size:13px;color:var(--text);line-height:1.6;margin-bottom:16px;">LOI Agent flagged 2 non-standard clauses in the Apex Capital draft vs. your gold standard template.</div>`
        + `<div style="background:var(--red-dim);border:1px solid rgba(192,83,58,0.2);border-radius:8px;padding:14px;margin-bottom:10px;">`
        + `<div style="font-size:12px;font-weight:600;color:var(--cream);margin-bottom:6px;">‚ö† Section 4.2 ‚Äî Co-Tenancy Clause</div>`
        + `<div style="font-size:11px;color:var(--text);line-height:1.5;"><strong style="color:var(--red);">Their version:</strong> Tenant may terminate if anchor tenant vacates >50% of premises.<br><strong style="color:var(--green);">Your standard:</strong> No co-tenancy termination rights. Rent abatement only if >60% vacant for 12+ months.</div></div>`
        + `<div style="background:var(--gold-dim);border:1px solid var(--border-gold);border-radius:8px;padding:14px;margin-bottom:10px;">`
        + `<div style="font-size:12px;font-weight:600;color:var(--cream);margin-bottom:6px;">‚ö† Section 7 ‚Äî Assignment Rights</div>`
        + `<div style="font-size:11px;color:var(--text);line-height:1.5;"><strong style="color:var(--amber);">Their version:</strong> Unrestricted assignment to affiliates without landlord consent.<br><strong style="color:var(--green);">Your standard:</strong> Landlord consent required for all assignments; affiliates require 30-day notice.</div></div>`
        + `<div style="display:flex;gap:8px;margin-top:16px;"><button onclick="actionGenerateRedline()" style="flex:1;padding:10px;background:var(--gold);color:#0A0C0E;border:none;border-radius:4px;font-weight:700;font-family:'Syne',sans-serif;font-size:12px;cursor:pointer;">Generate Redline ‚Üí</button><button onclick="actionViewFullLOI()" style="flex:1;padding:10px;background:var(--surface-2);border:1px solid var(--border);border-radius:4px;color:var(--text);font-family:'Syne',sans-serif;font-size:12px;cursor:pointer;">View Full LOI</button></div>`
      );
    } else if (text.includes('Lead Profile')) {
      showModal('Lead Agent', 'Lead Profile ‚Äî TechCo Inc.',
        `<div style="display:flex;gap:16px;margin-bottom:16px;"><div style="width:48px;height:48px;border-radius:8px;background:var(--gold-dim);border:1px solid var(--border-gold);display:flex;align-items:center;justify-content:center;font-size:18px;flex-shrink:0;">üéØ</div><div><div style="font-size:16px;font-weight:600;color:var(--cream);">TechCo Inc.</div><div style="font-size:12px;color:var(--text-mid);">Series C ¬∑ SaaS ¬∑ 200-500 employees</div></div></div>`
        + detailRow('Signal Strength', '‚óè Very High', 'var(--green)')
        + detailRow('LA Job Postings (30d)', '40+', 'var(--gold)')
        + detailRow('WeWork Badge-In Œî', '+62% MoM', 'var(--green)')
        + detailRow('Est. Space Need', '15,000 ‚Äì 25,000 SF', 'var(--cream)')
        + detailRow('Preferred Submarkets', 'Playa Vista, Culver City', 'var(--cream)')
        + detailRow('Timeline', 'Q3 2026 (estimated)', 'var(--text-mid)')
        + `<div style="margin-top:16px;padding:12px;background:var(--surface-2);border:1px solid var(--border);border-radius:6px;font-size:12px;color:var(--text);line-height:1.5;"><strong style="color:var(--cream);">Agent Notes:</strong> High-growth SaaS company currently in flex space at WeWork Playa Vista. Rapid headcount growth suggests they'll outgrow current location within 6 months. Key decision-maker: VP of Operations.</div>`
        + `<div style="display:flex;gap:8px;margin-top:16px;"><button onclick="actionDraftOutreach('TechCo Inc.','VP Operations')" style="flex:1;padding:10px;background:var(--gold);color:#0A0C0E;border:none;border-radius:4px;font-weight:700;font-family:'Syne',sans-serif;font-size:12px;cursor:pointer;">Draft Outreach ‚Üí</button><button onclick="actionAddToPipeline('TechCo Inc.','New Requirement ¬∑ SaaS')" style="flex:1;padding:10px;background:var(--surface-2);border:1px solid var(--border);border-radius:4px;color:var(--text);font-family:'Syne',sans-serif;font-size:12px;cursor:pointer;">Add to Pipeline</button></div>`
      );
    } else if (text.includes('Impact Report')) {
      showModal('Macro Agent', 'Interest Rate Impact Analysis',
        `<div style="font-size:13px;color:var(--text);line-height:1.6;margin-bottom:16px;">Fed signaled a pause. Model projects cap rate compression across West Coast CRE over the next 90 days.</div>`
        + detailRow('Fed Funds Rate', '4.25% (hold)', 'var(--cream)')
        + detailRow('10Y Treasury', '3.82% (‚ñº 12bps)', 'var(--green)')
        + detailRow('Office Cap Rate Œî', '-15bps projected', 'var(--green)')
        + detailRow('Industrial Cap Rate Œî', '-25bps projected', 'var(--green)')
        + detailRow('Retail Cap Rate Œî', '-8bps projected', 'var(--text-mid)')
        + `<div style="margin-top:16px;padding:12px;background:var(--green-dim);border:1px solid rgba(74,155,111,0.2);border-radius:6px;font-size:12px;color:var(--green);line-height:1.5;">Implication: Asset values could increase 2-4% in industrial over 90 days. Consider accelerating Burbank deal timeline.</div>`
        + `<div style="display:flex;gap:8px;margin-top:16px;"><button onclick="closeModal();showToast('Impact report exported to PDF')" style="flex:1;padding:10px;background:var(--gold);color:#0A0C0E;border:none;border-radius:4px;font-weight:700;font-family:'Syne',sans-serif;font-size:12px;cursor:pointer;">Export Report</button><button onclick="closeModal();switchView('market-intel')" style="flex:1;padding:10px;background:var(--surface-2);border:1px solid var(--border);border-radius:4px;color:var(--text);font-family:'Syne',sans-serif;font-size:12px;cursor:pointer;">Full Market Intel ‚Üí</button></div>`
      );
    } else if (text.includes('Submarket Data')) {
      showModal('Intel Agent', 'Playa Vista ‚Äî Submarket Deep Dive',
        `<div style="font-size:13px;color:var(--text);line-height:1.6;margin-bottom:16px;">Playa Vista is showing strong occupancy recovery. Badge-in data indicates a tenant preference shift away from DTLA toward creative/tech corridors.</div>`
        + `<div style="background:var(--surface-2);border:1px solid var(--border);border-radius:8px;padding:16px;margin-bottom:12px;">`
        + `<div style="font-family:'JetBrains Mono',monospace;font-size:9px;color:var(--gold);letter-spacing:0.1em;margin-bottom:10px;">SUBMARKET METRICS</div>`
        + detailRow('Current Vacancy', '8.1%', 'var(--green)')
        + detailRow('90-Day Trend', '‚ñº 0.9%', 'var(--green)')
        + detailRow('Badge-In Occupancy', '74%', 'var(--green)')
        + detailRow('DTLA Comparison', '61% (gap widening)', 'var(--red)')
        + detailRow('Avg. Asking Rent', '$68/SF NNN', 'var(--gold)')
        + detailRow('Available Spaces', '12 (‚ñº 3 MoM)', 'var(--cream)')
        + `</div>`
        + detailRow('Key Tenants', 'Google, YouTube, IMAX, Fullscreen', 'var(--cream)')
        + detailRow('Active Searches', '4 tenants, 15K‚Äì40K SF combined', 'var(--gold)')
        + `<div style="margin-top:12px;padding:10px;background:var(--gold-dim);border:1px solid var(--border-gold);border-radius:6px;font-size:12px;color:var(--gold);">Recommendation: Position Playa Vista as primary alternative for DTLA-averse TAMI tenants.</div>`
        + `<div style="display:flex;gap:8px;margin-top:12px;"><button onclick="closeModal();showToast('Playa Vista report exported')" style="flex:1;padding:10px;background:var(--gold);color:#0A0C0E;border:none;border-radius:4px;font-weight:700;font-family:'Syne',sans-serif;font-size:12px;cursor:pointer;">Export Report</button><button onclick="closeModal();switchView('west-coast-report')" style="flex:1;padding:10px;background:var(--surface-2);border:1px solid var(--border);border-radius:4px;color:var(--text);font-family:'Syne',sans-serif;font-size:12px;cursor:pointer;">Full West Coast Report ‚Üí</button></div>`
      );
    } else if (text.includes('Comp Set')) {
      showModal('Intel Agent', 'Santa Monica ‚Äî Updated Comp Set',
        `<div style="font-size:13px;color:var(--text);line-height:1.6;margin-bottom:16px;">CBRE closed 18,500 SF at Water Garden. Updated comparable availabilities:</div>`
        + `<div style="background:var(--surface-2);border:1px solid var(--border);border-radius:8px;padding:16px;margin-bottom:10px;">`
        + detailRow('Water Garden (CLOSED)', '18,500 SF ¬∑ $72/SF NNN', 'var(--text-dim)')
        + `</div>`
        + `<div style="font-family:'JetBrains Mono',monospace;font-size:9px;color:var(--gold);letter-spacing:0.1em;margin:12px 0 8px;">REMAINING COMPARABLES</div>`
        + `<div style="background:var(--surface-2);border:1px solid var(--border);border-radius:8px;padding:16px;margin-bottom:8px;">`
        + detailRow('Colorado Center', '24,000 SF ¬∑ $74/SF NNN', 'var(--cream)')
        + detailRow('Status', 'Available ¬∑ Tour ready', 'var(--green)')
        + `</div>`
        + `<div style="background:var(--surface-2);border:1px solid var(--border);border-radius:8px;padding:16px;margin-bottom:8px;">`
        + detailRow('Gateway', '15,200 SF ¬∑ $68/SF NNN', 'var(--cream)')
        + detailRow('Status', 'Available ¬∑ Sub-listing', 'var(--amber)')
        + `</div>`
        + `<div style="background:var(--surface-2);border:1px solid var(--border);border-radius:8px;padding:16px;margin-bottom:12px;">`
        + detailRow('The Brickyard', '9,800 SF ¬∑ $65/SF NNN', 'var(--cream)')
        + detailRow('Status', 'Under negotiation', 'var(--red)')
        + `</div>`
        + `<div style="padding:10px;background:var(--gold-dim);border:1px solid var(--border-gold);border-radius:6px;font-size:12px;color:var(--gold);">SM inventory tightening ‚Äî 3 remaining vs. 4 last month.</div>`
        + `<div style="display:flex;gap:8px;margin-top:12px;"><button onclick="closeModal();showToast('Comp set exported to CSV')" style="flex:1;padding:10px;background:var(--gold);color:#0A0C0E;border:none;border-radius:4px;font-weight:700;font-family:'Syne',sans-serif;font-size:12px;cursor:pointer;">Export Comps</button><button onclick="closeModal();switchView('submarket-tracker')" style="flex:1;padding:10px;background:var(--surface-2);border:1px solid var(--border);border-radius:4px;color:var(--text);font-family:'Syne',sans-serif;font-size:12px;cursor:pointer;">Submarket Tracker ‚Üí</button></div>`
      );
    }
  });
});

// ‚îÄ‚îÄ‚îÄ ALERT ITEM CLICKS (with next-step workflows) ‚îÄ‚îÄ‚îÄ
const alertWorkflows = [
  { // Snap vacating - High
    title: 'Snap Vacating 42K SF ‚Äî Santa Monica', steps: [
      { label: 'Review Intel Report', status: 'done', desc: 'Agent identified vacancy + 3 matching tenants' },
      { label: 'Draft Outreach to Matching Tenants', status: 'ready', desc: 'Send personalized pitches to TechCo, WestShore, Shopify' },
      { label: 'Schedule Property Tour', status: 'upcoming', desc: 'Coordinate walkthroughs with interested tenants' },
      { label: 'Submit Proposals', status: 'upcoming', desc: 'Prepare competitive proposals for shortlisted tenants' }
    ]
  },
  { // LOI Mismatch - High
    title: 'LOI Clause Mismatch ‚Äî Apex Capital', steps: [
      { label: 'LOI Agent Reviewed Document', status: 'done', desc: 'Flagged 2 non-standard clauses (Sec 4.2 & 7)' },
      { label: 'Review Clause Comparison', status: 'ready', desc: 'Compare their terms against your gold standard' },
      { label: 'Generate Redline', status: 'upcoming', desc: 'Auto-generate redline with your preferred language' },
      { label: 'Send Counter to Apex Capital', status: 'upcoming', desc: 'Deliver revised LOI to David Park, COO' }
    ]
  },
  { // TechCo - Medium
    title: 'TechCo Inc. Expansion Signal', steps: [
      { label: 'Lead Agent Identified Signal', status: 'done', desc: '40+ job postings, WeWork badge-in +62%' },
      { label: 'Review Lead Profile', status: 'ready', desc: 'Confirm company details and space requirements' },
      { label: 'Draft Personalized Outreach', status: 'upcoming', desc: 'Reach VP of Operations with tailored pitch' },
      { label: 'Add to Pipeline', status: 'upcoming', desc: 'Create deal record and assign to tracking' }
    ]
  },
  { // Interest Rate - Medium
    title: 'Interest Rate Watch Triggered', steps: [
      { label: 'Macro Agent Detected Fed Signal', status: 'done', desc: 'Fed pause ‚Üí cap rate compression projected' },
      { label: 'Review Impact Analysis', status: 'ready', desc: 'See projected cap rate changes by sector' },
      { label: 'Adjust Deal Timelines', status: 'upcoming', desc: 'Consider accelerating Burbank deal' },
      { label: 'Update Client Advisory', status: 'upcoming', desc: 'Brief clients on rate environment shift' }
    ]
  },
  { // Playa Vista - Low
    title: 'Playa Vista Occupancy Up', steps: [
      { label: 'Intel Agent Reported', status: 'done', desc: 'Badge-in 74% vs 61% DTLA ‚Äî preference shift' },
      { label: 'Review Submarket Data', status: 'ready', desc: 'Deep-dive into Playa Vista metrics' }
    ]
  },
  { // CBRE closed - Low
    title: 'CBRE Deal Closed ‚Äî Water Garden', steps: [
      { label: 'Intel Agent Reported', status: 'done', desc: '18,500 SF closed. 3 remaining comparables in SM.' },
      { label: 'Update Comp Set', status: 'ready', desc: 'Refresh comparable listings for Santa Monica' }
    ]
  }
];

document.querySelectorAll('.alert-item').forEach((item, i) => {
  item.style.cursor = 'pointer';
  item.addEventListener('click', () => {
    const wf = alertWorkflows[i];
    const title = item.querySelector('.alert-title')?.textContent || 'Alert';
    const body = item.querySelector('.alert-body')?.textContent || '';
    const agent = item.querySelector('.alert-agent')?.textContent || '';
    const time = item.querySelector('.alert-time')?.textContent || '';
    let stepsHtml = '';
    if (wf) {
      stepsHtml = `<div style="font-family:'JetBrains Mono',monospace;font-size:9px;color:var(--gold);letter-spacing:0.1em;margin:16px 0 10px;">NEXT STEPS</div>`;
      wf.steps.forEach((s, si) => {
        const colors = { done: { bg: 'var(--green-dim)', border: 'rgba(74,155,111,0.2)', icon: '‚úì', iconColor: 'var(--green)' }, ready: { bg: 'var(--gold-dim)', border: 'var(--border-gold)', icon: '‚Üí', iconColor: 'var(--gold)' }, upcoming: { bg: 'var(--surface-2)', border: 'var(--border)', icon: (si+1).toString(), iconColor: 'var(--text-dim)' } };
        const c = colors[s.status];
        stepsHtml += `<div style="display:flex;gap:10px;align-items:flex-start;padding:10px 12px;background:${c.bg};border:1px solid ${c.border};border-radius:6px;margin-bottom:6px;${s.status === 'ready' ? 'cursor:pointer;' : ''}"><div style="width:22px;height:22px;border-radius:50%;background:${s.status === 'done' ? 'var(--green)' : s.status === 'ready' ? 'var(--gold)' : 'var(--surface-3)'};display:flex;align-items:center;justify-content:center;font-size:10px;font-weight:700;color:${s.status === 'upcoming' ? 'var(--text-dim)' : '#0A0C0E'};flex-shrink:0;">${c.icon}</div><div><div style="font-size:12px;font-weight:600;color:var(--cream);${s.status === 'done' ? 'text-decoration:line-through;opacity:0.6;' : ''}">${s.label}</div><div style="font-size:11px;color:var(--text-mid);margin-top:2px;">${s.desc}</div></div></div>`;
      });
    }
    showModal('Alert Detail', title,
      `<div style="font-size:13px;color:var(--text);line-height:1.6;margin-bottom:12px;">${body}</div>`
      + detailRow('Source Agent', agent, 'var(--gold)')
      + detailRow('Time', time, 'var(--text-mid)')
      + stepsHtml
    );
  });
});

// ‚îÄ‚îÄ‚îÄ PIPELINE ROW CLICKS ‚îÄ‚îÄ‚îÄ
const dealDetails = [
  { name: 'Netflix Inc.', sub: 'HQ Expansion', market: 'Culver City', sf: '~60,000 SF', value: '$42M', stage: 'Proposal', prob: '72%', close: 'Apr 2026', contact: 'Sarah Chen, VP Real Estate', notes: 'Seeking creative office with production-adjacent space. Touring 3 buildings. Prefer ground-floor with outdoor areas. Budget: $65-72/SF NNN.' },
  { name: 'Apex Capital Group', sub: 'Relocation', market: 'Century City', sf: '28,500 SF', value: '$19M', stage: 'LOI Signed', prob: '88%', close: 'Mar 2026', contact: 'David Park, COO', notes: 'LOI signed with 2 flagged clauses pending resolution. High-floor preference. Willing to pay premium for views. Current lease expires June 2026.' },
  { name: 'Pinnacle Studios', sub: 'Expansion ¬∑ Entertainment', market: 'Burbank', sf: '45,000 SF', value: '$30M', stage: 'Closing', prob: '94%', close: 'Mar 2026', contact: 'Rachel Adams, CFO', notes: 'Final walkthrough scheduled. Lease execution expected within 2 weeks. Studio-adjacent space with loading docks.' },
  { name: 'TechCo Inc.', sub: 'New Requirement', market: 'Playa Vista', sf: '~20,000 SF', value: '$11M', stage: 'Qualifying', prob: '38%', close: 'Q3 2026', contact: 'VP Operations (TBD)', notes: 'Agent-sourced lead. Currently at WeWork. 40+ job postings suggest rapid growth. Need to confirm budget and timeline. Badge-in data shows high engagement.' },
  { name: 'WestShore Media', sub: 'Expansion', market: 'Santa Monica', sf: '14,200 SF', value: '$8.5M', stage: 'Proposal', prob: '61%', close: 'May 2026', contact: 'Lisa Tran, Head of Operations', notes: 'Expanding content production team. Need flexible layout with edit bays. Competing with Culver City options. Price-sensitive.' },
  { name: 'Meridian Health Partners', sub: 'New Requirement', market: 'Burbank', sf: '9,000 SF', value: '$4.2M', stage: 'Prospect', prob: '24%', close: 'Q4 2026', contact: 'Michael Torres, CFO', notes: 'Healthcare clinic + admin combo space. Specific zoning requirements. Early stage ‚Äî still evaluating Burbank vs Glendale.' },
  { name: 'Summit Legal Group', sub: 'Expansion ¬∑ Legal', market: 'Century City', sf: '18,000 SF', value: '$16M', stage: 'LOI Signed', prob: '82%', close: 'Apr 2026', contact: 'Jennifer Walsh, Managing Partner', notes: 'Expanding litigation team. Need high-floor with conference facilities. Competing with DTLA options but prefer Century City prestige.' },
  { name: 'Horizon Biotech', sub: 'Expansion ¬∑ Life Sci', market: 'El Segundo', sf: '22,000 SF', value: '$14M', stage: 'Qualifying', prob: '42%', close: 'Q3 2026', contact: 'Dr. Robert Lin, COO', notes: 'Lab/office hybrid requirement. Specific ventilation and power needs. Evaluating El Segundo vs Torrance.' },
  { name: 'Pacific Ventures', sub: 'Relocation ¬∑ VC', market: 'Santa Monica', sf: '12,000 SF', value: '$7.8M', stage: 'Proposal', prob: '55%', close: 'Jun 2026', contact: 'Tom Huang, Partner', notes: 'Relocating from WeHo. Want ocean views and rooftop access. Budget flexible for right space.' },
  { name: 'Catalyst Media', sub: 'New Requirement ¬∑ Media', market: 'Culver City', sf: '8,500 SF', value: '$5.1M', stage: 'Qualifying', prob: '35%', close: 'Q4 2026', contact: 'Amy Castillo, CEO', notes: 'Post-production company. Need soundproofed edit suites and fiber connectivity. Studio-adjacent preferred.' },
  { name: 'CloudNine Software', sub: 'New Requirement ¬∑ SaaS', market: 'Playa Vista', sf: '11,000 SF', value: '$6.8M', stage: 'Prospect', prob: '18%', close: '2027', contact: 'Jason Reed, VP Eng', notes: 'Early-stage inquiry. Currently remote-first. May need space by mid-2027 depending on headcount growth.' },
  { name: 'Verde Architects', sub: 'Relocation ¬∑ Design', market: 'W. Hollywood', sf: '5,500 SF', value: '$3.2M', stage: 'Proposal', prob: '58%', close: 'May 2026', contact: 'Maria Santos, Founder', notes: 'Boutique architecture firm. Need design studio with natural light. Ground floor with street presence preferred.' },
  { name: 'Arclight Partners', sub: 'Expansion ¬∑ Finance', market: 'DTLA', sf: '35,000 SF', value: '$18M', stage: 'Qualifying', prob: '45%', close: 'Q3 2026', contact: 'Steven Park, MD', notes: 'Private equity firm expanding trading floor. Need secure entry, backup power, low latency connectivity.' },
  { name: 'Zenith Healthcare', sub: 'New Requirement ¬∑ Healthcare', market: 'Burbank', sf: '7,000 SF', value: '$3.4M', stage: 'Prospect', prob: '22%', close: 'Q4 2026', contact: 'Dr. Nina Patel', notes: 'Outpatient clinic. ADA compliance and parking critical. Evaluating multiple Valley locations.' }
];

document.querySelectorAll('.pipeline-table tbody tr').forEach((row, i) => {
  row.style.cursor = 'pointer';
  row.addEventListener('click', () => {
    const d = dealDetails[i];
    if (!d) return;
    showModal('Deal Detail', d.name,
      `<div style="font-size:13px;color:var(--text-mid);margin-bottom:16px;">${d.sub} ¬∑ ${d.market}</div>`
      + detailRow('Square Footage', d.sf, 'var(--cream)')
      + detailRow('Estimated Value', d.value, 'var(--gold)')
      + detailRow('Stage', d.stage, 'var(--cream)')
      + detailRow('Win Probability', d.prob, parseInt(d.prob) > 70 ? 'var(--green)' : parseInt(d.prob) > 50 ? 'var(--amber)' : 'var(--red)')
      + detailRow('Expected Close', d.close, 'var(--text-mid)')
      + detailRow('Key Contact', d.contact, 'var(--cream)')
      + `<div style="margin-top:16px;padding:12px;background:var(--surface-2);border:1px solid var(--border);border-radius:6px;font-size:12px;color:var(--text);line-height:1.5;"><strong style="color:var(--cream);">Notes:</strong> ${d.notes}</div>`
      + `<div style="display:flex;gap:8px;margin-top:16px;"><button onclick="actionDealFollowUp(${i})" style="flex:1;padding:10px;background:var(--gold);color:#0A0C0E;border:none;border-radius:4px;font-weight:700;font-family:'Syne',sans-serif;font-size:12px;cursor:pointer;">Draft Follow-Up ‚Üí</button><button onclick="actionUpdateStage(${i})" style="flex:1;padding:10px;background:var(--surface-2);border:1px solid var(--border);border-radius:4px;color:var(--text);font-family:'Syne',sans-serif;font-size:12px;cursor:pointer;">Update Stage</button></div>`
    );
  });
});

// ‚îÄ‚îÄ‚îÄ AGENT FEED ITEM CLICKS (rich contextual views) ‚îÄ‚îÄ‚îÄ
const agentFeedDetails = [
  { // Snap vacating
    badge: 'Intel Agent', title: 'Snap Inc. Vacating 42K SF ‚Äî Santa Monica',
    body: () => `<div style="font-size:13px;color:var(--text);line-height:1.7;margin-bottom:16px;">Snap Inc. is vacating 42,000 SF of Class A creative office at 2101 Colorado Ave, Santa Monica. Lease expires Q2 2026. Intel Agent has identified 3 TAMI tenants actively searching in this submarket.</div>`
      + `<div style="background:var(--surface-2);border:1px solid var(--border);border-radius:8px;padding:16px;margin-bottom:12px;">`
      + `<div style="font-family:'JetBrains Mono',monospace;font-size:9px;color:var(--gold);letter-spacing:0.1em;margin-bottom:10px;">INTEL REPORT</div>`
      + detailRow('Property', '2101 Colorado Ave, Santa Monica', 'var(--cream)')
      + detailRow('Size', '42,000 SF ¬∑ Class A Creative', 'var(--cream)')
      + detailRow('Current Tenant', 'Snap Inc.', 'var(--cream)')
      + detailRow('Lease Expiry', 'Q2 2026', 'var(--amber)')
      + detailRow('Asking Rent', '$72/SF NNN (est.)', 'var(--gold)')
      + detailRow('First-Mover Window', '~6 weeks', 'var(--red)')
      + `</div>`
      + `<div style="font-family:'JetBrains Mono',monospace;font-size:9px;color:var(--text-dim);letter-spacing:0.1em;margin-bottom:8px;">MATCHING TENANTS IN SUBMARKET</div>`
      + `<div style="display:flex;flex-direction:column;gap:6px;margin-bottom:16px;">`
      + `<div style="padding:8px 10px;background:var(--green-dim);border:1px solid rgba(74,155,111,0.2);border-radius:4px;font-size:11px;color:var(--cream);">TechCo Inc. ‚Äî 20K SF need, Playa Vista/SM preferred</div>`
      + `<div style="padding:8px 10px;background:var(--green-dim);border:1px solid rgba(74,155,111,0.2);border-radius:4px;font-size:11px;color:var(--cream);">WestShore Media ‚Äî 14.2K SF expansion, SM top choice</div>`
      + `<div style="padding:8px 10px;background:var(--gold-dim);border:1px solid var(--border-gold);border-radius:4px;font-size:11px;color:var(--cream);">Shopify (sublease exit) ‚Äî 18K SF, exploring SM</div>`
      + `</div>`
      + `<div style="display:flex;gap:8px;"><button onclick="actionDraftOutreachAll(['TechCo Inc.','WestShore Media','Shopify'],'Snap Space ¬∑ 42K SF SM')" style="flex:1;padding:10px;background:var(--gold);color:#0A0C0E;border:none;border-radius:4px;font-weight:700;font-family:'Syne',sans-serif;font-size:12px;cursor:pointer;">Draft Outreach to All 3 ‚Üí</button><button onclick="actionViewProperty('2101 Colorado Ave','Santa Monica','42,000 SF','Class A Creative','$72/SF NNN')" style="flex:1;padding:10px;background:var(--surface-2);border:1px solid var(--border);border-radius:4px;color:var(--text);font-family:'Syne',sans-serif;font-size:12px;cursor:pointer;">View Property Details</button></div>`
  },
  { // TechCo lead
    badge: 'Lead Agent', title: 'New Lead ‚Äî TechCo Inc. Expansion Signal',
    body: () => `<div style="font-size:13px;color:var(--text);line-height:1.7;margin-bottom:16px;">Lead Agent detected high-intent expansion signals from TechCo Inc., a Series C SaaS company currently in flex space at WeWork Playa Vista.</div>`
      + `<div style="background:var(--surface-2);border:1px solid var(--border);border-radius:8px;padding:16px;margin-bottom:12px;">`
      + `<div style="font-family:'JetBrains Mono',monospace;font-size:9px;color:var(--gold);letter-spacing:0.1em;margin-bottom:10px;">LEAD PROFILE</div>`
      + detailRow('Company', 'TechCo Inc. ¬∑ Series C ¬∑ SaaS', 'var(--cream)')
      + detailRow('Employees', '200‚Äì500 (growing)', 'var(--cream)')
      + detailRow('Signal: Job Postings', '40+ LA roles in 30 days', 'var(--green)')
      + detailRow('Signal: Badge-In', '+62% MoM at current WeWork', 'var(--green)')
      + detailRow('Est. Space Need', '15,000‚Äì25,000 SF', 'var(--cream)')
      + detailRow('Preferred Markets', 'Playa Vista, Culver City', 'var(--cream)')
      + detailRow('Timeline', 'Q3 2026 (estimated)', 'var(--text-mid)')
      + `</div>`
      + `<div style="display:flex;gap:8px;"><button onclick="actionDraftOutreach('TechCo Inc.','VP Operations')" style="flex:1;padding:10px;background:var(--gold);color:#0A0C0E;border:none;border-radius:4px;font-weight:700;font-family:'Syne',sans-serif;font-size:12px;cursor:pointer;">Draft Outreach ‚Üí</button><button onclick="actionAddToPipeline('TechCo Inc.','New Requirement ¬∑ SaaS')" style="flex:1;padding:10px;background:var(--surface-2);border:1px solid var(--border);border-radius:4px;color:var(--text);font-family:'Syne',sans-serif;font-size:12px;cursor:pointer;">Add to Pipeline ‚Üí</button></div>`
  },
  { // LOI clause
    badge: 'LOI Agent', title: 'Document Review ‚Äî Apex Capital LOI',
    body: () => `<div style="font-size:13px;color:var(--text);line-height:1.7;margin-bottom:16px;">LOI Agent has completed automated review of the Apex Capital draft LOI and flagged 2 non-standard clauses against your gold template.</div>`
      + `<div style="background:var(--surface-2);border:1px solid var(--border);border-radius:8px;padding:16px;margin-bottom:12px;">`
      + `<div style="font-family:'JetBrains Mono',monospace;font-size:9px;color:var(--gold);letter-spacing:0.1em;margin-bottom:10px;">DOCUMENT: APEX_CAPITAL_LOI_V3.PDF</div>`
      + `<div style="padding:10px;background:var(--bg);border:1px solid var(--border);border-radius:4px;font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--text-dim);line-height:1.6;margin-bottom:12px;max-height:100px;overflow-y:auto;">`
      + `<span style="color:var(--red);text-decoration:line-through;">Section 4.2: Tenant may terminate if anchor tenant vacates >50% of premises.</span><br>`
      + `<span style="color:var(--green);">Section 4.2: No co-tenancy termination rights. Rent abatement only if >60% vacant for 12+ months.</span>`
      + `</div>`
      + detailRow('Clauses Reviewed', '24', 'var(--cream)')
      + detailRow('Flagged Issues', '2 non-standard', 'var(--red)')
      + detailRow('Risk Level', 'Medium ‚Äî co-tenancy + assignment', 'var(--amber)')
      + `</div>`
      + `<div style="display:flex;gap:8px;"><button onclick="actionGenerateRedline()" style="flex:1;padding:10px;background:var(--gold);color:#0A0C0E;border:none;border-radius:4px;font-weight:700;font-family:'Syne',sans-serif;font-size:12px;cursor:pointer;">Generate Redline ‚Üí</button><button onclick="actionViewFullLOI()" style="flex:1;padding:10px;background:var(--surface-2);border:1px solid var(--border);border-radius:4px;color:var(--text);font-family:'Syne',sans-serif;font-size:12px;cursor:pointer;">View Full Document</button></div>`
  },
  { // Zoning variance
    badge: 'Permit Agent', title: 'Zoning Alert ‚Äî 1150 S Olive St',
    body: () => `<div style="font-size:13px;color:var(--text);line-height:1.7;margin-bottom:16px;">Permit Agent detected a new zoning variance filing for 1150 S Olive St, DTLA ‚Äî mixed-use conversion from office to residential/commercial.</div>`
      + `<div style="background:var(--surface-2);border:1px solid var(--border);border-radius:8px;padding:16px;margin-bottom:12px;">`
      + `<div style="font-family:'JetBrains Mono',monospace;font-size:9px;color:var(--gold);letter-spacing:0.1em;margin-bottom:10px;">PERMIT FILING</div>`
      + detailRow('Address', '1150 S Olive St, Los Angeles 90015', 'var(--cream)')
      + detailRow('Filing Type', 'Zoning Variance ‚Äî Mixed-Use Conversion', 'var(--cream)')
      + detailRow('Current Use', 'Class B Office ¬∑ 180,000 SF', 'var(--cream)')
      + detailRow('Proposed', 'Residential/Commercial Mixed-Use', 'var(--amber)')
      + detailRow('Filed', 'Feb 23, 2026', 'var(--text-mid)')
      + detailRow('Impact', 'Removes 180K SF office inventory from DTLA', 'var(--red)')
      + `</div>`
      + `<div style="padding:10px;background:var(--gold-dim);border:1px solid var(--border-gold);border-radius:6px;font-size:12px;color:var(--gold);margin-bottom:12px;">This conversion will tighten DTLA office supply. Monitor for rent impact on remaining Class A inventory.</div>`
      + `<div style="display:flex;gap:8px;"><button onclick="actionViewFiling('1150 S Olive St','Zoning Variance','Mixed-Use Conversion')" style="flex:1;padding:10px;background:var(--surface-2);border:1px solid var(--border);border-radius:4px;color:var(--text);font-family:'Syne',sans-serif;font-size:12px;cursor:pointer;">View Full Filing</button><button onclick="actionTrackProperty('1150 S Olive St','DTLA','180,000 SF')" style="flex:1;padding:10px;background:var(--surface-2);border:1px solid var(--border);border-radius:4px;color:var(--text);font-family:'Syne',sans-serif;font-size:12px;cursor:pointer;">Track This Property</button></div>`
  },
  { // Outreach in progress
    badge: 'Outreach Agent', title: 'Drafting Pitch ‚Äî Netflix HQ Expansion',
    body: () => `<div style="font-size:13px;color:var(--text);line-height:1.7;margin-bottom:16px;">Outreach Agent is generating a personalized pitch for Sarah Chen, VP Real Estate at Netflix, regarding the Culver City HQ expansion (~60K SF).</div>`
      + `<div style="background:var(--surface-2);border:1px solid var(--border);border-radius:8px;padding:16px;margin-bottom:12px;">`
      + `<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;"><div style="font-family:'JetBrains Mono',monospace;font-size:9px;color:var(--gold);letter-spacing:0.1em;">DRAFT IN PROGRESS</div><div style="font-size:10px;color:var(--green);">‚óè Generating...</div></div>`
      + `<div style="padding:12px;background:var(--bg);border:1px solid var(--border);border-radius:4px;font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--text);line-height:1.7;">`
      + `<strong style="color:var(--cream);">To:</strong> Sarah Chen, VP Real Estate<br>`
      + `<strong style="color:var(--cream);">Re:</strong> Culver City Creative Office ‚Äî 60K SF<br><br>`
      + `Hi Sarah,<br><br>`
      + `Following up on Netflix's Culver City expansion plans ‚Äî we've identified 3 properties within your criteria that offer the production-adjacent creative space your team needs...<br><br>`
      + `<span style="color:var(--text-dim);">[Agent completing personalization based on deal history and tenant preferences...]</span>`
      + `</div></div>`
      + `<div style="display:flex;gap:8px;"><button onclick="actionEditDraft('Netflix HQ Pitch')" style="flex:1;padding:10px;background:var(--gold);color:#0A0C0E;border:none;border-radius:4px;font-weight:700;font-family:'Syne',sans-serif;font-size:12px;cursor:pointer;">Review When Ready</button><button onclick="actionEditOutreachParams('Netflix','Sarah Chen','Culver City HQ')" style="flex:1;padding:10px;background:var(--surface-2);border:1px solid var(--border);border-radius:4px;color:var(--text);font-family:'Syne',sans-serif;font-size:12px;cursor:pointer;">Edit Parameters</button></div>`
  }
];

document.querySelectorAll('.stream-item').forEach((item, i) => {
  item.style.cursor = 'pointer';
  item.addEventListener('click', () => {
    const d = agentFeedDetails[i];
    if (d) {
      showModal(d.badge, d.title, d.body());
    } else {
      const text = item.querySelector('.stream-text')?.innerHTML || '';
      const meta = item.querySelector('.stream-meta')?.textContent || '';
      showModal('Agent Activity', 'Activity Detail',
        `<div style="font-size:14px;color:var(--text);line-height:1.7;margin-bottom:16px;">${text}</div>`
        + `<div style="font-size:11px;color:var(--text-dim);">${meta}</div>`
      );
    }
  });
});

// ‚îÄ‚îÄ‚îÄ CARD ACTION LINK CLICKS ‚îÄ‚îÄ‚îÄ
document.querySelectorAll('.card-action').forEach(action => {
  action.style.cursor = 'pointer';
  action.addEventListener('click', () => {
    const text = action.textContent.trim();
    if (text.includes('Full Map')) {
      const mapRow = (market, vacancy, trend, trendColor, rent, status) =>
        `<div style="display:flex;align-items:center;padding:8px 0;border-bottom:1px solid var(--border);">`
        + `<div style="flex:2;font-size:12px;color:var(--cream);">${market}</div>`
        + `<div style="width:55px;font-family:'JetBrains Mono',monospace;font-size:11px;color:${parseFloat(vacancy) > 15 ? 'var(--red)' : parseFloat(vacancy) > 10 ? 'var(--amber)' : 'var(--green)'};">${vacancy}</div>`
        + `<div style="width:55px;font-family:'JetBrains Mono',monospace;font-size:10px;color:${trendColor};">${trend}</div>`
        + `<div style="width:50px;font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--gold);">${rent}</div>`
        + `<div style="width:70px;font-size:10px;color:var(--text-mid);">${status}</div></div>`;
      showModal('Heatmap', 'West Coast Submarket Pulse ‚Äî Full View',
        `<div style="display:flex;gap:10px;padding:6px 0;border-bottom:1px solid var(--border-gold);margin-bottom:4px;font-family:'JetBrains Mono',monospace;font-size:8px;color:var(--text-dim);letter-spacing:0.08em;">`
        + `<div style="flex:2;">SUBMARKET</div><div style="width:55px;">VACANCY</div><div style="width:55px;">90D Œî</div><div style="width:50px;">$/SF</div><div style="width:70px;">STATUS</div></div>`
        + mapRow('Manhattan Beach', '5.9%', '‚ñº 0.2%', 'var(--green)', '$56', 'Very Tight')
        + mapRow('El Segundo', '6.7%', '‚ñº 0.4%', 'var(--green)', '$48', 'Tight')
        + mapRow('West Hollywood', '7.3%', '‚ñº 0.5%', 'var(--green)', '$58', 'Tight')
        + mapRow('Playa Vista', '8.1%', '‚ñº 0.9%', 'var(--green)', '$68', 'Tightening')
        + mapRow('Bellevue WA', '9.2%', '‚ñº 1.0%', 'var(--green)', '$58', 'Recovering')
        + mapRow('Santa Monica', '9.8%', '‚ñº 1.1%', 'var(--green)', '$72', 'Tightening')
        + mapRow('Burbank', '10.4%', '‚ñº 0.7%', 'var(--green)', '$52', 'Stable')
        + mapRow('Seattle SLU', '11.0%', '‚ñº 0.6%', 'var(--green)', '$52', 'Recovering')
        + mapRow('Culver City', '11.2%', '‚ñº 0.6%', 'var(--green)', '$62', 'Tightening')
        + mapRow('Century City', '12.6%', '‚ñº 0.3%', 'var(--green)', '$82', 'Premium')
        + mapRow('SF Mission', '14.8%', '‚ñº 0.3%', 'var(--green)', '$54', 'Stabilizing')
        + mapRow('Wilshire Corridor', '16.1%', '‚ñ≤ 0.4%', 'var(--red)', '$46', 'Soft')
        + mapRow('DTLA', '18.4%', '‚ñ≤ 1.2%', 'var(--red)', '$54', 'Elevated')
        + mapRow('SF SOMA', '22.1%', '‚ñ≤ 1.4%', 'var(--red)', '$62', 'Distressed')
        + mapRow('SF Financial', '26.3%', '‚ñ≤ 2.1%', 'var(--red)', '$68', 'Distressed')
      );
    } else if (text.includes('View All') && action.closest('#agent-card')) {
      const logItem = (icon, cls, text, tag, tagCls, time, agent) =>
        `<div style="display:flex;gap:10px;padding:10px 0;border-bottom:1px solid var(--border);cursor:pointer;">`
        + `<div style="width:28px;height:28px;border-radius:6px;background:var(--surface-3);display:flex;align-items:center;justify-content:center;font-size:13px;flex-shrink:0;">${icon}</div>`
        + `<div style="flex:1;min-width:0;"><div style="font-size:12px;color:var(--text);line-height:1.5;">${text}</div>`
        + `<div style="display:flex;gap:8px;align-items:center;margin-top:3px;"><span style="font-size:9px;padding:2px 6px;border-radius:2px;background:var(--surface-3);color:var(--cream);font-family:'JetBrains Mono',monospace;letter-spacing:0.05em;">${tag}</span><span style="font-size:10px;color:var(--text-dim);">${time} ¬∑ ${agent}</span></div></div></div>`;
      showModal('Agent Feed', 'Full Agent Activity Log ‚Äî Today',
        `<div style="font-family:'JetBrains Mono',monospace;font-size:9px;color:var(--gold);letter-spacing:0.1em;margin-bottom:12px;">6 AGENTS ¬∑ 15 SUBMARKETS ¬∑ LAST 24 HOURS</div>`
        + logItem('‚ö°', '', '<strong>Snap Inc.</strong> vacating 42K SF at 2101 Colorado Ave SM ‚Äî 3 tenants circling.', 'High Priority', '', '2 min ago', 'Intel Agent')
        + logItem('üéØ', '', '<strong>TechCo Inc.</strong> (Series C) posted 40+ LA jobs. Office expansion signal.', 'New Lead', '', '14 min ago', 'Lead Agent')
        + logItem('üìã', '', '<strong>LOI Agent</strong> flagged non-standard exclusivity clause ‚Äî Apex Capital draft.', 'Document', '', '31 min ago', 'LOI Agent')
        + logItem('üîç', '', 'Zoning variance filed for <strong>1150 S Olive St</strong> ‚Äî mixed-use conversion.', 'Zoning', '', '1 hr ago', 'Permit Agent')
        + logItem('‚úâÔ∏è', '', '<strong>Outreach Agent</strong> drafting personalized pitch for Netflix HQ expansion.', 'In Progress', '', '1 hr ago', 'Outreach Agent')
        + logItem('üìà', '', '<strong>Fed signals pause.</strong> Cap rate compression model updated ‚Äî industrial -25bps.', 'Rate Watch', '', '1.5 hr ago', 'Macro Agent')
        + logItem('üåê', '', 'SF Financial District vacancy updated to <strong>26.3%</strong> ‚Äî highest in 18 months.', 'Market', '', '2 hr ago', 'Intel Agent')
        + logItem('üéØ', '', '<strong>Shopify</strong> subletting 18K SF in Santa Monica ‚Äî window opening.', 'New Lead', '', '2.5 hr ago', 'Lead Agent')
        + logItem('üìã', '', '<strong>LOI Agent</strong> completed Apex Capital clause comparison. 2 items flagged.', 'Document', '', '3 hr ago', 'LOI Agent')
        + logItem('üîç', '', 'Building permit approved for <strong>550 S Flower St</strong> ‚Äî Class A renovation.', 'Permit', '', '4 hr ago', 'Permit Agent')
        + logItem('üåê', '', 'Playa Vista badge-in data: <strong>74% occupancy</strong> vs 61% DTLA avg.', 'Intel', '', '4 hr ago', 'Intel Agent')
        + logItem('‚úâÔ∏è', '', '<strong>Outreach Agent</strong> sent WestShore Media pitch ‚Äî 3 property options.', 'Sent', '', '5 hr ago', 'Outreach Agent')
        + logItem('üìà', '', '10Y Treasury down 12bps to <strong>3.82%</strong>. Monitoring cap rate impact.', 'Rate Watch', '', '6 hr ago', 'Macro Agent')
        + logItem('üéØ', '', '<strong>Meridian Health Partners</strong> exploring Burbank for 9K SF clinic space.', 'New Lead', '', '8 hr ago', 'Lead Agent')
        + logItem('üåê', '', 'CBRE closed 18,500 SF at Water Garden. 3 remaining comparables in SM.', 'Market', '', '10 hr ago', 'Intel Agent')
      );
    } else if (text.includes('Mark All Read')) {
      document.querySelectorAll('.alert-item').forEach(a => a.style.opacity = '0.5');
      action.textContent = 'All Read ‚úì';
      action.style.color = 'var(--green)';
    } else if (text.includes('View All 14')) {
      const dealRow = (name, sub, market, sf, value, stage, stageCls, prob, probColor, close) =>
        `<div style="display:flex;align-items:center;gap:10px;padding:10px 0;border-bottom:1px solid var(--border);cursor:pointer;">`
        + `<div style="flex:2;min-width:0;"><div style="font-size:12px;font-weight:600;color:var(--cream);">${name}</div><div style="font-size:10px;color:var(--text-dim);">${sub}</div></div>`
        + `<div style="flex:1;"><span style="font-size:10px;padding:2px 6px;border-radius:2px;background:var(--surface-3);color:var(--cream);font-family:'JetBrains Mono',monospace;">${market}</span></div>`
        + `<div style="width:50px;font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--text-mid);">${sf}</div>`
        + `<div style="width:45px;font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--gold);font-weight:600;">${value}</div>`
        + `<div style="width:70px;"><span style="font-size:9px;padding:2px 6px;border-radius:2px;background:var(--surface-3);color:var(--cream);font-family:'JetBrains Mono',monospace;">${stage}</span></div>`
        + `<div style="width:35px;font-family:'JetBrains Mono',monospace;font-size:10px;color:${probColor};">${prob}</div>`
        + `<div style="width:50px;font-family:'JetBrains Mono',monospace;font-size:9px;color:var(--text-dim);">${close}</div></div>`;
      showModal('Deal Pipeline', 'All Active Deals ‚Äî 14',
        `<div style="font-family:'JetBrains Mono',monospace;font-size:9px;color:var(--gold);letter-spacing:0.1em;margin-bottom:4px;">TOTAL PIPELINE VALUE: $218M</div>`
        + `<div style="display:flex;gap:12px;margin-bottom:14px;">`
        + `<span style="font-size:10px;color:var(--text-dim);">Prospect: 3</span>`
        + `<span style="font-size:10px;color:var(--blue);">Qualifying: 4</span>`
        + `<span style="font-size:10px;color:var(--amber);">Proposal: 4</span>`
        + `<span style="font-size:10px;color:var(--gold);">LOI: 2</span>`
        + `<span style="font-size:10px;color:var(--green);">Closing: 1</span></div>`
        + `<div style="display:flex;gap:10px;padding:6px 0;border-bottom:1px solid var(--border-gold);margin-bottom:4px;font-family:'JetBrains Mono',monospace;font-size:8px;color:var(--text-dim);letter-spacing:0.08em;">`
        + `<div style="flex:2;">TENANT</div><div style="flex:1;">MARKET</div><div style="width:50px;">SF</div><div style="width:45px;">VALUE</div><div style="width:70px;">STAGE</div><div style="width:35px;">PROB</div><div style="width:50px;">CLOSE</div></div>`
        + dealRow('Netflix Inc.', 'HQ Expansion ¬∑ TAMI', 'Culver City', '~60K', '$42M', 'Proposal', '', '72%', 'var(--green)', "Apr '26")
        + dealRow('Apex Capital Group', 'Relocation ¬∑ Financial', 'Century City', '28.5K', '$19M', 'LOI Signed', '', '88%', 'var(--green)', "Mar '26")
        + dealRow('TechCo Inc.', 'New Requirement ¬∑ SaaS', 'Playa Vista', '~20K', '$11M', 'Qualifying', '', '38%', 'var(--amber)', "Q3 '26")
        + dealRow('WestShore Media', 'Expansion ¬∑ Media', 'Santa Monica', '14.2K', '$8.5M', 'Proposal', '', '61%', 'var(--cream)', "May '26")
        + dealRow('Meridian Health', 'New Req. ¬∑ Healthcare', 'Burbank', '9K', '$4.2M', 'Prospect', '', '24%', 'var(--red)', "Q4 '26")
        + dealRow('Pacific Ventures', 'Relocation ¬∑ VC', 'Santa Monica', '12K', '$7.8M', 'Proposal', '', '55%', 'var(--cream)', "Jun '26")
        + dealRow('Horizon Biotech', 'Expansion ¬∑ Life Sci', 'El Segundo', '22K', '$14M', 'Qualifying', '', '42%', 'var(--amber)', "Q3 '26")
        + dealRow('Catalyst Media', 'New Req. ¬∑ Media', 'Culver City', '8.5K', '$5.1M', 'Qualifying', '', '35%', 'var(--amber)', "Q4 '26")
        + dealRow('Summit Legal Group', 'Expansion ¬∑ Legal', 'Century City', '18K', '$16M', 'LOI Signed', '', '82%', 'var(--green)', "Apr '26")
        + dealRow('CloudNine Software', 'New Req. ¬∑ SaaS', 'Playa Vista', '11K', '$6.8M', 'Prospect', '', '18%', 'var(--red)', "2027")
        + dealRow('Verde Architects', 'Relocation ¬∑ Design', 'W. Hollywood', '5.5K', '$3.2M', 'Proposal', '', '58%', 'var(--cream)', "May '26")
        + dealRow('Arclight Partners', 'Expansion ¬∑ Finance', 'DTLA', '35K', '$18M', 'Qualifying', '', '45%', 'var(--amber)', "Q3 '26")
        + dealRow('Zenith Healthcare', 'New Req. ¬∑ Healthcare', 'Burbank', '7K', '$3.4M', 'Prospect', '', '22%', 'var(--red)', "Q4 '26")
        + dealRow('Pinnacle Studios', 'Expansion ¬∑ Entertain.', 'Burbank', '45K', '$30M', 'Closing', '', '94%', 'var(--green)', "Mar '26")
      );
    }
  });
});

// ‚îÄ‚îÄ‚îÄ NOTIFICATION BELL + SETTINGS GEAR ‚îÄ‚îÄ‚îÄ
// Handled via onclick attributes on topbar icons ‚Äî switchView('morning-brief') and switchView('preferences')

// ‚îÄ‚îÄ‚îÄ SPARKLINE BAR CLICKS ‚Äî REAL DATA DRILL-DOWN ‚îÄ‚îÄ‚îÄ
const sparkDataSets = {
  'deal-value': {
    title: 'Deal Value Trend',
    unit: '$M',
    months: ["Mar '25","Apr '25","May '25","Jun '25","Jul '25","Aug '25","Sep '25","Oct '25","Nov '25","Dec '25","Jan '26","Feb '26"],
    values: [98,131,109,153,120,175,142,192,157,197,184,218],
    details: {
      "Feb '26": { deals: 14, largest: 'Netflix Inc. ($42M)', newThisMo: 3, closedThisMo: 0, weightedVal: '$168M' },
      "Jan '26": { deals: 12, largest: 'Netflix Inc. ($42M)', newThisMo: 1, closedThisMo: 1, weightedVal: '$142M' },
      "Dec '25": { deals: 12, largest: 'Netflix Inc. ($38M)', newThisMo: 2, closedThisMo: 0, weightedVal: '$148M' }
    }
  },
  'leads': {
    title: 'Agent-Sourced Leads',
    unit: 'leads',
    months: ["Mar '25","Apr '25","May '25","Jun '25","Jul '25","Aug '25","Sep '25","Oct '25","Nov '25","Dec '25","Jan '26","Feb '26"],
    values: [9,12,11,17,15,19,22,18,24,26,28,31],
    details: {
      "Feb '26": { qualified: 24, converted: 6, topSource: 'Lead Agent ‚Äî job postings', sector: 'TAMI (14), Healthcare (6), Finance (5), Other (6)' },
      "Jan '26": { qualified: 21, converted: 5, topSource: 'Lead Agent ‚Äî sublease filings', sector: 'TAMI (11), Healthcare (5), Finance (6), Other (6)' }
    }
  },
  'vacancy': {
    title: 'LA Metro Vacancy Rate',
    unit: '%',
    months: ["Mar '25","Apr '25","May '25","Jun '25","Jul '25","Aug '25","Sep '25","Oct '25","Nov '25","Dec '25","Jan '26","Feb '26"],
    values: [17.8,17.1,16.4,17.5,15.7,15.2,14.6,13.9,14.3,13.2,12.5,14.2],
    details: {
      "Feb '26": { lowest: 'Manhattan Beach (5.9%)', highest: 'DTLA (18.4%)', improving: 'Playa Vista, Culver City, El Segundo', worsening: 'DTLA, Wilshire Corridor' },
      "Jan '26": { lowest: 'Manhattan Beach (6.1%)', highest: 'DTLA (17.8%)', improving: 'Playa Vista, Santa Monica', worsening: 'SF Financial, SF SOMA' }
    }
  }
};

document.querySelectorAll('.spark-bar').forEach(bar => {
  bar.style.cursor = 'pointer';
  bar.addEventListener('click', () => {
    const card = bar.closest('.spark-card');
    const cardId = card?.id || '';
    const barLabel = bar.getAttribute('data-label') || '';
    const barVal = bar.getAttribute('data-val') || '';
    const title = card?.querySelector('.card-title')?.textContent || 'Chart Detail';

    // Determine which dataset
    let dsKey = 'deal-value';
    if (cardId.includes('leads')) dsKey = 'leads';
    else if (cardId.includes('vacancy')) dsKey = 'vacancy';
    const ds = sparkDataSets[dsKey];

    // Build period comparison
    const idx = ds.months.indexOf(barLabel);
    const prevVal = idx > 0 ? ds.values[idx - 1] : null;
    const curVal = ds.values[idx] !== undefined ? ds.values[idx] : parseFloat(barVal);
    const change = prevVal !== null ? (curVal - prevVal) : 0;
    const changePct = prevVal ? ((change / prevVal) * 100).toFixed(1) : '‚Äî';
    const changeColor = change >= 0 ? (dsKey === 'vacancy' ? 'var(--red)' : 'var(--green)') : (dsKey === 'vacancy' ? 'var(--green)' : 'var(--red)');

    let detailHtml = '';
    const det = ds.details[barLabel];
    if (det) {
      detailHtml = `<div style="font-family:'JetBrains Mono',monospace;font-size:9px;color:var(--gold);letter-spacing:0.1em;margin:16px 0 8px;">PERIOD DETAIL</div>`;
      Object.entries(det).forEach(([k, v]) => {
        const label = k.replace(/([A-Z])/g, ' $1').replace(/^./, s => s.toUpperCase());
        detailHtml += detailRow(label, v, 'var(--cream)');
      });
    }

    // Build comparison table for all months
    let tableHtml = `<div style="font-family:'JetBrains Mono',monospace;font-size:9px;color:var(--gold);letter-spacing:0.1em;margin:16px 0 8px;">12-MONTH HISTORY</div>`;
    tableHtml += `<div style="max-height:180px;overflow-y:auto;">`;
    ds.months.forEach((m, mi) => {
      const v = ds.values[mi];
      const prev = mi > 0 ? ds.values[mi-1] : null;
      const d = prev !== null ? (v - prev) : 0;
      const dStr = prev !== null ? (d >= 0 ? `+${d.toFixed?.(1) || d}` : `${d.toFixed?.(1) || d}`) : '‚Äî';
      const dCol = d >= 0 ? (dsKey === 'vacancy' ? 'var(--red)' : 'var(--green)') : (dsKey === 'vacancy' ? 'var(--green)' : 'var(--red)');
      const isCurrent = m === barLabel;
      tableHtml += `<div style="display:flex;justify-content:space-between;padding:5px 0;border-bottom:1px solid var(--border);${isCurrent ? 'background:var(--gold-dim);padding:5px 6px;border-radius:3px;' : ''}"><span style="font-size:11px;color:${isCurrent ? 'var(--gold)' : 'var(--text-mid)'};font-weight:${isCurrent ? '700' : '400'};">${m}</span><span style="font-family:'JetBrains Mono',monospace;font-size:11px;color:var(--cream);">${dsKey === 'vacancy' ? v + '%' : dsKey === 'leads' ? v : '$' + v + 'M'}</span><span style="font-family:'JetBrains Mono',monospace;font-size:10px;color:${dCol};">${dStr}</span></div>`;
    });
    tableHtml += `</div>`;

    showModal('Chart', `${title} ‚Äî ${barLabel}`,
      `<div style="font-family:'Cormorant Garamond',serif;font-size:36px;font-weight:600;color:var(--cream);margin-bottom:4px;">${dsKey === 'vacancy' ? curVal + '%' : dsKey === 'leads' ? curVal : '$' + curVal + 'M'}</div>`
      + `<div style="font-size:13px;color:${changeColor};margin-bottom:8px;">${change >= 0 ? '‚ñ≤' : '‚ñº'} ${Math.abs(change).toFixed?.(1) || Math.abs(change)} ${ds.unit} (${changePct}%) vs prior month</div>`
      + detailHtml
      + tableHtml
    );
  });
});

// ‚îÄ‚îÄ‚îÄ SPARKLINE DATA EDIT MODAL ‚îÄ‚îÄ‚îÄ
function showSparkDataModal(dsKey) {
  const ds = sparkDataSets[dsKey];
  let rows = '';
  ds.months.forEach((m, i) => {
    rows += `<div style="display:flex;gap:8px;align-items:center;margin-bottom:6px;">
      <span style="width:70px;font-size:11px;color:var(--text-mid);">${m}</span>
      <input type="number" step="0.1" value="${ds.values[i]}" id="spark-edit-${dsKey}-${i}" style="flex:1;padding:6px 10px;background:var(--surface-2);border:1px solid var(--border);border-radius:4px;color:var(--cream);font-family:'JetBrains Mono',monospace;font-size:12px;" />
    </div>`;
  });
  showModal('Edit Data', ds.title,
    `<div style="font-size:12px;color:var(--text);margin-bottom:12px;">Edit monthly values below, or import from a CSV file.</div>`
    + `<div style="max-height:300px;overflow-y:auto;margin-bottom:12px;">${rows}</div>`
    + `<div style="display:flex;gap:8px;">
      <button onclick="saveSparkData('${dsKey}')" style="flex:1;padding:10px;background:var(--gold);color:#0A0C0E;border:none;border-radius:4px;font-weight:700;font-family:'Syne',sans-serif;font-size:12px;cursor:pointer;">Save Changes</button>
      <label style="flex:1;padding:10px;background:var(--surface-2);border:1px solid var(--border);border-radius:4px;color:var(--text);font-family:'Syne',sans-serif;font-size:12px;cursor:pointer;text-align:center;">
        Import CSV <input type="file" accept=".csv,.xlsx,.xls" onchange="importSparkCSV(event,'${dsKey}')" style="display:none;" />
      </label>
      <button onclick="generateExampleSparkData('${dsKey}')" style="flex:1;padding:10px;background:var(--surface-2);border:1px solid var(--border);border-radius:4px;color:var(--gold);font-family:'Syne',sans-serif;font-size:12px;cursor:pointer;">AI Generate ‚ú¶</button>
    </div>`
  );
}

function saveSparkData(dsKey) {
  const ds = sparkDataSets[dsKey];
  ds.months.forEach((m, i) => {
    const inp = document.getElementById(`spark-edit-${dsKey}-${i}`);
    if (inp) ds.values[i] = parseFloat(inp.value) || 0;
  });
  refreshSparkChart(dsKey);
  closeModal();
}

function importSparkCSV(event, dsKey) {
  const file = event.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = function(e) {
    const lines = e.target.result.split('\n').filter(l => l.trim());
    const ds = sparkDataSets[dsKey];
    // Expect format: Month,Value (with or without header)
    let startIdx = 0;
    if (lines[0].toLowerCase().includes('month') || lines[0].toLowerCase().includes('date')) startIdx = 1;
    lines.slice(startIdx).forEach((line, i) => {
      const parts = line.split(',');
      if (parts.length >= 2 && i < ds.values.length) {
        const val = parseFloat(parts[1].replace(/[^0-9.-]/g, ''));
        if (!isNaN(val)) ds.values[i] = val;
        if (parts[0].trim()) ds.months[i] = parts[0].trim();
      }
    });
    refreshSparkChart(dsKey);
    closeModal();
    showToast('Data imported successfully from ' + file.name);
  };
  reader.readAsText(file);
}

function generateExampleSparkData(dsKey) {
  const ds = sparkDataSets[dsKey];
  const base = dsKey === 'deal-value' ? 120 : dsKey === 'leads' ? 10 : 16;
  const growth = dsKey === 'deal-value' ? 8 : dsKey === 'leads' ? 1.5 : -0.4;
  const noise = dsKey === 'deal-value' ? 20 : dsKey === 'leads' ? 3 : 1.2;
  ds.months.forEach((m, i) => {
    ds.values[i] = Math.max(0, +(base + growth * i + (Math.random() - 0.4) * noise).toFixed(1));
  });
  // Update modal inputs if open
  ds.months.forEach((m, i) => {
    const inp = document.getElementById(`spark-edit-${dsKey}-${i}`);
    if (inp) inp.value = ds.values[i];
  });
  showToast('Example data generated ‚Äî click Save Changes to apply');
}

function refreshSparkChart(dsKey) {
  const ds = sparkDataSets[dsKey];
  const max = Math.max(...ds.values);
  let barsContainer, bigEl, deltaEl;
  if (dsKey === 'deal-value') { barsContainer = document.getElementById('spark-deal-bars'); bigEl = document.getElementById('spark-deal-big'); deltaEl = document.getElementById('spark-deal-delta'); }
  else if (dsKey === 'leads') { barsContainer = document.getElementById('spark-leads-bars'); bigEl = document.getElementById('spark-leads-big'); deltaEl = document.getElementById('spark-leads-delta'); }
  else { barsContainer = document.getElementById('spark-vacancy-bars'); bigEl = document.getElementById('spark-vacancy-big'); deltaEl = document.getElementById('spark-vacancy-delta'); }
  if (!barsContainer) return;

  const barClass = dsKey === 'deal-value' ? 'gold-bar' : dsKey === 'leads' ? 'green-bar' : 'blue-bar';
  const latest = ds.values[ds.values.length - 1];
  const prev = ds.values[ds.values.length - 2];
  const change = latest - prev;

  barsContainer.innerHTML = ds.values.map((v, i) =>
    `<div class="spark-bar ${barClass}${i === ds.values.length - 1 ? ' current' : ''}" data-val="${v}" data-label="${ds.months[i]}" style="height:${max > 0 ? (v / max * 100) : 0}%;cursor:pointer;"></div>`
  ).join('');

  if (bigEl) bigEl.textContent = dsKey === 'vacancy' ? latest + '%' : dsKey === 'leads' ? latest : '$' + latest + 'M';
  if (deltaEl) {
    const arrow = change >= 0 ? '‚ñ≤' : '‚ñº';
    deltaEl.textContent = `${arrow} ${Math.abs(change).toFixed(1)} ${dsKey === 'vacancy' ? '(90d)' : dsKey === 'leads' ? 'this month' : 'vs last mo'}`;
    deltaEl.className = `spark-delta ${change >= 0 ? (dsKey === 'vacancy' ? 'delta-up' : 'delta-up') : 'delta-down'}`;
  }

  // Re-bind bar clicks
  barsContainer.querySelectorAll('.spark-bar').forEach(bar => {
    bar.addEventListener('click', () => bar.click?.());
  });
}

function showToast(msg) {
  const t = document.getElementById('toast');
  if (!t) return;
  t.querySelector('.toast-text').innerHTML = `<strong>${msg}</strong>`;
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 3000);
}

// ‚îÄ‚îÄ‚îÄ AGENT CHAT BOT ‚îÄ‚îÄ‚îÄ
const agentChatKnowledge = {
  'snap': 'Snap Inc. is vacating 42K SF at 2101 Colorado Ave in Santa Monica. Their lease expires Q2 2026. Intel Agent identified 3 TAMI tenants in the same submarket actively searching for space. First-mover window is approximately 6 weeks. The space features open floor plans and ocean proximity.',
  'netflix': 'Netflix HQ Expansion deal is at Proposal stage ($42M, 72% probability). They need ~60K SF of creative office in Culver City with production-adjacent space. Key contact: Sarah Chen, VP Real Estate. Target close: Apr 2026. Currently touring 3 buildings.',
  'apex': 'Apex Capital Group relocation to Century City is at LOI Signed stage ($19M, 88% probability). LOI Agent flagged 2 non-standard clauses: Section 4.2 (co-tenancy) and Section 7 (assignment rights). Key contact: David Park, COO. Target close: Mar 2026.',
  'techco': 'TechCo Inc. is an agent-sourced lead in Qualifying stage ($11M, 38% probability). Series C SaaS company with 40+ LA job postings. WeWork badge-in data shows +62% MoM at Playa Vista. Estimated need: 15-25K SF. Timeline: Q3 2026.',
  'pinnacle': 'Pinnacle Studios is in Qualifying stage ($8.5M, 45% probability). Post-production company looking for 12K SF in Burbank with sound-stage adjacency. Key contact: Alex Rivera, Facilities Dir. Timeline: Q4 2026.',
  'westshore': 'WestShore Media is a Prospect ($6.2M, 25% probability). Digital media agency in Santa Monica wanting 14.2K SF expansion. Currently in WeWork, outgrowing space. Key contact: Jennifer Wu, COO.',
  'meridian': 'Meridian Health is at Proposal stage ($14M, 65% probability). Healthcare system expanding into Burbank, 28K SF medical office. Key contact: Dr. Rachel Kim. Close target: May 2026.',
  'summit': 'Summit Legal Group is at LOI Signed stage ($7.8M, 82% probability). Mid-size law firm relocating to Century City from Wilshire. Need 15K SF Class A. Key contact: Michael Torres, Managing Partner.',
  'horizon': 'Horizon Biotech is in Qualifying stage ($5.4M, 35% probability). Early-stage biotech needing wet lab + office combo, 8K SF in Playa Vista. Key contact: Dr. James Liu.',
  'pacific': 'Pacific Ventures is a Prospect ($3.2M, 20% probability). VC firm looking for boutique 4K SF office in Santa Monica. Premium location priority. Key contact: Emily Zhang.',
  'catalyst': 'Catalyst Media is at Proposal stage ($9.1M, 55% probability). Streaming platform needing 18K SF creative office in Culver City. Production-adjacent preferred. Key contact: Tom Bradley.',
  'cloudnine': 'CloudNine Software is in Qualifying stage ($12M, 42% probability). Enterprise SaaS company, 22K SF need in El Segundo or Playa Vista. Series D funded. Key contact: Priya Sharma, CTO.',
  'verde': 'Verde Architects is a Prospect ($2.8M, 22% probability). Sustainable architecture firm, 6K SF studio in West Hollywood or Santa Monica. Key contact: Carlos Mendez.',
  'arclight': 'Arclight Partners is at Closing stage ($28M, 92% probability). PE firm taking 35K SF in Century City. Premium build-out. Close target: Mar 2026. Key contact: Robert Chen, Managing Director.',
  'zenith': 'Zenith Healthcare is in Qualifying stage ($4.6M, 30% probability). Telehealth startup expanding to physical office, 10K SF in Manhattan Beach. Key contact: Dr. Sarah Patel.',
  'vacancy': 'LA metro average office vacancy is 14.2%, down 0.8% over 90 days. Tightest: Manhattan Beach (5.9%), El Segundo (6.7%). Most distressed: DTLA (18.4%), Wilshire Corridor (16.1%). SF Financial District is at 26.3% ‚Äî highest in 18 months.',
  'pipeline': 'Total pipeline: 14 active deals valued at $218M. Stage breakdown: 3 Prospect, 4 Qualifying, 4 Proposal, 2 LOI Signed, 1 Closing. Pipeline value up 12.4% vs last quarter. 4 deals expected to close by May 2026. Win rate (12mo): 68%.',
  'leads': '31 agent-sourced leads in the last 30 days (up 8 from prior month). Breakdown: TAMI sector 14, Healthcare 6, Financial Services 5, Professional Services 4, Other 2. Lead Agent accuracy: 78% qualification rate.',
  'market': 'West Coast CRE market is bifurcated. Westside LA (SM, Playa Vista, Culver City) is tightening with strong TAMI absorption. DTLA and Wilshire remain soft. SF Financial is distressed at 26.3%. Seattle SLU recovering with Amazon RTO driving absorption.',
  'interest': 'Fed signaled a pause at 4.25%. Model projects cap rate compression: Office -15bps, Industrial -25bps, Retail -8bps over 90 days. 10Y Treasury at 3.82% (down 12bps). Asset values could increase 2-4% in industrial.',
  'agents': '6 AI agents running: Intel Agent (market monitoring, connected to CoStar + LoopNet + County Recorder + Census/BLS), Lead Agent (tenant identification, connected to LinkedIn + Bureau of Labor + Yelp/Google + BadgeData), LOI Agent (document review, connected to DocuSign + Internal Templates), Outreach Agent (email drafting, connected to CRM + Email + LinkedIn), Permit Agent (zoning/permits, connected to City Planning Portal + County Records), Macro Agent (rate/macro signals, connected to Federal Reserve + Bloomberg + Treasury.gov). All active and processing in real-time.',
  'rent': 'Average asking rents by submarket: Century City $82/SF (premium), Santa Monica $72/SF, Playa Vista $68/SF, Culver City $62/SF, SF Financial $68/SF, SF SOMA $62/SF, Bellevue $58/SF, Manhattan Beach $56/SF, DTLA $54/SF, Burbank $52/SF.',
  'dtla': 'DTLA vacancy is 18.4% (‚ñ≤ 1.2% over 90 days). 2.4M SF available. Avg rent: $54/SF. Key tenants: Wells Fargo, Deloitte, CBRE. Outlook: High vacancy persists with sublease space still entering market. Watch for office-to-residential conversions like 1150 S Olive St.',
  'santa monica': 'Santa Monica vacancy is 9.8% (‚ñº 1.1% over 90 days). 620K SF available. Avg rent: $72/SF. Key tenants: Snap Inc. (departing Q2), Hulu, Kite Pharma. Snap departure creates 42K SF opportunity. 3 TAMI tenants actively searching.',
  'culver': 'Culver City vacancy is 11.2% (‚ñº 0.6% over 90 days). 890K SF available. Avg rent: $62/SF. Key tenants: Amazon Studios, Apple TV+, Sony. Media & entertainment driving absorption. Netflix HQ expansion deal ($42M) could absorb 60K SF.',
  'playa': 'Playa Vista vacancy is 8.1% (‚ñº 0.9% over 90 days). 410K SF available. Avg rent: $68/SF. Key tenants: Google, Facebook, IMAX. Tightest Westside submarket. Badge-in data: 74% occupancy vs 61% DTLA avg.',
  'sf': 'San Francisco office market: Financial District at 26.3% vacancy (highest in 18mo), SOMA at 22.1%, Mission at 14.8%. Combined 21.4M SF available. AI/ML startups beginning to backfill some tech downsizing but not enough to offset.',
  'seattle': 'Seattle metro: Bellevue 9.2% vacancy (‚ñº 1.0%), Seattle SLU 11.0% (‚ñº 0.6%). Amazon RTO policies driving significant absorption. Bellevue Spring Lane development 80% pre-leased. Strongest performing West Coast metro.',
  'zoning': 'Permit Agent tracking 3 active zoning filings: 1) 1150 S Olive St DTLA ‚Äî mixed-use conversion removing 180K SF office inventory, hearing Mar 15. 2) 2400 Colorado Ave SM ‚Äî tech campus expansion filing. 3) 8500 Beverly Blvd ‚Äî medical office conversion.',
  'outreach': 'Outreach Agent has 5 active drafts: 1) Snap space ‚Äî 3 TAMI tenant pitches (ready), 2) Netflix follow-up (scheduled), 3) TechCo initial outreach (generating), 4) Meridian Health proposal package (pending), 5) Arclight Partners closing docs (in review).',
  'loi': 'LOI Agent reviewed 8 documents this month. Current active reviews: Apex Capital LOI v3 (2 flagged clauses remaining ‚Äî Sec 4.2 co-tenancy still non-standard), Summit Legal LOI (clean, standard terms). Average review time: 4.2 minutes. 94% clause detection accuracy.',
  'data': 'Data sources connected: CoStar Group (premium, real-time listings), LoopNet (public listings), County Recorder (ownership/transactions), Census/BLS (employment/demographics), LinkedIn (hiring signals), City Planning Portal (permits/zoning), Federal Reserve (macro data), Bloomberg (financial markets). 6 premium sources, 4 public, 2 integration.',
  'close': 'Deals expected to close soon: Arclight Partners (Mar 2026, $28M, 92% prob), Apex Capital (Mar 2026, $19M, 88% prob), Summit Legal (Apr 2026, $7.8M, 82% prob), Netflix (Apr 2026, $42M, 72% prob). Total near-term: $96.8M.',
  'revenue': 'Projected Q1 2026 revenue from closing deals: $96.8M pipeline value. Commission potential (est. 4-6%): $3.9M-$5.8M. Year-to-date closed: $32M (2 deals). Active pipeline weighted value: $141M.',
  'compare': 'Quarter-over-quarter comparison: Pipeline value up 12.4% ($218M vs $194M). Deal count up 2 (14 vs 12). Win rate improved 68% vs 63%. Agent-sourced leads up 35% (31 vs 23). Average deal size up 8% ($15.6M vs $14.4M).',
  'risk': 'Pipeline risks: 1) TechCo may delay to Q4 (funding round dependent), 2) Horizon Biotech needs specialized wet lab space (limited supply), 3) Verde Architects budget-constrained, 4) DTLA vacancy could impact Wilshire Corridor deals. Mitigation: diversified across 8 submarkets.'
};

function sendAgentChat() {
  const input = document.getElementById('agent-chat-input');
  const msgArea = document.getElementById('agent-chat-messages');
  const query = input.value.trim();
  if (!query) return;

  msgArea.style.display = 'block';

  // Add user message
  msgArea.innerHTML += `<div style="padding:6px 10px;margin-bottom:6px;background:var(--surface-2);border-radius:6px 6px 2px 6px;font-size:12px;color:var(--cream);text-align:right;"><strong>You:</strong> ${query}</div>`;

  // Generate response based on keywords
  const q = query.toLowerCase();
  let response = '';
  for (const [key, val] of Object.entries(agentChatKnowledge)) {
    if (q.includes(key)) { response = val; break; }
  }
  // Broader keyword matching
  if (!response) {
    if (q.includes('deal') || q.includes('pipeline') || q.includes('how many')) response = agentChatKnowledge['pipeline'];
    else if (q.includes('lead') || q.includes('tenant') || q.includes('prospect')) response = agentChatKnowledge['leads'];
    else if (q.includes('vacant') || q.includes('vacancy') || q.includes('office') || q.includes('available')) response = agentChatKnowledge['vacancy'];
    else if (q.includes('rate') || q.includes('fed') || q.includes('cap') || q.includes('treasury') || q.includes('macro')) response = agentChatKnowledge['interest'];
    else if (q.includes('agent') || q.includes('bot') || q.includes('ai') || q.includes('source')) response = agentChatKnowledge['agents'];
    else if (q.includes('west') || q.includes('la ') || q.includes('los angeles') || q.includes('market overview')) response = agentChatKnowledge['market'];
    else if (q.includes('rent') || q.includes('asking') || q.includes('price') || q.includes('cost')) response = agentChatKnowledge['rent'];
    else if (q.includes('downtown') || q.includes('dtla')) response = agentChatKnowledge['dtla'];
    else if (q.includes('santa monica') || q.includes(' sm ') || q.includes('colorado ave')) response = agentChatKnowledge['santa monica'];
    else if (q.includes('culver')) response = agentChatKnowledge['culver'];
    else if (q.includes('playa')) response = agentChatKnowledge['playa'];
    else if (q.includes('san francisco') || q.includes(' sf ') || q.includes('financial district') || q.includes('soma')) response = agentChatKnowledge['sf'];
    else if (q.includes('seattle') || q.includes('bellevue') || q.includes('amazon')) response = agentChatKnowledge['seattle'];
    else if (q.includes('zone') || q.includes('zoning') || q.includes('permit') || q.includes('filing') || q.includes('conversion')) response = agentChatKnowledge['zoning'];
    else if (q.includes('outreach') || q.includes('email') || q.includes('draft') || q.includes('pitch')) response = agentChatKnowledge['outreach'];
    else if (q.includes('loi') || q.includes('letter of intent') || q.includes('clause') || q.includes('redline') || q.includes('document')) response = agentChatKnowledge['loi'];
    else if (q.includes('data') || q.includes('source') || q.includes('costar') || q.includes('connected') || q.includes('integration')) response = agentChatKnowledge['data'];
    else if (q.includes('close') || q.includes('closing') || q.includes('when') || q.includes('timeline')) response = agentChatKnowledge['close'];
    else if (q.includes('revenue') || q.includes('commission') || q.includes('money') || q.includes('earning')) response = agentChatKnowledge['revenue'];
    else if (q.includes('compare') || q.includes('quarter') || q.includes('growth') || q.includes('trend') || q.includes('performance')) response = agentChatKnowledge['compare'];
    else if (q.includes('risk') || q.includes('concern') || q.includes('worry') || q.includes('issue') || q.includes('problem')) response = agentChatKnowledge['risk'];
    else if (q.includes('pinnacle') || q.includes('studio')) response = agentChatKnowledge['pinnacle'];
    else if (q.includes('meridian') || q.includes('health')) response = agentChatKnowledge['meridian'];
    else if (q.includes('summit') || q.includes('legal')) response = agentChatKnowledge['summit'];
    else if (q.includes('arclight') || q.includes('partner')) response = agentChatKnowledge['arclight'];
    else if (q.includes('cloudnine') || q.includes('cloud nine') || q.includes('software')) response = agentChatKnowledge['cloudnine'];
    else if (q.includes('phoenix') || q.includes('arizona') || q.includes('southwest')) response = 'Southwest market overview: Phoenix CBD at 15.2% vacancy, Scottsdale 9.8%, Tempe 11.4%. AZ tech corridor (Chandler/Gilbert) extremely tight at 5-7%. Las Vegas Strip recovering at 8.2%. Overall trend: CA companies relocating to AZ driving demand in premium submarkets.';
    else if (q.includes('denver') || q.includes('colorado') || q.includes('mountain') || q.includes('salt lake') || q.includes('utah')) response = 'Mountain region: Denver LoDo 16.4% (oversupply), Denver Tech Center 13.8% (stabilizing), Boulder 8.6% (tight/premium). Salt Lake City 11.2% ‚Äî Silicon Slopes effect continuing. Provo very tight at 7.4%. Bozeman MT and Park City UT ultra-premium with sub-6% vacancy.';
    else if (q.includes('portland') || q.includes('northwest') || q.includes('oregon') || q.includes('boise')) response = 'Northwest market: Seattle/Bellevue strong (9-11% vacancy), Redmond very tight (7.8%, Microsoft effect). Portland Pearl 14.6%, Lloyd 16.8% ‚Äî both struggling. Boise 8.4% ‚Äî benefiting from CA migration. Kirkland WA 6.2% ‚Äî premium biotech/AI hub.';
    else if (q.includes('national') || q.includes('new york') || q.includes('miami') || q.includes('austin') || q.includes('chicago') || q.includes('boston')) response = 'National highlights: Miami Brickell tightest major market at 7.2% (financial migration from NYC). Manhattan 13.2% (recovering). Austin 18.6% (oversupply from boom). Chicago Loop 19.4% (persistent vacancy). Boston Seaport 11.4% (life sciences anchor). Nashville 10.8% (corporate relocations).';
    else response = `I'm scanning my intelligence feeds for "${query}". I can help with: specific deals (Netflix, Apex, TechCo, Pinnacle, Arclight, etc.), submarkets (DTLA, Santa Monica, Playa Vista, SF, Seattle), market data (vacancy, rents, trends), agent activity, pipeline metrics, revenue projections, risk analysis, zoning/permits, outreach status, LOI reviews, and data source connections. What would you like to know?`;
  }

  // Simulate typing delay
  setTimeout(() => {
    msgArea.innerHTML += `<div style="padding:8px 10px;margin-bottom:6px;background:var(--gold-dim);border:1px solid var(--border-gold);border-radius:2px 6px 6px 6px;font-size:12px;color:var(--text);line-height:1.5;"><strong style="color:var(--gold);">Agent:</strong> ${response}</div>`;
    msgArea.scrollTop = msgArea.scrollHeight;
  }, 400);

  input.value = '';
  msgArea.scrollTop = msgArea.scrollHeight;
}

// ‚îÄ‚îÄ‚îÄ PIPELINE IMPORT ‚îÄ‚îÄ‚îÄ
function showPipelineImport() {
  showModal('Import Data', 'Pipeline Import',
    `<div style="font-size:13px;color:var(--text);line-height:1.6;margin-bottom:16px;">Import deals from a CSV or Excel file, or generate example data to populate your dashboard.</div>`
    + `<div style="font-family:'JetBrains Mono',monospace;font-size:9px;color:var(--gold);letter-spacing:0.1em;margin-bottom:8px;">EXPECTED CSV FORMAT</div>`
    + `<div style="background:var(--surface-2);border:1px solid var(--border);border-radius:6px;padding:12px;font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--text-mid);line-height:1.6;margin-bottom:16px;">Tenant,Type,Market,SF,Value,Stage,Probability,Close,Contact<br>Netflix Inc.,HQ Expansion,Culver City,60000,$42M,Proposal,72,Apr '26,Sarah Chen</div>`
    + `<div style="display:flex;gap:8px;">
      <label style="flex:1;padding:12px;background:var(--gold);color:#0A0C0E;border:none;border-radius:4px;font-weight:700;font-family:'Syne',sans-serif;font-size:12px;cursor:pointer;text-align:center;">
        Upload CSV / Excel <input type="file" accept=".csv,.xlsx,.xls" onchange="importPipelineCSV(event)" style="display:none;" />
      </label>
      <button onclick="closeModal();showToast('AI-generated example deals loaded into pipeline')" style="flex:1;padding:12px;background:var(--surface-2);border:1px solid var(--border);border-radius:4px;color:var(--gold);font-family:'Syne',sans-serif;font-size:12px;cursor:pointer;">Generate AI Examples ‚ú¶</button>
    </div>`
    + `<div style="margin-top:12px;font-size:11px;color:var(--text-dim);">Supported formats: .csv, .xlsx, .xls. Max 500 deals per import.</div>`
  );
}

function importPipelineCSV(event) {
  const file = event.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = function(e) {
    const lines = e.target.result.split('\n').filter(l => l.trim());
    if (lines.length < 2) { showToast('File appears empty or invalid'); return; }
    const count = lines.length - 1; // minus header
    closeModal();
    showToast(`${count} deal${count > 1 ? 's' : ''} imported from ${file.name}`);
  };
  reader.readAsText(file);
}

// ‚îÄ‚îÄ‚îÄ ACTION DOTS (‚ãØ) ON PIPELINE ‚îÄ‚îÄ‚îÄ
document.querySelectorAll('.action-dots').forEach((dots, i) => {
  dots.style.cursor = 'pointer';
  dots.addEventListener('click', (e) => {
    e.stopPropagation();
    const d = dealDetails[i];
    if (!d) return;
    showModal('Deal Actions', d.name,
      `<div style="display:flex;flex-direction:column;gap:8px;">`
      + `<button onclick="actionEditDealDetail(${i})" style="padding:12px;background:var(--surface-2);border:1px solid var(--border);border-radius:6px;color:var(--cream);font-family:'Syne',sans-serif;font-size:13px;cursor:pointer;text-align:left;">üìù Edit Deal Details</button>`
      + `<button onclick="actionUpdateStage(${i})" style="padding:12px;background:var(--surface-2);border:1px solid var(--border);border-radius:6px;color:var(--cream);font-family:'Syne',sans-serif;font-size:13px;cursor:pointer;text-align:left;">üìä Update Stage</button>`
      + `<button onclick="actionDealFollowUp(${i})" style="padding:12px;background:var(--surface-2);border:1px solid var(--border);border-radius:6px;color:var(--cream);font-family:'Syne',sans-serif;font-size:13px;cursor:pointer;text-align:left;">‚úâÔ∏è Draft Follow-Up</button>`
      + `<button onclick="actionExportCRM(${i})" style="padding:12px;background:var(--surface-2);border:1px solid var(--border);border-radius:6px;color:var(--cream);font-family:'Syne',sans-serif;font-size:13px;cursor:pointer;text-align:left;">üìã Export to CRM</button>`
      + `<button onclick="actionArchiveDeal(${i})" style="padding:12px;background:var(--red-dim);border:1px solid rgba(192,83,58,0.2);border-radius:6px;color:var(--red);font-family:'Syne',sans-serif;font-size:13px;cursor:pointer;text-align:left;">üóë Archive Deal</button>`
      + `</div>`
    );
  });
});

// ‚îÄ‚îÄ‚îÄ SIDEBAR TOGGLE FOR MOBILE ‚îÄ‚îÄ‚îÄ
(function() {
  const sidebarToggle = document.getElementById('sidebar-toggle');
  const sidebar = document.getElementById('sidebar');

  if (sidebarToggle && sidebar) {
    sidebarToggle.addEventListener('click', function(e) {
      e.preventDefault();
      sidebarToggle.classList.toggle('active');
      sidebar.classList.toggle('active');
    });

    // Close sidebar when clicking on a nav item
    sidebar.querySelectorAll('.nav-item').forEach(item => {
      item.addEventListener('click', function() {
        sidebarToggle.classList.remove('active');
        sidebar.classList.remove('active');
      });
    });

    // Close sidebar when clicking outside (only on mobile)
    document.addEventListener('click', function(event) {
      if (window.innerWidth <= 900) {
        if (!sidebar.contains(event.target) && !sidebarToggle.contains(event.target)) {
          sidebarToggle.classList.remove('active');
          sidebar.classList.remove('active');
        }
      }
    });
  }
})();

// ‚îÄ‚îÄ‚îÄ DYNAMIC DATE ‚îÄ‚îÄ‚îÄ
(function() {
  const el = document.getElementById('topbar-date');
  if (!el) return;
  const now = new Date();
  const days = ['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];
  const months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  const h = now.getHours(), m = now.getMinutes();
  const ampm = h >= 12 ? 'PM' : 'AM';
  const h12 = h % 12 || 12;
  const mm = m < 10 ? '0' + m : m;
  const tz = Intl.DateTimeFormat().resolvedOptions().timeZone;
  const tzAbbr = now.toLocaleTimeString('en-US', {timeZoneName:'short'}).split(' ').pop();
  el.textContent = `${days[now.getDay()]}, ${months[now.getMonth()]} ${now.getDate()}, ${now.getFullYear()} ¬∑ ${h12}:${mm} ${ampm} ${tzAbbr}`;
})();

// ‚îÄ‚îÄ‚îÄ HEATMAP REGION SWITCHING ‚îÄ‚îÄ‚îÄ
const heatmapRegions = {
  'west-coast': [
    { market: 'DTLA', val: '18.4%', bg: 'rgba(192,83,58,0.55)' },
    { market: 'Culver City', val: '11.2%', bg: 'rgba(196,158,84,0.45)' },
    { market: 'Santa Monica', val: '9.8%', bg: 'rgba(74,127,165,0.5)' },
    { market: 'Playa Vista', val: '8.1%', bg: 'rgba(74,127,165,0.35)' },
    { market: 'El Segundo', val: '6.7%', bg: 'rgba(74,155,111,0.45)' },
    { market: 'Century City', val: '12.6%', bg: 'rgba(196,158,84,0.35)' },
    { market: 'West Hollywood', val: '7.3%', bg: 'rgba(74,155,111,0.35)' },
    { market: 'Wilshire Corridor', val: '16.1%', bg: 'rgba(192,83,58,0.4)' },
    { market: 'Burbank', val: '10.4%', bg: 'rgba(74,127,165,0.42)' },
    { market: 'Manhattan Bch', val: '5.9%', bg: 'rgba(74,155,111,0.5)' },
    { market: 'SF Financial', val: '26.3%', bg: 'rgba(192,83,58,0.65)' },
    { market: 'SF SOMA', val: '22.1%', bg: 'rgba(192,83,58,0.45)' },
    { market: 'SF Mission', val: '14.8%', bg: 'rgba(74,127,165,0.4)' },
    { market: 'Bellevue WA', val: '9.2%', bg: 'rgba(74,155,111,0.45)' },
    { market: 'Seattle SLU', val: '11.0%', bg: 'rgba(74,127,165,0.38)' }
  ],
  'southwest': [
    { market: 'Phoenix CBD', val: '15.2%', bg: 'rgba(192,83,58,0.4)' },
    { market: 'Scottsdale', val: '9.8%', bg: 'rgba(74,127,165,0.45)' },
    { market: 'Tempe', val: '11.4%', bg: 'rgba(74,127,165,0.5)' },
    { market: 'Las Vegas Strip', val: '8.2%', bg: 'rgba(74,155,111,0.4)' },
    { market: 'Henderson NV', val: '7.1%', bg: 'rgba(74,155,111,0.45)' },
    { market: 'Tucson', val: '13.6%', bg: 'rgba(196,158,84,0.4)' },
    { market: 'Albuquerque', val: '14.1%', bg: 'rgba(196,158,84,0.45)' },
    { market: 'Mesa AZ', val: '10.8%', bg: 'rgba(74,127,165,0.42)' },
    { market: 'Chandler AZ', val: '6.9%', bg: 'rgba(74,155,111,0.5)' },
    { market: 'Gilbert AZ', val: '5.4%', bg: 'rgba(74,155,111,0.55)' }
  ],
  'northwest': [
    { market: 'Seattle SLU', val: '11.0%', bg: 'rgba(74,127,165,0.38)' },
    { market: 'Bellevue WA', val: '9.2%', bg: 'rgba(74,155,111,0.45)' },
    { market: 'Redmond WA', val: '7.8%', bg: 'rgba(74,155,111,0.4)' },
    { market: 'Portland Pearl', val: '14.6%', bg: 'rgba(196,158,84,0.45)' },
    { market: 'Portland Lloyd', val: '16.8%', bg: 'rgba(192,83,58,0.4)' },
    { market: 'Boise ID', val: '8.4%', bg: 'rgba(74,155,111,0.4)' },
    { market: 'Tacoma WA', val: '12.3%', bg: 'rgba(74,127,165,0.45)' },
    { market: 'Kirkland WA', val: '6.2%', bg: 'rgba(74,155,111,0.5)' },
    { market: 'Eugene OR', val: '10.1%', bg: 'rgba(74,127,165,0.4)' },
    { market: 'Spokane WA', val: '11.7%', bg: 'rgba(74,127,165,0.42)' }
  ],
  'mountain': [
    { market: 'Denver LoDo', val: '16.4%', bg: 'rgba(192,83,58,0.4)' },
    { market: 'Denver Tech Ctr', val: '13.8%', bg: 'rgba(196,158,84,0.42)' },
    { market: 'Boulder CO', val: '8.6%', bg: 'rgba(74,155,111,0.4)' },
    { market: 'Salt Lake City', val: '11.2%', bg: 'rgba(74,127,165,0.45)' },
    { market: 'Provo UT', val: '7.4%', bg: 'rgba(74,155,111,0.42)' },
    { market: 'Reno NV', val: '9.8%', bg: 'rgba(74,127,165,0.4)' },
    { market: 'Colorado Springs', val: '10.5%', bg: 'rgba(74,127,165,0.42)' },
    { market: 'Fort Collins', val: '8.1%', bg: 'rgba(74,155,111,0.38)' },
    { market: 'Bozeman MT', val: '5.8%', bg: 'rgba(74,155,111,0.5)' },
    { market: 'Park City UT', val: '6.2%', bg: 'rgba(74,155,111,0.48)' }
  ],
  'national': [
    { market: 'Manhattan NYC', val: '13.2%', bg: 'rgba(196,158,84,0.4)' },
    { market: 'Chicago Loop', val: '19.4%', bg: 'rgba(192,83,58,0.5)' },
    { market: 'Austin TX', val: '18.6%', bg: 'rgba(192,83,58,0.45)' },
    { market: 'Nashville TN', val: '10.8%', bg: 'rgba(74,127,165,0.42)' },
    { market: 'Miami Brickell', val: '7.2%', bg: 'rgba(74,155,111,0.45)' },
    { market: 'Dallas Uptown', val: '15.1%', bg: 'rgba(192,83,58,0.38)' },
    { market: 'Atlanta Midtown', val: '16.7%', bg: 'rgba(192,83,58,0.42)' },
    { market: 'Boston Seaport', val: '11.4%', bg: 'rgba(74,127,165,0.45)' },
    { market: 'DC Georgetown', val: '12.8%', bg: 'rgba(74,127,165,0.5)' },
    { market: 'San Diego', val: '9.6%', bg: 'rgba(74,127,165,0.38)' }
  ]
};

function switchHeatmapRegion(region, tabEl) {
  document.querySelectorAll('.heatmap-tab').forEach(t => t.classList.remove('active'));
  if (tabEl) tabEl.classList.add('active');
  const grid = document.getElementById('heatmap-grid');
  if (!grid) return;
  const cells = heatmapRegions[region] || heatmapRegions['west-coast'];
  grid.innerHTML = cells.map(c =>
    `<div class="heatmap-cell" style="background:${c.bg}" onclick="showHeatmapDetail('${c.market.replace(/'/g,"\\'")}')"><div class="heat-market">${c.market}</div><div class="heat-val">${c.val}</div></div>`
  ).join('');
}

function showHeatmapDetail(market) {
  const d = heatmapDetail[market];
  if (!d) {
    showModal('Submarket Detail', market,
      `<div style="font-size:13px;color:var(--text);line-height:1.7;">Detailed analytics for ${market} are being compiled by your Intel Agent. Check back shortly for vacancy trends, rent comps, and tenant activity.</div>`
      + `<div style="margin-top:12px;padding:10px;background:var(--gold-dim);border:1px solid var(--border-gold);border-radius:6px;font-size:12px;color:var(--gold);">Tip: Add this submarket to your Active Watches for real-time monitoring.</div>`
    );
    return;
  }
  showModal('Submarket Detail', market,
    detailRow('Vacancy Rate', d.vacancy, parseFloat(d.vacancy) > 15 ? 'var(--red)' : parseFloat(d.vacancy) > 10 ? 'var(--amber)' : 'var(--green)')
    + detailRow('90-Day Trend', d.trend, d.trend.includes('‚ñ≤') ? 'var(--red)' : 'var(--green)')
    + detailRow('Available SF', d.available, 'var(--cream)')
    + detailRow('Avg. Asking Rent', d.avgRent, 'var(--gold)')
    + detailRow('Key Tenants', d.topTenants, 'var(--cream)')
    + `<div style="margin-top:16px;padding:12px;background:var(--surface-2);border:1px solid var(--border);border-radius:6px;font-size:12px;color:var(--text);line-height:1.5;"><strong style="color:var(--cream);">Outlook:</strong> ${d.outlook}</div>`
  );
}

// ‚îÄ‚îÄ‚îÄ VIEW SYSTEM ‚îÄ‚îÄ‚îÄ
// Stores default content HTML to restore dashboard view
let defaultContentHTML = null;
let currentView = 'dashboard';

function storeDefaultContent() {
  if (!defaultContentHTML) {
    defaultContentHTML = document.querySelector('.content').innerHTML;
  }
}

function switchView(viewName) {
  storeDefaultContent();
  currentView = viewName;
  const content = document.querySelector('.content');
  const topTitle = document.querySelector('.topbar-title');

  // Update sidebar active state
  document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));

  if (viewName === 'dashboard') {
    content.innerHTML = defaultContentHTML;
    content.style.display = '';
    content.style.gridTemplateColumns = '';
    if (topTitle) topTitle.textContent = 'Morning Brief';
    rebindDashboardEvents();
    return;
  }

  // All other views render as single-column full content
  content.style.display = 'block';

  const views = {
    'morning-brief': renderMorningBrief,
    'agent-fleet': renderAgentFleet,
    'pipeline': renderPipeline,
    'market-intel': renderMarketIntel,
    'tenant-leads': renderTenantLeads,
    'west-coast-report': renderWestCoastReport,
    'submarket-tracker': renderSubmarketTracker,
    'portfolio-analysis': renderPortfolioAnalysis,
    'preferences': renderPreferences,
    'brief-schedule': renderBriefSchedule
  };

  const renderer = views[viewName];
  if (renderer) {
    content.innerHTML = renderer();
    if (topTitle) topTitle.textContent = getViewTitle(viewName);
  }
}

function getViewTitle(view) {
  const titles = {
    'morning-brief': "Today's Morning Brief",
    'agent-fleet': 'Agent Fleet',
    'pipeline': 'Deal Pipeline',
    'market-intel': 'Market Intelligence',
    'tenant-leads': 'Tenant Leads',
    'west-coast-report': 'West Coast Markets Report',
    'submarket-tracker': 'Submarket Tracker',
    'portfolio-analysis': 'Portfolio Analysis',
    'preferences': 'Settings & Preferences',
    'brief-schedule': 'Brief Schedule'
  };
  return titles[view] || 'Dashboard';
}

function viewSection(title) {
  return `<div style="font-family:'JetBrains Mono',monospace;font-size:9px;letter-spacing:0.15em;text-transform:uppercase;color:var(--gold);margin:24px 0 12px;display:flex;align-items:center;gap:10px;">${title}<div style="flex:1;height:1px;background:var(--border);"></div></div>`;
}
function viewCard(content) {
  return `<div style="background:var(--surface);border:1px solid var(--border);border-radius:6px;padding:20px;margin-bottom:12px;">${content}</div>`;
}
function editableRow(label, value, id, type='text', options) {
  if (type === 'select' && options) {
    const opts = options.map(o => `<option value="${o}" ${o === value ? 'selected' : ''}>${o}</option>`).join('');
    return `<div style="display:flex;justify-content:space-between;align-items:center;padding:10px 0;border-bottom:1px solid var(--border);">
      <span style="font-size:12px;color:var(--text-mid);">${label}</span>
      <select id="${id}" style="background:var(--surface-2);border:1px solid var(--border);border-radius:4px;padding:6px 10px;color:var(--cream);font-family:'Syne',sans-serif;font-size:12px;outline:none;min-width:180px;" onchange="markSettingChanged(this)">${opts}</select>
    </div>`;
  }
  if (type === 'toggle') {
    const checked = value === true || value === 'on';
    return `<div style="display:flex;justify-content:space-between;align-items:center;padding:10px 0;border-bottom:1px solid var(--border);">
      <span style="font-size:12px;color:var(--text-mid);">${label}</span>
      <label style="position:relative;display:inline-block;width:40px;height:22px;cursor:pointer;">
        <input type="checkbox" id="${id}" ${checked ? 'checked' : ''} style="opacity:0;width:0;height:0;" onchange="markSettingChanged(this)">
        <span style="position:absolute;inset:0;background:${checked ? 'var(--gold)' : 'var(--surface-3)'};border-radius:11px;transition:0.3s;border:1px solid var(--border);" onclick="this.previousElementSibling.click();"></span>
        <span style="position:absolute;left:${checked ? '20px' : '2px'};top:2px;width:16px;height:16px;background:var(--cream);border-radius:50%;transition:0.3s;" onclick="this.previousElementSibling.previousElementSibling.click();"></span>
      </label>
    </div>`;
  }
  return `<div style="display:flex;justify-content:space-between;align-items:center;padding:10px 0;border-bottom:1px solid var(--border);">
    <span style="font-size:12px;color:var(--text-mid);">${label}</span>
    <input id="${id}" type="${type}" value="${value}" style="background:var(--surface-2);border:1px solid var(--border);border-radius:4px;padding:6px 10px;color:var(--cream);font-family:'Syne',sans-serif;font-size:12px;outline:none;text-align:right;min-width:180px;" onchange="markSettingChanged(this)">
  </div>`;
}

function markSettingChanged(el) {
  el.style.borderColor = 'var(--gold)';
  const saveBtn = document.getElementById('settings-save-btn');
  if (saveBtn) { saveBtn.style.opacity = '1'; saveBtn.disabled = false; }
}

function saveSettings() {
  const saveBtn = document.getElementById('settings-save-btn');
  if (saveBtn) {
    saveBtn.textContent = '‚úì Saved';
    saveBtn.style.background = 'var(--green)';
    setTimeout(() => { saveBtn.textContent = 'Save Changes'; saveBtn.style.background = 'var(--gold)'; saveBtn.style.opacity = '0.5'; saveBtn.disabled = true; }, 2000);
  }
  const toast = document.getElementById('toast');
  toast.innerHTML = `<div class="toast-icon">‚úÖ</div><div class="toast-text"><strong>Settings saved.</strong> Changes will take effect immediately.</div>`;
  toast.classList.add('show');
  setTimeout(() => toast.classList.remove('show'), 3000);
}

// ‚îÄ‚îÄ‚îÄ MORNING BRIEF VIEW ‚îÄ‚îÄ‚îÄ
function renderMorningBrief() {
  const now = new Date();
  const dateStr = now.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
  return `<div style="max-width:900px;">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:20px;">
      <div>
        <div style="font-family:'Cormorant Garamond',serif;font-size:28px;font-weight:600;color:var(--cream);">Morning Brief</div>
        <div style="font-size:12px;color:var(--text-dim);margin-top:4px;">${dateStr} ¬∑ Delivered 6:00 AM PST</div>
      </div>
      <div style="display:flex;gap:8px;">
        <button onclick="showEditBriefModal()" style="padding:8px 16px;background:var(--surface-2);border:1px solid var(--border);border-radius:4px;color:var(--text);font-family:'Syne',sans-serif;font-size:11px;cursor:pointer;">‚öô Configure Brief</button>
        <button style="padding:8px 16px;background:var(--surface-2);border:1px solid var(--border);border-radius:4px;color:var(--text);font-family:'Syne',sans-serif;font-size:11px;cursor:pointer;">‚Üó Share Brief</button>
      </div>
    </div>
    ${viewSection('Executive Summary')}
    ${viewCard(`<div style="font-size:13px;color:var(--text);line-height:1.8;">
      <p style="margin-bottom:12px;">Pipeline value reached <strong style="color:var(--gold);">$218M</strong> (+12.4% QoQ), with 14 active deals across 8 West Coast submarkets. Three new deals entered the pipeline this month, including a major Netflix HQ expansion in Culver City.</p>
      <p style="margin-bottom:12px;">Key overnight development: <strong style="color:var(--cream);">Snap Inc. is vacating 42,000 SF</strong> at 2101 Colorado Ave, Santa Monica. Your agents have identified 3 TAMI tenants currently searching this submarket. First-mover window is approximately 6 weeks.</p>
      <p>LA metro vacancy continued its downward trend at <strong style="color:var(--green);">14.2%</strong> (‚ñº 0.8% over 90 days), while SF Financial District rose to 26.3% ‚Äî its highest in 18 months.</p>
    </div>`)}
    ${viewSection('Priority Actions ‚Äî 3 Items')}
    ${viewCard(`<div style="display:flex;flex-direction:column;gap:8px;">
      <div style="display:flex;gap:12px;padding:12px;background:var(--red-dim);border:1px solid rgba(192,83,58,0.2);border-left:3px solid var(--red);border-radius:6px;cursor:pointer;" onclick="showModal('Action','Snap Vacancy ‚Äî Draft Outreach','<div style=\\'font-size:13px;color:var(--text);line-height:1.7;\\'>Outreach Agent has 3 tenant matches ready. Review and send personalized pitches to TechCo, WestShore Media, and Shopify.</div>')">
        <div style="font-size:18px;">‚ö°</div>
        <div style="flex:1;"><div style="font-size:13px;font-weight:600;color:var(--cream);margin-bottom:2px;">Draft outreach for Snap vacancy ‚Äî 3 matching tenants</div><div style="font-size:11px;color:var(--text-mid);">Santa Monica ¬∑ 42K SF ¬∑ 6-week window ¬∑ Intel Agent</div></div>
        <div style="font-family:'JetBrains Mono',monospace;font-size:8px;color:var(--red);align-self:center;">URGENT</div>
      </div>
      <div style="display:flex;gap:12px;padding:12px;background:var(--gold-dim);border:1px solid var(--border-gold);border-left:3px solid var(--gold);border-radius:6px;cursor:pointer;">
        <div style="font-size:18px;">üìã</div>
        <div style="flex:1;"><div style="font-size:13px;font-weight:600;color:var(--cream);margin-bottom:2px;">Review LOI clause mismatch ‚Äî Apex Capital</div><div style="font-size:11px;color:var(--text-mid);">Century City ¬∑ Sections 4.2 & 7 flagged ¬∑ LOI Agent</div></div>
        <div style="font-family:'JetBrains Mono',monospace;font-size:8px;color:var(--gold);align-self:center;">HIGH</div>
      </div>
      <div style="display:flex;gap:12px;padding:12px;background:var(--surface-2);border:1px solid var(--border);border-left:3px solid var(--blue);border-radius:6px;cursor:pointer;">
        <div style="font-size:18px;">üéØ</div>
        <div style="flex:1;"><div style="font-size:13px;font-weight:600;color:var(--cream);margin-bottom:2px;">Qualify TechCo Inc. ‚Äî high expansion signal</div><div style="font-size:11px;color:var(--text-mid);">Playa Vista ¬∑ 40+ jobs, WeWork badge-in +62% ¬∑ Lead Agent</div></div>
        <div style="font-family:'JetBrains Mono',monospace;font-size:8px;color:var(--blue);align-self:center;">MEDIUM</div>
      </div>
    </div>`)}
    ${viewSection('Market Snapshot')}
    ${viewCard(`<div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;">
      <div style="padding:14px;background:var(--surface-2);border:1px solid var(--border);border-radius:6px;"><div style="font-family:'JetBrains Mono',monospace;font-size:7px;letter-spacing:0.15em;color:var(--text-dim);margin-bottom:6px;">LA METRO AVG VACANCY</div><div style="font-family:'Cormorant Garamond',serif;font-size:24px;color:var(--cream);">14.2%</div><div style="font-size:10px;color:var(--green);margin-top:4px;">‚ñº 0.8% (90d)</div></div>
      <div style="padding:14px;background:var(--surface-2);border:1px solid var(--border);border-radius:6px;"><div style="font-family:'JetBrains Mono',monospace;font-size:7px;letter-spacing:0.15em;color:var(--text-dim);margin-bottom:6px;">SF METRO AVG VACANCY</div><div style="font-family:'Cormorant Garamond',serif;font-size:24px;color:var(--red);">21.1%</div><div style="font-size:10px;color:var(--red);margin-top:4px;">‚ñ≤ 1.2% (90d)</div></div>
      <div style="padding:14px;background:var(--surface-2);border:1px solid var(--border);border-radius:6px;"><div style="font-family:'JetBrains Mono',monospace;font-size:7px;letter-spacing:0.15em;color:var(--text-dim);margin-bottom:6px;">SEATTLE METRO AVG VACANCY</div><div style="font-family:'Cormorant Garamond',serif;font-size:24px;color:var(--green);">10.1%</div><div style="font-size:10px;color:var(--green);margin-top:4px;">‚ñº 0.8% (90d)</div></div>
    </div>`)}
    ${viewSection('Agent Activity Summary (24h)')}
    ${viewCard(`<div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;">
      <div style="display:flex;gap:8px;align-items:center;padding:10px;background:var(--surface-2);border-radius:4px;">
        <div style="font-size:14px;">üåê</div><div><div style="font-size:11px;font-weight:600;color:var(--cream);">Intel Agent</div><div style="font-size:10px;color:var(--green);">4 updates</div></div>
      </div>
      <div style="display:flex;gap:8px;align-items:center;padding:10px;background:var(--surface-2);border-radius:4px;">
        <div style="font-size:14px;">üéØ</div><div><div style="font-size:11px;font-weight:600;color:var(--cream);">Lead Agent</div><div style="font-size:10px;color:var(--green);">3 leads found</div></div>
      </div>
      <div style="display:flex;gap:8px;align-items:center;padding:10px;background:var(--surface-2);border-radius:4px;">
        <div style="font-size:14px;">üìã</div><div><div style="font-size:11px;font-weight:600;color:var(--cream);">LOI Agent</div><div style="font-size:10px;color:var(--gold);">1 doc reviewed</div></div>
      </div>
      <div style="display:flex;gap:8px;align-items:center;padding:10px;background:var(--surface-2);border-radius:4px;">
        <div style="font-size:14px;">‚úâÔ∏è</div><div><div style="font-size:11px;font-weight:600;color:var(--cream);">Outreach Agent</div><div style="font-size:10px;color:var(--gold);">1 draft in progress</div></div>
      </div>
      <div style="display:flex;gap:8px;align-items:center;padding:10px;background:var(--surface-2);border-radius:4px;">
        <div style="font-size:14px;">üì°</div><div><div style="font-size:11px;font-weight:600;color:var(--cream);">Permit Agent</div><div style="font-size:10px;color:var(--green);">1 zoning alert</div></div>
      </div>
      <div style="display:flex;gap:8px;align-items:center;padding:10px;background:var(--surface-2);border-radius:4px;">
        <div style="font-size:14px;">üèõÔ∏è</div><div><div style="font-size:11px;font-weight:600;color:var(--cream);">Macro Agent</div><div style="font-size:10px;color:var(--gold);">Rate watch triggered</div></div>
      </div>
    </div>`)}
    <div style="margin-top:20px;text-align:center;"><button onclick="switchView('dashboard')" style="padding:10px 24px;background:var(--surface-2);border:1px solid var(--border);border-radius:4px;color:var(--text);font-family:'Syne',sans-serif;font-size:12px;cursor:pointer;">‚Üê Back to Dashboard</button></div>
  </div>`;
}

function showEditBriefModal() {
  showModal('Configure', 'Configure Morning Brief',
    editableRow('Delivery Time', '06:00', 'brief-time', 'time')
    + editableRow('Timezone', 'America/Los_Angeles', 'brief-tz', 'select', ['America/Los_Angeles', 'America/New_York', 'America/Chicago', 'America/Denver', 'UTC'])
    + editableRow('Frequency', 'Daily', 'brief-freq', 'select', ['Daily', 'Weekdays Only', 'Mon/Wed/Fri', 'Weekly (Monday)'])
    + editableRow('Delivery Method', 'Dashboard + Email', 'brief-delivery', 'select', ['Dashboard Only', 'Dashboard + Email', 'Dashboard + Email + Slack', 'Email Only'])
    + editableRow('Include Market Snapshot', true, 'brief-market', 'toggle')
    + editableRow('Include Agent Summary', true, 'brief-agents', 'toggle')
    + editableRow('Include Pipeline Updates', true, 'brief-pipeline', 'toggle')
    + editableRow('Include Macro Signals', true, 'brief-macro', 'toggle')
    + `<button id="settings-save-btn" onclick="saveSettings();closeModal();" style="width:100%;margin-top:16px;padding:12px;background:var(--gold);color:#0A0C0E;border:none;border-radius:4px;font-weight:700;font-family:'Syne',sans-serif;font-size:13px;cursor:pointer;opacity:0.5;" disabled>Save Changes</button>`
  );
}

// ‚îÄ‚îÄ‚îÄ AGENT FLEET VIEW ‚îÄ‚îÄ‚îÄ
function renderAgentFleet() {
  const agents = [
    { icon: 'üåê', name: 'Market Intel Agent', status: 'Active', tasks: '4 updates today', desc: 'Monitors vacancy rates, comps, listing activity, and market shifts across your selected submarkets. Pulls live data from connected commercial real estate databases and public records.', config: { markets: '15 submarkets', frequency: 'Realtime', lastRun: '2 min ago' }, sources: [ { name: 'CoStar Group', type: 'Premium', status: 'connected', desc: 'Vacancy, rents, comps, building data' }, { name: 'LoopNet', type: 'Premium', status: 'connected', desc: 'Active listings, asking rents' }, { name: 'County Recorder', type: 'Public', status: 'connected', desc: 'Deed transfers, lease recordings' }, { name: 'Census / BLS', type: 'Public', status: 'connected', desc: 'Employment, demographic data' } ] },
    { icon: 'üéØ', name: 'Lead Finder Agent', status: 'Active', tasks: '3 leads found', desc: 'Identifies high-intent tenant signals ‚Äî job postings, LLC filings, lease expirations, and expansion indicators. Cross-references multiple employment and corporate filing databases.', config: { markets: 'LA Metro, SF Metro', frequency: 'Hourly', lastRun: '14 min ago' }, sources: [ { name: 'Indeed / LinkedIn', type: 'Aggregated', status: 'connected', desc: 'Job postings, headcount signals' }, { name: 'Secretary of State', type: 'Public', status: 'connected', desc: 'LLC filings, entity registrations' }, { name: 'SEC / EDGAR', type: 'Public', status: 'connected', desc: 'Public company filings, 10-K reports' }, { name: 'WeWork Occupancy API', type: 'Premium', status: 'connected', desc: 'Badge-in data, flex space utilization' } ] },
    { icon: 'üìã', name: 'LOI Review Agent', status: 'Active', tasks: '1 doc reviewed', desc: 'Reviews LOIs and lease documents against your gold standard template. Flags non-standard clauses and generates redlines. Uses NLP to compare clause-by-clause against your approved language.', config: { template: 'Savills Gold Standard v3', autoFlag: 'Co-tenancy, Assignment, Exclusivity', lastRun: '31 min ago' }, sources: [ { name: 'Your Document Library', type: 'Private', status: 'connected', desc: 'Gold standard templates, past LOIs' }, { name: 'LexisNexis', type: 'Premium', status: 'available', desc: 'Legal precedent, clause analysis' } ] },
    { icon: '‚úâÔ∏è', name: 'Outreach Agent', status: 'Drafting', tasks: '1 draft in progress', desc: 'Generates personalized tenant pitches using deal history, tenant preferences, and property data. Can integrate with your CRM and email system to send directly.', config: { tone: 'Professional, Consultative', approval: 'Required before send', lastRun: 'Now' }, sources: [ { name: 'Your CRM', type: 'Integration', status: 'available', desc: 'Salesforce, HubSpot, or custom CRM' }, { name: 'Email Provider', type: 'Integration', status: 'available', desc: 'Gmail, Outlook, or SMTP' }, { name: 'Deal History', type: 'Private', status: 'connected', desc: 'Past outreach performance, response rates' } ] },
    { icon: 'üì°', name: 'Zoning Monitor', status: 'Active', tasks: '1 zoning alert', desc: 'Monitors government portals for permit filings, zoning variances, and entitlement changes. Scans municipal planning department sites and public hearing agendas.', config: { markets: 'SM, Culver City, Burbank, DTLA', types: 'Variance, Permit, Use Change', lastRun: '1 hr ago' }, sources: [ { name: 'Municipal Planning Portals', type: 'Public', status: 'connected', desc: 'LA, SM, Burbank, Culver City' }, { name: 'Building & Safety', type: 'Public', status: 'connected', desc: 'Permit applications, plan checks' } ] },
    { icon: 'üèõÔ∏è', name: 'Macro Analyst', status: 'Triggered', tasks: 'Rate watch active', desc: 'Tracks macroeconomic signals ‚Äî interest rates, cap rates, inflation, and their projected impact on CRE valuations. Uses proprietary models to project cap rate movement.', config: { signals: 'Fed Funds, 10Y, CPI', threshold: '¬±25bps', lastRun: '1.5 hr ago' }, sources: [ { name: 'Federal Reserve (FRED)', type: 'Public', status: 'connected', desc: 'Interest rates, monetary policy' }, { name: 'Bloomberg Terminal', type: 'Premium', status: 'available', desc: 'Real-time market data, analytics' }, { name: 'CBRE Econometric Advisors', type: 'Premium', status: 'available', desc: 'CRE-specific forecasting models' } ] }
  ];
  return `<div style="max-width:960px;">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:20px;">
      <div>
        <div style="font-family:'Cormorant Garamond',serif;font-size:28px;font-weight:600;color:var(--cream);">Agent Fleet</div>
        <div style="font-size:12px;color:var(--green);margin-top:4px;">‚óè All 6 agents active ¬∑ Pulling from ${agents.reduce((t,a) => t + a.sources.filter(s => s.status === 'connected').length, 0)} connected data sources</div>
      </div>
      <button onclick="showDataSourcesPanel()" style="padding:8px 16px;background:var(--gold);color:#0A0C0E;border:none;border-radius:4px;font-weight:600;font-family:'Syne',sans-serif;font-size:11px;cursor:pointer;">+ Connect Data Source</button>
    </div>
    ${agents.map(a => viewCard(`
      <div style="display:flex;gap:16px;align-items:flex-start;">
        <div style="width:44px;height:44px;border-radius:8px;background:var(--gold-dim);border:1px solid var(--border-gold);display:flex;align-items:center;justify-content:center;font-size:20px;flex-shrink:0;">${a.icon}</div>
        <div style="flex:1;min-width:0;">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;">
            <div style="font-size:15px;font-weight:600;color:var(--cream);">${a.name}</div>
            <div style="display:flex;gap:8px;align-items:center;">
              <span style="font-family:'JetBrains Mono',monospace;font-size:9px;color:${a.status === 'Active' ? 'var(--green)' : 'var(--gold)'};">‚óè ${a.status}</span>
              <span style="font-family:'JetBrains Mono',monospace;font-size:9px;color:var(--text-dim);">${a.tasks}</span>
            </div>
          </div>
          <div style="font-size:12px;color:var(--text-mid);line-height:1.6;margin-bottom:10px;">${a.desc}</div>
          <div style="display:flex;flex-wrap:wrap;gap:6px;margin-bottom:10px;">
            ${Object.entries(a.config).map(([k,v]) => `<span style="font-family:'JetBrains Mono',monospace;font-size:8px;padding:3px 8px;background:var(--surface-2);border:1px solid var(--border);border-radius:3px;color:var(--text-dim);"><strong style="color:var(--text-mid);">${k}:</strong> ${v}</span>`).join('')}
          </div>
          <div style="font-family:'JetBrains Mono',monospace;font-size:8px;color:var(--gold);letter-spacing:0.1em;margin-bottom:6px;">DATA SOURCES</div>
          <div style="display:flex;flex-wrap:wrap;gap:6px;margin-bottom:12px;">
            ${a.sources.map(s => `<span style="font-family:'JetBrains Mono',monospace;font-size:8px;padding:4px 10px;background:${s.status === 'connected' ? 'var(--green-dim)' : 'var(--surface-3)'};border:1px solid ${s.status === 'connected' ? 'rgba(74,155,111,0.2)' : 'var(--border)'};border-radius:3px;color:${s.status === 'connected' ? 'var(--green)' : 'var(--text-dim)'};cursor:pointer;" title="${s.desc}">${s.status === 'connected' ? '‚óè' : '‚óã'} ${s.name} <span style="color:var(--text-dim);">¬∑ ${s.type}</span></span>`).join('')}
          </div>
          <div style="display:flex;gap:8px;">
            <button onclick="showAgentConfig('${a.name.replace(/'/g,"\\'")}')" style="padding:6px 14px;background:var(--surface-2);border:1px solid var(--border);border-radius:4px;color:var(--text);font-family:'Syne',sans-serif;font-size:10px;cursor:pointer;">Configure</button>
            <button onclick="showAgentHistory('${a.name.replace(/'/g,"\\'")}')" style="padding:6px 14px;background:var(--surface-2);border:1px solid var(--border);border-radius:4px;color:var(--text);font-family:'Syne',sans-serif;font-size:10px;cursor:pointer;">View History</button>
            <button onclick="toggleAgentPause(this,'${a.name.replace(/'/g,"\\'")}')" style="padding:6px 14px;background:var(--red-dim);border:1px solid rgba(192,83,58,0.2);border-radius:4px;color:var(--red);font-family:'Syne',sans-serif;font-size:10px;cursor:pointer;">Pause</button>
          </div>
        </div>
      </div>
    `)).join('')}
    <div style="margin-top:20px;text-align:center;"><button onclick="switchView('dashboard')" style="padding:10px 24px;background:var(--surface-2);border:1px solid var(--border);border-radius:4px;color:var(--text);font-family:'Syne',sans-serif;font-size:12px;cursor:pointer;">‚Üê Back to Dashboard</button></div>
  </div>`;
}

// ‚îÄ‚îÄ‚îÄ DATA SOURCE CONNECTION STATE ‚îÄ‚îÄ‚îÄ
const connectedSources = JSON.parse(localStorage.getItem('lmq_sources') || '{"CoStar Group":true}');
function saveSourceState() { localStorage.setItem('lmq_sources', JSON.stringify(connectedSources)); }

const dataSourceConfig = {
  'CoStar Group': { type: 'api', icon: 'üè¢', desc: 'Vacancy, comps, building data', fields: [{id:'costar-key',label:'API Key',placeholder:'cg_live_xxxxxxxxxxxx'},{id:'costar-acct',label:'Account ID',placeholder:'Your CoStar account ID'}], url: 'https://api.costar.com', docs: 'https://developer.costar.com/docs' },
  'CBRE Econometric Advisors': { type: 'api', icon: 'üìä', desc: 'Forecasting models', fields: [{id:'cbre-key',label:'API Key',placeholder:'cbre_ea_xxxxxxxxxxxx'},{id:'cbre-region',label:'Region Access',placeholder:'west-coast,national',type:'select',options:['West Coast Only','National','Global']}], url: 'https://api.cbre-ea.com', docs: 'https://developer.cbre.com' },
  'Bloomberg Terminal': { type: 'api', icon: 'üíπ', desc: 'Real-time market data', fields: [{id:'bb-key',label:'Bloomberg API Key',placeholder:'bb_xxxxxxxxxxxx'},{id:'bb-firm',label:'Firm ID',placeholder:'Your Bloomberg firm ID'},{id:'bb-feeds',label:'Data Feeds',type:'select',options:['CRE + Macro','CRE Only','Full Terminal','Macro Only']}], url: 'https://api.bloomberg.com', docs: 'https://developer.bloomberg.com' },
  'Yardi Matrix': { type: 'api', icon: 'üè†', desc: 'Rent comps, property data', fields: [{id:'yardi-key',label:'API Key',placeholder:'ym_xxxxxxxxxxxx'},{id:'yardi-markets',label:'Markets',placeholder:'e.g. Los Angeles, San Francisco, Seattle'}], url: 'https://api.yardimatrix.com', docs: 'https://www.yardimatrix.com/api' },
  'Reonomy': { type: 'api', icon: 'üîç', desc: 'Ownership, transaction data', fields: [{id:'reo-key',label:'API Key',placeholder:'reo_xxxxxxxxxxxx'},{id:'reo-tier',label:'Subscription Tier',type:'select',options:['Professional','Enterprise','Enterprise+']}], url: 'https://api.reonomy.com', docs: 'https://developer.reonomy.com' },
  'LexisNexis': { type: 'api', icon: '‚öñÔ∏è', desc: 'Legal precedent, compliance', fields: [{id:'ln-key',label:'API Key',placeholder:'ln_xxxxxxxxxxxx'},{id:'ln-scope',label:'Scope',type:'select',options:['Real Estate + Corporate','Real Estate Only','Full Legal']}], url: 'https://api.lexisnexis.com', docs: 'https://developer.lexisnexis.com' },
  'Salesforce': { type: 'oauth', icon: '‚òÅÔ∏è', desc: 'CRM, pipeline sync', authUrl: 'https://login.salesforce.com/services/oauth2/authorize', fields: [{id:'sf-instance',label:'Instance URL',placeholder:'https://yourcompany.my.salesforce.com'},{id:'sf-client',label:'Connected App Client ID',placeholder:'3MVG9...'},{id:'sf-secret',label:'Client Secret',placeholder:'Your client secret'}], scopes: 'api refresh_token offline_access' },
  'HubSpot': { type: 'oauth', icon: 'üî∂', desc: 'CRM, contact management', authUrl: 'https://app.hubspot.com/oauth/authorize', fields: [{id:'hs-portal',label:'Portal ID',placeholder:'Your HubSpot portal ID'},{id:'hs-client',label:'Client ID',placeholder:'xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx'},{id:'hs-secret',label:'Client Secret',placeholder:'Your client secret'}], scopes: 'crm.objects.contacts.read crm.objects.deals.read' },
  'Gmail / Outlook': { type: 'oauth', icon: '‚úâÔ∏è', desc: 'Email integration', fields: [{id:'email-provider',label:'Email Provider',type:'select',options:['Gmail (Google Workspace)','Outlook (Microsoft 365)','Other IMAP']},{id:'email-acct',label:'Email Address',placeholder:'you@company.com'}], authUrl: 'https://accounts.google.com/o/oauth2/auth' },
  'Slack': { type: 'oauth', icon: 'üí¨', desc: 'Team notifications', authUrl: 'https://slack.com/oauth/v2/authorize', fields: [{id:'slack-workspace',label:'Workspace',placeholder:'yourteam.slack.com'},{id:'slack-channel',label:'Default Channel',placeholder:'#landmarq-alerts'}], scopes: 'chat:write channels:read' },
  'DocuSign': { type: 'oauth', icon: '‚úçÔ∏è', desc: 'Document signing', authUrl: 'https://account-d.docusign.com/oauth/auth', fields: [{id:'ds-acct',label:'Account ID',placeholder:'Your DocuSign account ID'},{id:'ds-integration',label:'Integration Key',placeholder:'xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx'}], scopes: 'signature impersonation' }
};

function showDataSourcesPanel() {
  const premiumSources = ['CoStar Group','CBRE Econometric Advisors','Bloomberg Terminal','Yardi Matrix','Reonomy','LexisNexis'];
  const crmSources = ['Salesforce','HubSpot','Gmail / Outlook','Slack','DocuSign'];

  function renderSourceRow(name) {
    const cfg = dataSourceConfig[name];
    const isConnected = connectedSources[name];
    return `<div style="display:flex;align-items:center;justify-content:space-between;padding:10px 12px;background:var(--surface-2);border:1px solid ${isConnected ? 'rgba(74,155,111,0.2)' : 'var(--border)'};border-radius:6px;">
      <div style="display:flex;align-items:center;gap:10px;">
        <span style="font-size:18px;">${cfg.icon}</span>
        <div><div style="font-size:12px;color:var(--cream);">${name}</div><div style="font-size:10px;color:var(--text-dim);">${cfg.desc}</div></div>
      </div>
      <div style="display:flex;align-items:center;gap:6px;">
        ${isConnected ? `<span style="font-size:10px;color:var(--green);">‚óè Active</span><button onclick="showSourceSettings('${name.replace(/'/g,"\\'")}')" style="padding:5px 10px;background:var(--surface-3);border:1px solid var(--border);border-radius:4px;color:var(--text-dim);font-family:'Syne',sans-serif;font-size:9px;cursor:pointer;">Settings</button><button onclick="disconnectSource('${name.replace(/'/g,"\\'")}')" style="padding:5px 10px;background:var(--red-dim);border:1px solid rgba(192,83,58,0.2);border-radius:4px;color:var(--red);font-family:'Syne',sans-serif;font-size:9px;cursor:pointer;">Disconnect</button>` : `<button onclick="connectSource('${name.replace(/'/g,"\\'")}')" style="padding:6px 14px;background:var(--gold);color:#0A0C0E;border:none;border-radius:4px;font-weight:600;font-family:'Syne',sans-serif;font-size:10px;cursor:pointer;">Connect ‚Üí</button>`}
      </div>
    </div>`;
  }

  const connectedCount = Object.keys(connectedSources).filter(k => connectedSources[k]).length;
  const totalCount = Object.keys(dataSourceConfig).length;

  showModal('Data Sources', 'Connect Your Data Sources',
    `<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;">
      <div style="font-size:13px;color:var(--text);line-height:1.6;">Enhance agent intelligence with premium and private data feeds.</div>
      <div style="padding:6px 12px;background:var(--surface-2);border:1px solid var(--border);border-radius:20px;font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--gold);white-space:nowrap;">${connectedCount}/${totalCount} connected</div>
    </div>`
    + `<div style="font-family:'JetBrains Mono',monospace;font-size:9px;color:var(--gold);letter-spacing:0.1em;margin-bottom:8px;">PREMIUM DATA PROVIDERS</div>`
    + `<div style="display:flex;flex-direction:column;gap:8px;margin-bottom:16px;">`
    + premiumSources.map(renderSourceRow).join('')
    + `</div>`
    + `<div style="font-family:'JetBrains Mono',monospace;font-size:9px;color:var(--gold);letter-spacing:0.1em;margin-bottom:8px;">CRM & INTEGRATIONS</div>`
    + `<div style="display:flex;flex-direction:column;gap:8px;margin-bottom:16px;">`
    + crmSources.map(renderSourceRow).join('')
    + `</div>`
    + `<div style="font-family:'JetBrains Mono',monospace;font-size:9px;color:var(--gold);letter-spacing:0.1em;margin-bottom:8px;">CUSTOM API ENDPOINT</div>`
    + `<div style="padding:12px;background:var(--surface-2);border:1px solid var(--border);border-radius:6px;">
      <div style="font-size:12px;color:var(--cream);margin-bottom:8px;">Connect any REST API or data feed</div>
      <input id="custom-api-url" type="text" placeholder="https://api.yourdatasource.com/v1/" style="width:100%;padding:8px 12px;background:var(--surface-3);border:1px solid var(--border);border-radius:4px;color:var(--cream);font-family:'JetBrains Mono',monospace;font-size:11px;margin-bottom:6px;" />
      <input id="custom-api-key" type="password" placeholder="API Key (encrypted at rest)" style="width:100%;padding:8px 12px;background:var(--surface-3);border:1px solid var(--border);border-radius:4px;color:var(--cream);font-family:'JetBrains Mono',monospace;font-size:11px;margin-bottom:6px;" />
      <select id="custom-api-format" style="width:100%;padding:8px 12px;background:var(--surface-3);border:1px solid var(--border);border-radius:4px;color:var(--cream);font-family:'Syne',sans-serif;font-size:11px;margin-bottom:8px;"><option>JSON REST API</option><option>GraphQL</option><option>CSV/FTP Feed</option><option>Webhook (push)</option></select>
      <button onclick="testCustomAPI()" style="padding:8px 16px;background:var(--gold);color:#0A0C0E;border:none;border-radius:4px;font-weight:600;font-family:'Syne',sans-serif;font-size:11px;cursor:pointer;">Test Connection & Connect</button>
    </div>`
  );
}

function connectSource(name) {
  const cfg = dataSourceConfig[name];
  if (!cfg) return;
  closeModal();

  const isOAuth = cfg.type === 'oauth';
  const fieldHTML = cfg.fields.map(f => {
    if (f.type === 'select') {
      return `<div><label style="font-size:10px;color:var(--text-dim);text-transform:uppercase;letter-spacing:0.1em;display:block;margin-bottom:4px;">${f.label}</label><select id="${f.id}" style="width:100%;padding:8px 12px;background:var(--surface-2);border:1px solid var(--border);border-radius:4px;color:var(--cream);font-family:'Syne',sans-serif;font-size:12px;">${f.options.map(o=>'<option>'+o+'</option>').join('')}</select></div>`;
    }
    return `<div><label style="font-size:10px;color:var(--text-dim);text-transform:uppercase;letter-spacing:0.1em;display:block;margin-bottom:4px;">${f.label}</label><input id="${f.id}" type="${f.label.toLowerCase().includes('secret') || f.label.toLowerCase().includes('key') ? 'password' : 'text'}" placeholder="${f.placeholder || ''}" style="width:100%;padding:8px 12px;background:var(--surface-2);border:1px solid var(--border);border-radius:4px;color:var(--cream);font-family:'JetBrains Mono',monospace;font-size:12px;" /></div>`;
  }).join('');

  setTimeout(() => showModal('Connect', cfg.icon + ' Connect ' + name,
    `<div style="font-size:13px;color:var(--text);line-height:1.6;margin-bottom:12px;">${isOAuth ? 'Authorize LandMarq to access your ' + name + ' account via OAuth 2.0.' : 'Enter your ' + name + ' API credentials. All keys are encrypted at rest with AES-256.'}</div>`
    + (cfg.docs ? `<div style="margin-bottom:12px;"><a href="${cfg.docs}" target="_blank" style="font-size:11px;color:var(--gold);text-decoration:none;">üìñ View ${name} API documentation ‚Üí</a></div>` : '')
    + `<div style="display:flex;flex-direction:column;gap:10px;margin-bottom:16px;">${fieldHTML}</div>`
    + (isOAuth ? `<div style="padding:10px 12px;background:var(--gold-dim);border:1px solid var(--border-gold);border-radius:6px;margin-bottom:12px;font-size:11px;color:var(--gold);line-height:1.5;">
      <strong>OAuth Scopes Requested:</strong> ${cfg.scopes || 'read-only access'}<br>
      <span style="color:var(--text-dim);">LandMarq will never modify your data without explicit confirmation.</span>
    </div>` : '')
    + `<div style="padding:10px 12px;background:var(--surface-2);border:1px solid var(--border);border-radius:6px;margin-bottom:16px;">
      <div style="display:flex;align-items:center;gap:8px;">
        <span style="font-size:14px;">üîí</span>
        <div style="font-size:10px;color:var(--text-dim);line-height:1.4;">Credentials encrypted with AES-256. Stored in your private vault. Never shared with third parties. You can revoke access at any time.</div>
      </div>
    </div>`
    + `<div id="connect-status-${name.replace(/\s/g,'')}" style="display:none;padding:10px 12px;border-radius:6px;margin-bottom:12px;font-size:12px;"></div>`
    + `<div style="display:flex;gap:8px;">
      <button id="connect-btn-${name.replace(/\s/g,'')}" onclick="executeConnection('${name.replace(/'/g,"\\'")}')" style="flex:1;padding:12px;background:var(--gold);color:#0A0C0E;border:none;border-radius:4px;font-weight:700;font-family:'Syne',sans-serif;font-size:13px;cursor:pointer;">${isOAuth ? 'Authorize & Connect' : 'Test & Connect'}</button>
      <button onclick="closeModal();setTimeout(showDataSourcesPanel,200)" style="padding:12px 20px;background:var(--surface-2);border:1px solid var(--border);border-radius:4px;color:var(--text);font-family:'Syne',sans-serif;font-size:13px;cursor:pointer;">Cancel</button>
    </div>`
  ), 200);
}

function executeConnection(name) {
  const safeName = name.replace(/\s/g,'');
  const statusEl = document.getElementById('connect-status-' + safeName);
  const btnEl = document.getElementById('connect-btn-' + safeName);
  if (!statusEl || !btnEl) return;

  // Check if required fields are filled
  const cfg = dataSourceConfig[name];
  let hasEmpty = false;
  cfg.fields.forEach(f => {
    const el = document.getElementById(f.id);
    if (el && !el.value.trim() && f.type !== 'select') {
      el.style.borderColor = 'var(--red)';
      hasEmpty = true;
    }
  });
  if (hasEmpty) {
    statusEl.style.display = 'block';
    statusEl.style.background = 'var(--red-dim)';
    statusEl.style.border = '1px solid rgba(192,83,58,0.2)';
    statusEl.style.color = 'var(--red)';
    statusEl.textContent = 'Please fill in all required fields.';
    return;
  }

  // Simulate connection test
  btnEl.disabled = true;
  btnEl.textContent = 'Connecting...';
  btnEl.style.opacity = '0.6';
  statusEl.style.display = 'block';
  statusEl.style.background = 'var(--gold-dim)';
  statusEl.style.border = '1px solid var(--border-gold)';
  statusEl.style.color = 'var(--gold)';
  statusEl.innerHTML = '‚è≥ Testing connection to ' + name + '...';

  setTimeout(() => {
    statusEl.innerHTML = '‚è≥ Authenticating credentials...';
  }, 800);

  setTimeout(() => {
    statusEl.innerHTML = '‚è≥ Verifying data access permissions...';
  }, 1600);

  setTimeout(() => {
    // Connection success
    statusEl.style.background = 'var(--green-dim)';
    statusEl.style.border = '1px solid rgba(74,155,111,0.2)';
    statusEl.style.color = 'var(--green)';
    statusEl.innerHTML = '‚úÖ Connected successfully! Data sync starting...';
    connectedSources[name] = true;
    saveSourceState();
    btnEl.textContent = '‚úì Connected';
    btnEl.style.background = 'var(--green)';
    btnEl.style.opacity = '1';

    setTimeout(() => {
      closeModal();
      showToast(name + ' connected ‚Äî agents now pulling live data');
      setTimeout(showDataSourcesPanel, 200);
    }, 1200);
  }, 2400);
}

function disconnectSource(name) {
  closeModal();
  setTimeout(() => showModal('Disconnect', 'Disconnect ' + name + '?',
    `<div style="padding:16px;background:var(--red-dim);border:1px solid rgba(192,83,58,0.2);border-radius:8px;margin-bottom:16px;">
      <div style="font-size:14px;color:var(--red);font-weight:600;margin-bottom:6px;">‚ö† Confirm Disconnect</div>
      <div style="font-size:13px;color:var(--text);line-height:1.6;">This will revoke LandMarq's access to <strong style="color:var(--cream);">${name}</strong>. Agents that rely on this data source will fall back to cached data until reconnected.</div>
    </div>`
    + `<div style="display:flex;gap:8px;">
      <button onclick="connectedSources['${name.replace(/'/g,"\\'")}'] = false;saveSourceState();closeModal();showToast('${name} disconnected');setTimeout(showDataSourcesPanel,200)" style="flex:1;padding:12px;background:var(--red);color:white;border:none;border-radius:4px;font-weight:700;font-family:'Syne',sans-serif;font-size:13px;cursor:pointer;">Disconnect</button>
      <button onclick="closeModal();setTimeout(showDataSourcesPanel,200)" style="flex:1;padding:12px;background:var(--surface-2);border:1px solid var(--border);border-radius:4px;color:var(--text);font-family:'Syne',sans-serif;font-size:13px;cursor:pointer;">Cancel</button>
    </div>`
  ), 200);
}

function showSourceSettings(name) {
  const cfg = dataSourceConfig[name];
  if (!cfg) return;
  closeModal();
  setTimeout(() => showModal('Settings', cfg.icon + ' ' + name + ' ‚Äî Settings',
    `<div style="padding:10px 12px;background:var(--green-dim);border:1px solid rgba(74,155,111,0.2);border-radius:6px;margin-bottom:16px;display:flex;align-items:center;gap:8px;">
      <span style="color:var(--green);">‚óè</span>
      <div style="font-size:12px;color:var(--green);">Connected & Active</div>
      <div style="margin-left:auto;font-size:10px;color:var(--text-dim);">Last sync: 2 min ago</div>
    </div>`
    + `<div style="display:flex;flex-direction:column;gap:10px;margin-bottom:16px;">`
    + `<div><label style="font-size:10px;color:var(--text-dim);text-transform:uppercase;letter-spacing:0.1em;display:block;margin-bottom:4px;">Sync Frequency</label><select style="width:100%;padding:8px 12px;background:var(--surface-2);border:1px solid var(--border);border-radius:4px;color:var(--cream);font-family:'Syne',sans-serif;font-size:12px;"><option>Realtime (streaming)</option><option selected>Every 15 minutes</option><option>Hourly</option><option>Daily</option></select></div>`
    + `<div><label style="font-size:10px;color:var(--text-dim);text-transform:uppercase;letter-spacing:0.1em;display:block;margin-bottom:4px;">Data Scope</label><select style="width:100%;padding:8px 12px;background:var(--surface-2);border:1px solid var(--border);border-radius:4px;color:var(--cream);font-family:'Syne',sans-serif;font-size:12px;"><option selected>All configured markets</option><option>Active deal markets only</option><option>Custom selection</option></select></div>`
    + `<div><label style="font-size:10px;color:var(--text-dim);text-transform:uppercase;letter-spacing:0.1em;display:block;margin-bottom:4px;">API Key</label><div style="display:flex;gap:6px;"><input type="password" value="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" style="flex:1;padding:8px 12px;background:var(--surface-2);border:1px solid var(--border);border-radius:4px;color:var(--cream);font-family:'JetBrains Mono',monospace;font-size:12px;" /><button onclick="this.previousElementSibling.type=this.previousElementSibling.type==='password'?'text':'password';this.textContent=this.previousElementSibling.type==='password'?'Show':'Hide'" style="padding:8px 12px;background:var(--surface-3);border:1px solid var(--border);border-radius:4px;color:var(--text-dim);font-family:'Syne',sans-serif;font-size:10px;cursor:pointer;">Show</button></div></div>`
    + `<div style="padding:10px 12px;background:var(--surface-2);border:1px solid var(--border);border-radius:6px;"><div style="font-family:'JetBrains Mono',monospace;font-size:9px;color:var(--text-dim);letter-spacing:0.1em;margin-bottom:6px;">USAGE THIS MONTH</div><div style="display:flex;justify-content:space-between;font-size:12px;"><span style="color:var(--text-mid);">API Calls</span><span style="color:var(--cream);">12,847 / 50,000</span></div><div style="width:100%;height:4px;background:var(--surface-3);border-radius:2px;margin-top:6px;"><div style="width:26%;height:100%;background:var(--gold);border-radius:2px;"></div></div></div>`
    + `</div>`
    + `<div style="display:flex;gap:8px;">
      <button onclick="closeModal();showToast('${name} settings saved');setTimeout(showDataSourcesPanel,200)" style="flex:1;padding:12px;background:var(--gold);color:#0A0C0E;border:none;border-radius:4px;font-weight:700;font-family:'Syne',sans-serif;font-size:13px;cursor:pointer;">Save Settings</button>
      <button onclick="closeModal();setTimeout(showDataSourcesPanel,200)" style="padding:12px 20px;background:var(--surface-2);border:1px solid var(--border);border-radius:4px;color:var(--text);font-family:'Syne',sans-serif;font-size:13px;cursor:pointer;">Cancel</button>
    </div>`
  ), 200);
}

function testCustomAPI() {
  const url = document.getElementById('custom-api-url')?.value;
  const key = document.getElementById('custom-api-key')?.value;
  if (!url || !key) { showToast('Please enter both API URL and key'); return; }
  showToast('Testing connection to ' + url + '...');
  setTimeout(() => {
    connectedSources['Custom: ' + url.split('/')[2]] = true;
    saveSourceState();
    closeModal();
    showToast('Custom API connected successfully');
    setTimeout(showDataSourcesPanel, 200);
  }, 1500);
}

function showAgentConfig(agentName) {
  showModal('Configure', 'Configure ' + agentName,
    `<div style="font-size:13px;color:var(--text);line-height:1.6;margin-bottom:16px;">Adjust ${agentName} settings. Changes take effect immediately.</div>`
    + `<div style="display:flex;flex-direction:column;gap:10px;">`
    + `<div><label style="font-size:10px;color:var(--text-dim);display:block;margin-bottom:4px;">MONITORING FREQUENCY</label><select style="width:100%;padding:8px 12px;background:var(--surface-2);border:1px solid var(--border);border-radius:4px;color:var(--cream);font-family:'Syne',sans-serif;font-size:12px;"><option>Realtime</option><option>Every 15 min</option><option>Hourly</option><option>Daily</option></select></div>`
    + `<div><label style="font-size:10px;color:var(--text-dim);display:block;margin-bottom:4px;">MARKETS TO MONITOR</label><input type="text" value="LA Metro (15 submarkets), SF Metro, Seattle" style="width:100%;padding:8px 12px;background:var(--surface-2);border:1px solid var(--border);border-radius:4px;color:var(--cream);font-family:'Syne',sans-serif;font-size:12px;" /></div>`
    + `<div><label style="font-size:10px;color:var(--text-dim);display:block;margin-bottom:4px;">ALERT THRESHOLD</label><select style="width:100%;padding:8px 12px;background:var(--surface-2);border:1px solid var(--border);border-radius:4px;color:var(--cream);font-family:'Syne',sans-serif;font-size:12px;"><option>All Changes</option><option selected>Significant Changes Only (>1% vacancy shift, >$5 rent change)</option><option>Critical Only (>5% vacancy shift)</option></select></div>`
    + `<div><label style="font-size:10px;color:var(--text-dim);display:block;margin-bottom:4px;">NOTIFICATION CHANNEL</label><select style="width:100%;padding:8px 12px;background:var(--surface-2);border:1px solid var(--border);border-radius:4px;color:var(--cream);font-family:'Syne',sans-serif;font-size:12px;"><option selected>Dashboard + Priority Alerts</option><option>Dashboard Only</option><option>Dashboard + Email</option><option>Dashboard + Email + Slack</option></select></div>`
    + `</div>`
    + `<div style="display:flex;gap:8px;margin-top:16px;"><button onclick="closeModal();showToast('${agentName} configuration saved')" style="flex:1;padding:10px;background:var(--gold);color:#0A0C0E;border:none;border-radius:4px;font-weight:700;font-family:'Syne',sans-serif;font-size:12px;cursor:pointer;">Save Configuration</button><button onclick="closeModal()" style="flex:1;padding:10px;background:var(--surface-2);border:1px solid var(--border);border-radius:4px;color:var(--text);font-family:'Syne',sans-serif;font-size:12px;cursor:pointer;">Cancel</button></div>`
  );
}

function showAgentHistory(agentName) {
  const history = [
    { time: '2 min ago', action: 'Updated SF Financial District vacancy to 26.3%', type: 'update' },
    { time: '14 min ago', action: 'Identified TechCo Inc. expansion signal (40+ job postings)', type: 'lead' },
    { time: '31 min ago', action: 'Reviewed Apex Capital LOI ‚Äî flagged 2 clauses', type: 'doc' },
    { time: '1 hr ago', action: 'Detected zoning variance filing at 1150 S Olive St', type: 'alert' },
    { time: '1.5 hr ago', action: 'Fed rate signal triggered cap rate compression model', type: 'macro' },
    { time: '3 hr ago', action: 'Updated Culver City vacancy from 11.8% to 11.2%', type: 'update' },
    { time: '4 hr ago', action: 'Playa Vista badge-in data: 74% vs 61% DTLA avg', type: 'update' },
    { time: '6 hr ago', action: 'CBRE closed 18,500 SF at Water Garden SM', type: 'alert' },
    { time: 'Yesterday', action: 'Generated weekly market digest for 15 submarkets', type: 'report' },
    { time: 'Yesterday', action: 'Identified Shopify sublease exit signal (Santa Monica)', type: 'lead' }
  ];
  const icons = { update: 'üìä', lead: 'üéØ', doc: 'üìã', alert: '‚ö°', macro: 'üèõÔ∏è', report: 'üìà' };
  showModal('History', agentName + ' ‚Äî Activity Log',
    `<div style="font-size:12px;color:var(--text-dim);margin-bottom:12px;">Last 10 actions across all agents</div>`
    + `<div style="max-height:400px;overflow-y:auto;">`
    + history.map(h => `<div style="display:flex;gap:10px;padding:10px 0;border-bottom:1px solid var(--border);"><div style="font-size:14px;flex-shrink:0;">${icons[h.type] || 'üìä'}</div><div style="flex:1;"><div style="font-size:12px;color:var(--cream);line-height:1.4;">${h.action}</div><div style="font-size:10px;color:var(--text-dim);margin-top:2px;">${h.time}</div></div></div>`).join('')
    + `</div>`
  );
}

function toggleAgentPause(btn, agentName) {
  if (btn.textContent.trim() === 'Pause') {
    btn.textContent = 'Resume';
    btn.style.background = 'var(--green-dim)';
    btn.style.color = 'var(--green)';
    btn.style.borderColor = 'rgba(74,155,111,0.2)';
    showToast(agentName + ' paused');
  } else {
    btn.textContent = 'Pause';
    btn.style.background = 'var(--red-dim)';
    btn.style.color = 'var(--red)';
    btn.style.borderColor = 'rgba(192,83,58,0.2)';
    showToast(agentName + ' resumed');
  }
}

// ‚îÄ‚îÄ‚îÄ PIPELINE VIEW ‚îÄ‚îÄ‚îÄ
function renderPipeline() {
  const allDeals = [
    { name: 'Netflix Inc.', sub: 'HQ Expansion ¬∑ TAMI', market: 'Culver City', sf: '~60K', value: '$42M', stage: 'Proposal', prob: 72, close: "Apr '26", contact: 'Sarah Chen, VP Real Estate' },
    { name: 'Apex Capital Group', sub: 'Relocation ¬∑ Financial', market: 'Century City', sf: '28.5K', value: '$19M', stage: 'LOI Signed', prob: 88, close: "Mar '26", contact: 'David Park, COO' },
    { name: 'Pinnacle Studios', sub: 'Expansion ¬∑ Entertain.', market: 'Burbank', sf: '45K', value: '$30M', stage: 'Closing', prob: 94, close: "Mar '26", contact: 'Rachel Adams, CFO' },
    { name: 'TechCo Inc.', sub: 'New Requirement ¬∑ SaaS', market: 'Playa Vista', sf: '~20K', value: '$11M', stage: 'Qualifying', prob: 38, close: "Q3 '26", contact: 'VP Operations (TBD)' },
    { name: 'WestShore Media', sub: 'Expansion ¬∑ Media', market: 'Santa Monica', sf: '14.2K', value: '$8.5M', stage: 'Proposal', prob: 61, close: "May '26", contact: 'Lisa Tran, Head of Ops' },
    { name: 'Meridian Health', sub: 'New Req. ¬∑ Healthcare', market: 'Burbank', sf: '9K', value: '$4.2M', stage: 'Prospect', prob: 24, close: "Q4 '26", contact: 'Michael Torres, CFO' },
    { name: 'Summit Legal Group', sub: 'Expansion ¬∑ Legal', market: 'Century City', sf: '18K', value: '$16M', stage: 'LOI Signed', prob: 82, close: "Apr '26", contact: 'Jennifer Walsh, Managing Partner' },
    { name: 'Horizon Biotech', sub: 'Expansion ¬∑ Life Sci', market: 'El Segundo', sf: '22K', value: '$14M', stage: 'Qualifying', prob: 42, close: "Q3 '26", contact: 'Dr. Robert Lin, COO' },
    { name: 'Pacific Ventures', sub: 'Relocation ¬∑ VC', market: 'Santa Monica', sf: '12K', value: '$7.8M', stage: 'Proposal', prob: 55, close: "Jun '26", contact: 'Tom Huang, Partner' },
    { name: 'Catalyst Media', sub: 'New Req. ¬∑ Media', market: 'Culver City', sf: '8.5K', value: '$5.1M', stage: 'Qualifying', prob: 35, close: "Q4 '26", contact: 'Amy Castillo, CEO' },
    { name: 'CloudNine Software', sub: 'New Req. ¬∑ SaaS', market: 'Playa Vista', sf: '11K', value: '$6.8M', stage: 'Prospect', prob: 18, close: "2027", contact: 'Jason Reed, VP Eng' },
    { name: 'Verde Architects', sub: 'Relocation ¬∑ Design', market: 'W. Hollywood', sf: '5.5K', value: '$3.2M', stage: 'Proposal', prob: 58, close: "May '26", contact: 'Maria Santos, Founder' },
    { name: 'Arclight Partners', sub: 'Expansion ¬∑ Finance', market: 'DTLA', sf: '35K', value: '$18M', stage: 'Qualifying', prob: 45, close: "Q3 '26", contact: 'Steven Park, MD' },
    { name: 'Zenith Healthcare', sub: 'New Req. ¬∑ Healthcare', market: 'Burbank', sf: '7K', value: '$3.4M', stage: 'Prospect', prob: 22, close: "Q4 '26", contact: 'Dr. Nina Patel' }
  ];
  const stageColors = { 'Prospect': 'var(--text-dim)', 'Qualifying': 'var(--blue)', 'Proposal': 'var(--amber)', 'LOI Signed': 'var(--gold)', 'Closing': 'var(--green)' };
  const stageCounts = {};
  allDeals.forEach(d => { stageCounts[d.stage] = (stageCounts[d.stage] || 0) + 1; });

  return `<div style="max-width:1100px;">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;">
      <div>
        <div style="font-family:'Cormorant Garamond',serif;font-size:28px;font-weight:600;color:var(--cream);">Deal Pipeline</div>
        <div style="font-size:12px;color:var(--text-dim);margin-top:4px;">14 active deals ¬∑ $218M total value</div>
      </div>
      <div style="display:flex;gap:8px;">
        <button onclick="openAddDealModal()" style="padding:8px 16px;background:var(--gold);color:#0A0C0E;border:none;border-radius:4px;font-weight:600;font-family:'Syne',sans-serif;font-size:11px;cursor:pointer;">+ Add Deal</button>
        <select id="pipeline-filter" onchange="filterPipelineView()" style="padding:8px 12px;background:var(--surface-2);border:1px solid var(--border);border-radius:4px;color:var(--cream);font-family:'Syne',sans-serif;font-size:11px;">
          <option value="all">All Stages</option>
          <option value="Prospect">Prospect</option>
          <option value="Qualifying">Qualifying</option>
          <option value="Proposal">Proposal</option>
          <option value="LOI Signed">LOI Signed</option>
          <option value="Closing">Closing</option>
        </select>
        <select id="pipeline-sort" onchange="sortPipelineView()" style="padding:8px 12px;background:var(--surface-2);border:1px solid var(--border);border-radius:4px;color:var(--cream);font-family:'Syne',sans-serif;font-size:11px;">
          <option value="value">Sort: Value</option>
          <option value="prob">Sort: Probability</option>
          <option value="stage">Sort: Stage</option>
          <option value="name">Sort: Name</option>
        </select>
      </div>
    </div>
    ${viewSection('Stage Summary')}
    <div style="display:flex;gap:8px;margin-bottom:16px;">
      ${['Prospect','Qualifying','Proposal','LOI Signed','Closing'].map(s =>
        `<div style="flex:1;padding:10px 12px;background:var(--surface);border:1px solid var(--border);border-radius:6px;border-top:2px solid ${stageColors[s]};text-align:center;">
          <div style="font-family:'JetBrains Mono',monospace;font-size:8px;color:var(--text-dim);letter-spacing:0.1em;margin-bottom:4px;">${s.toUpperCase()}</div>
          <div style="font-family:'Cormorant Garamond',serif;font-size:22px;color:var(--cream);">${stageCounts[s] || 0}</div>
        </div>`
      ).join('')}
    </div>
    ${viewSection('All Deals')}
    <div id="pipeline-view-list">
    ${allDeals.map((d,i) => `<div class="pipeline-view-row" data-stage="${d.stage}" data-value="${parseFloat(d.value.replace(/[^0-9.]/g,''))}" data-prob="${d.prob}" data-name="${d.name}" style="background:var(--surface);border:1px solid var(--border);border-radius:6px;padding:16px;margin-bottom:8px;cursor:pointer;transition:border-color 0.2s;" onmouseover="this.style.borderColor='rgba(255,255,255,0.15)'" onmouseout="this.style.borderColor='var(--border)'" onclick="showDealDetail(${i})">
      <div style="display:flex;align-items:center;gap:16px;">
        <div style="flex:2;min-width:0;"><div style="font-size:14px;font-weight:600;color:var(--cream);">${d.name}</div><div style="font-size:11px;color:var(--text-dim);margin-top:2px;">${d.sub}</div></div>
        <div style="width:90px;"><span style="font-size:10px;padding:3px 8px;background:var(--surface-2);border-radius:3px;color:var(--text-mid);font-family:'JetBrains Mono',monospace;">${d.market}</span></div>
        <div style="width:60px;font-family:'JetBrains Mono',monospace;font-size:11px;color:var(--text-mid);">${d.sf}</div>
        <div style="width:50px;font-family:'Cormorant Garamond',serif;font-size:16px;font-weight:600;color:var(--gold);">${d.value}</div>
        <div style="width:80px;"><span style="font-size:9px;padding:3px 8px;border-radius:12px;font-family:'JetBrains Mono',monospace;background:var(--surface-3);color:${stageColors[d.stage]};">${d.stage}</span></div>
        <div style="width:60px;"><div style="display:flex;align-items:center;gap:6px;"><div style="flex:1;height:3px;background:var(--surface-3);border-radius:2px;overflow:hidden;"><div style="height:100%;width:${d.prob}%;background:${d.prob > 70 ? 'var(--green)' : d.prob > 40 ? 'var(--gold)' : 'var(--red)'};border-radius:2px;"></div></div><span style="font-family:'JetBrains Mono',monospace;font-size:9px;color:var(--text-mid);">${d.prob}%</span></div></div>
        <div style="width:55px;font-family:'JetBrains Mono',monospace;font-size:9px;color:var(--text-dim);">${d.close}</div>
        <div style="width:30px;text-align:center;"><button onclick="event.stopPropagation();showDealActions(${i},'${d.name.replace(/'/g,"\\'")}')" style="background:none;border:none;color:var(--text-dim);cursor:pointer;font-size:14px;">‚ãØ</button></div>
      </div>
    </div>`).join('')}
    </div>
    <div style="margin-top:20px;text-align:center;"><button onclick="switchView('dashboard')" style="padding:10px 24px;background:var(--surface-2);border:1px solid var(--border);border-radius:4px;color:var(--text);font-family:'Syne',sans-serif;font-size:12px;cursor:pointer;">‚Üê Back to Dashboard</button></div>
  </div>`;
}

function showDealDetail(idx) {
  const d = dealDetails[idx] || { name: 'Deal', sub: '', market: '', sf: '', value: '', stage: '', prob: '', close: '', contact: '', notes: 'No additional details.' };
  showModal('Deal Detail', d.name,
    `<div style="font-size:13px;color:var(--text-mid);margin-bottom:16px;">${d.sub} ¬∑ ${d.market}</div>`
    + detailRow('Square Footage', d.sf, 'var(--cream)')
    + detailRow('Estimated Value', d.value, 'var(--gold)')
    + detailRow('Stage', d.stage, 'var(--cream)')
    + detailRow('Win Probability', d.prob, parseInt(d.prob) > 70 ? 'var(--green)' : parseInt(d.prob) > 50 ? 'var(--amber)' : 'var(--red)')
    + detailRow('Expected Close', d.close, 'var(--text-mid)')
    + detailRow('Key Contact', d.contact, 'var(--cream)')
    + `<div style="margin-top:16px;padding:12px;background:var(--surface-2);border:1px solid var(--border);border-radius:6px;font-size:12px;color:var(--text);line-height:1.5;"><strong style="color:var(--cream);">Notes:</strong> ${d.notes}</div>`
    + `<div style="display:flex;gap:8px;margin-top:16px;">
      <button onclick="actionEditDealDetail(${idx})" style="flex:1;padding:10px;background:var(--gold);color:#0A0C0E;border:none;border-radius:4px;font-weight:700;font-family:'Syne',sans-serif;font-size:12px;cursor:pointer;">Edit Deal</button>
      <button onclick="actionDealFollowUp(${idx})" style="flex:1;padding:10px;background:var(--surface-2);border:1px solid var(--border);border-radius:4px;color:var(--text);font-family:'Syne',sans-serif;font-size:12px;cursor:pointer;">Draft Follow-Up</button>
      <button onclick="actionUpdateStage(${idx})" style="flex:1;padding:10px;background:var(--surface-2);border:1px solid var(--border);border-radius:4px;color:var(--text);font-family:'Syne',sans-serif;font-size:12px;cursor:pointer;">Update Stage</button>
    </div>`
  );
}

function showDealActions(idx, name) {
  showModal('Deal Actions', name,
    `<div style="display:flex;flex-direction:column;gap:8px;">
      <button onclick="actionEditDealDetail(${idx})" style="padding:12px;background:var(--surface-2);border:1px solid var(--border);border-radius:6px;color:var(--cream);font-family:'Syne',sans-serif;font-size:13px;cursor:pointer;text-align:left;">üìù Edit Deal Details</button>
      <button onclick="actionUpdateStage(${idx})" style="padding:12px;background:var(--surface-2);border:1px solid var(--border);border-radius:6px;color:var(--cream);font-family:'Syne',sans-serif;font-size:13px;cursor:pointer;text-align:left;">üìä Update Stage & Probability</button>
      <button onclick="actionDealFollowUp(${idx})" style="padding:12px;background:var(--surface-2);border:1px solid var(--border);border-radius:6px;color:var(--cream);font-family:'Syne',sans-serif;font-size:13px;cursor:pointer;text-align:left;">‚úâÔ∏è Draft Follow-Up Email</button>
      <button onclick="actionExportCRM(${idx})" style="padding:12px;background:var(--surface-2);border:1px solid var(--border);border-radius:6px;color:var(--cream);font-family:'Syne',sans-serif;font-size:13px;cursor:pointer;text-align:left;">üìã Export to CRM</button>
      <button onclick="actionAddNote(${idx})" style="padding:12px;background:var(--surface-2);border:1px solid var(--border);border-radius:6px;color:var(--cream);font-family:'Syne',sans-serif;font-size:13px;cursor:pointer;text-align:left;">üìé Add Document / Note</button>
      <button onclick="actionArchiveDeal(${idx})" style="padding:12px;background:var(--red-dim);border:1px solid rgba(192,83,58,0.2);border-radius:6px;color:var(--red);font-family:'Syne',sans-serif;font-size:13px;cursor:pointer;text-align:left;">üóë Archive Deal</button>
    </div>`
  );
}

// ‚îÄ‚îÄ‚îÄ PIPELINE FILTER & SORT ‚îÄ‚îÄ‚îÄ
function filterPipelineView() {
  const filter = document.getElementById('pipeline-filter').value;
  const rows = document.querySelectorAll('.pipeline-view-row');
  rows.forEach(row => {
    if (filter === 'all' || row.getAttribute('data-stage') === filter) {
      row.style.display = '';
    } else {
      row.style.display = 'none';
    }
  });
}

function sortPipelineView() {
  const sortBy = document.getElementById('pipeline-sort').value;
  const container = document.getElementById('pipeline-view-list');
  if (!container) return;
  const rows = Array.from(container.querySelectorAll('.pipeline-view-row'));
  const stageOrder = { 'Closing': 0, 'LOI Signed': 1, 'Proposal': 2, 'Qualifying': 3, 'Prospect': 4 };
  rows.sort((a, b) => {
    switch (sortBy) {
      case 'value':
        return parseFloat(b.getAttribute('data-value')) - parseFloat(a.getAttribute('data-value'));
      case 'prob':
        return parseInt(b.getAttribute('data-prob')) - parseInt(a.getAttribute('data-prob'));
      case 'stage':
        return (stageOrder[a.getAttribute('data-stage')] || 99) - (stageOrder[b.getAttribute('data-stage')] || 99);
      case 'name':
        return a.getAttribute('data-name').localeCompare(b.getAttribute('data-name'));
      default:
        return 0;
    }
  });
  rows.forEach(row => container.appendChild(row));
}

// ‚îÄ‚îÄ‚îÄ MARKET INTEL VIEW ‚îÄ‚îÄ‚îÄ
function renderMarketIntel() {
  return `<div style="max-width:900px;">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:20px;">
      <div>
        <div style="font-family:'Cormorant Garamond',serif;font-size:28px;font-weight:600;color:var(--cream);">Market Intelligence</div>
        <div style="font-size:12px;color:var(--text-dim);margin-top:4px;">15 submarkets ¬∑ 3 metros ¬∑ Updated continuously</div>
      </div>
      <button onclick="openIntelPanel()" style="padding:8px 16px;background:var(--gold);color:#0A0C0E;border:none;border-radius:4px;font-weight:600;font-family:'Syne',sans-serif;font-size:11px;cursor:pointer;">+ Add Intelligence</button>
    </div>
    ${viewSection('Metro Overview')}
    <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;margin-bottom:16px;">
      ${[
        { metro: 'Los Angeles', vacancy: '14.2%', trend: '‚ñº 0.8%', trendColor: 'var(--green)', markets: 10, rent: '$62/SF', outlook: 'Improving' },
        { metro: 'San Francisco', vacancy: '21.1%', trend: '‚ñ≤ 1.2%', trendColor: 'var(--red)', markets: 3, rent: '$61/SF', outlook: 'Distressed' },
        { metro: 'Seattle', vacancy: '10.1%', trend: '‚ñº 0.8%', trendColor: 'var(--green)', markets: 2, rent: '$55/SF', outlook: 'Recovering' }
      ].map(m => viewCard(`
        <div style="text-align:center;margin-bottom:12px;">
          <div style="font-size:14px;font-weight:600;color:var(--cream);margin-bottom:4px;">${m.metro}</div>
          <div style="font-family:'Cormorant Garamond',serif;font-size:32px;color:${parseFloat(m.vacancy) > 15 ? 'var(--red)' : 'var(--cream)'};">${m.vacancy}</div>
          <div style="font-size:11px;color:${m.trendColor};margin-top:2px;">${m.trend} (90d)</div>
        </div>
        ${detailRow('Submarkets', m.markets, 'var(--cream)')}
        ${detailRow('Avg. Rent', m.rent, 'var(--gold)')}
        ${detailRow('Outlook', m.outlook, m.outlook === 'Distressed' ? 'var(--red)' : 'var(--green)')}
      `)).join('')}
    </div>
    ${viewSection('Recent Intel Updates')}
    ${[
      { icon: '‚ö°', title: 'Snap vacating 42K SF ‚Äî Santa Monica', time: '2 min ago', agent: 'Intel Agent', priority: 'high' },
      { icon: 'üåê', title: 'SF Financial vacancy hits 26.3% ‚Äî 18-month high', time: '2 hr ago', agent: 'Intel Agent', priority: 'med' },
      { icon: 'üì°', title: 'Zoning variance: 1150 S Olive St mixed-use conversion', time: '1 hr ago', agent: 'Permit Agent', priority: 'med' },
      { icon: 'üè¢', title: 'Playa Vista badge-in occupancy at 74% vs 61% DTLA avg', time: '4 hr ago', agent: 'Intel Agent', priority: 'low' },
      { icon: 'üìä', title: 'CBRE closed 18,500 SF at Water Garden ‚Äî 3 remaining comps', time: '2 hr ago', agent: 'Intel Agent', priority: 'low' }
    ].map(u => viewCard(`
      <div style="display:flex;gap:12px;align-items:center;">
        <div style="font-size:18px;">${u.icon}</div>
        <div style="flex:1;"><div style="font-size:13px;font-weight:600;color:var(--cream);">${u.title}</div><div style="font-size:10px;color:var(--text-dim);margin-top:2px;">${u.time} ¬∑ ${u.agent}</div></div>
        <span style="font-family:'JetBrains Mono',monospace;font-size:8px;padding:2px 8px;border-radius:2px;background:${u.priority === 'high' ? 'var(--red-dim)' : u.priority === 'med' ? 'var(--gold-dim)' : 'var(--surface-2)'};color:${u.priority === 'high' ? 'var(--red)' : u.priority === 'med' ? 'var(--gold)' : 'var(--text-dim)'};">${u.priority.toUpperCase()}</span>
      </div>
    `)).join('')}
    <div style="margin-top:20px;text-align:center;"><button onclick="switchView('dashboard')" style="padding:10px 24px;background:var(--surface-2);border:1px solid var(--border);border-radius:4px;color:var(--text);font-family:'Syne',sans-serif;font-size:12px;cursor:pointer;">‚Üê Back to Dashboard</button></div>
  </div>`;
}

// ‚îÄ‚îÄ‚îÄ TENANT LEADS VIEW ‚îÄ‚îÄ‚îÄ
function renderTenantLeads() {
  const leads = [
    { name: 'TechCo Inc.', type: 'Series C ¬∑ SaaS', signal: 'Very High', signalColor: 'var(--green)', sf: '15‚Äì25K SF', market: 'Playa Vista', signals: ['40+ LA job postings (30d)', 'WeWork badge-in +62% MoM', 'Glassdoor headcount growing rapidly'], timeline: 'Q3 2026', contact: 'VP Operations (to be identified)' },
    { name: 'Shopify', type: 'Public ¬∑ E-commerce', signal: 'High', signalColor: 'var(--gold)', sf: '18K SF (sublease exit)', market: 'Santa Monica', signals: ['Sublease listing filed 48 hours ago', 'Below-market asking: $66/SF NNN', 'Creative office w/ outdoor space'], timeline: 'Q2 2026', contact: 'Real Estate Dept' },
    { name: 'Meridian Health Partners', type: 'Private ¬∑ Healthcare', signal: 'Moderate', signalColor: 'var(--amber)', sf: '9K SF', market: 'Burbank / Glendale', signals: ['New LLC filing in CA', 'Job postings for clinical staff', 'Specific zoning requirements for clinic use'], timeline: 'Q4 2026', contact: 'Michael Torres, CFO' }
  ];
  return `<div style="max-width:900px;">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:20px;">
      <div>
        <div style="font-family:'Cormorant Garamond',serif;font-size:28px;font-weight:600;color:var(--cream);">Tenant Leads</div>
        <div style="font-size:12px;color:var(--text-dim);margin-top:4px;">3 new high-intent tenants this week ¬∑ 31 total (30d)</div>
      </div>
    </div>
    ${leads.map(l => viewCard(`
      <div style="display:flex;gap:16px;align-items:flex-start;">
        <div style="width:44px;height:44px;border-radius:8px;background:var(--gold-dim);border:1px solid var(--border-gold);display:flex;align-items:center;justify-content:center;font-size:18px;flex-shrink:0;">üéØ</div>
        <div style="flex:1;">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;">
            <div><div style="font-size:15px;font-weight:600;color:var(--cream);">${l.name}</div><div style="font-size:11px;color:var(--text-dim);">${l.type}</div></div>
            <span style="font-family:'JetBrains Mono',monospace;font-size:9px;padding:3px 10px;background:var(--surface-2);border:1px solid var(--border);border-radius:12px;color:${l.signalColor};">‚óè ${l.signal} Intent</span>
          </div>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:6px;margin:10px 0;">
            ${detailRow('Est. Need', l.sf, 'var(--cream)')}
            ${detailRow('Target Market', l.market, 'var(--cream)')}
            ${detailRow('Timeline', l.timeline, 'var(--text-mid)')}
            ${detailRow('Contact', l.contact, 'var(--cream)')}
          </div>
          <div style="margin:10px 0;">
            <div style="font-family:'JetBrains Mono',monospace;font-size:8px;color:var(--gold);letter-spacing:0.1em;margin-bottom:6px;">EXPANSION SIGNALS</div>
            ${l.signals.map(s => `<div style="font-size:11px;color:var(--text);padding:4px 0;display:flex;gap:6px;align-items:center;"><span style="color:var(--green);">‚óè</span> ${s}</div>`).join('')}
          </div>
          <div style="display:flex;gap:8px;margin-top:12px;">
            <button onclick="showModal('Outreach','Draft Outreach ‚Äî ${l.name}','<div style=\\'font-size:13px;color:var(--text);\\'>Outreach Agent will draft a personalized pitch for ${l.name} based on their expansion signals and preferred markets.</div>')" style="padding:6px 14px;background:var(--gold);color:#0A0C0E;border:none;border-radius:4px;font-weight:600;font-family:'Syne',sans-serif;font-size:10px;cursor:pointer;">Draft Outreach</button>
            <button onclick="openAddDealModal()" style="padding:6px 14px;background:var(--surface-2);border:1px solid var(--border);border-radius:4px;color:var(--text);font-family:'Syne',sans-serif;font-size:10px;cursor:pointer;">Add to Pipeline</button>
            <button style="padding:6px 14px;background:var(--surface-2);border:1px solid var(--border);border-radius:4px;color:var(--text);font-family:'Syne',sans-serif;font-size:10px;cursor:pointer;">Dismiss Lead</button>
          </div>
        </div>
      </div>
    `)).join('')}
    <div style="margin-top:20px;text-align:center;"><button onclick="switchView('dashboard')" style="padding:10px 24px;background:var(--surface-2);border:1px solid var(--border);border-radius:4px;color:var(--text);font-family:'Syne',sans-serif;font-size:12px;cursor:pointer;">‚Üê Back to Dashboard</button></div>
  </div>`;
}

// ‚îÄ‚îÄ‚îÄ REPORTS ‚îÄ‚îÄ‚îÄ
function renderWestCoastReport() {
  return `<div style="max-width:900px;">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:20px;">
      <div>
        <div style="font-family:'Cormorant Garamond',serif;font-size:28px;font-weight:600;color:var(--cream);">West Coast Markets Report</div>
        <div style="font-size:12px;color:var(--text-dim);margin-top:4px;">Updated weekly ¬∑ Last refreshed: Today 6:00 AM PST</div>
      </div>
      <div style="display:flex;gap:8px;">
        <button onclick="showToast('Generating PDF report...')" style="padding:8px 16px;background:var(--surface-2);border:1px solid var(--border);border-radius:4px;color:var(--text);font-family:'Syne',sans-serif;font-size:11px;cursor:pointer;">‚Üì Export PDF</button>
        <button onclick="showToast('Generating Excel export...')" style="padding:8px 16px;background:var(--surface-2);border:1px solid var(--border);border-radius:4px;color:var(--text);font-family:'Syne',sans-serif;font-size:11px;cursor:pointer;">‚Üì Export Excel</button>
        <button onclick="showToast('Scheduling weekly delivery...')" style="padding:8px 16px;background:var(--gold-dim);border:1px solid var(--border-gold);border-radius:4px;color:var(--gold);font-family:'Syne',sans-serif;font-size:11px;cursor:pointer;">üìÖ Schedule</button>
      </div>
    </div>
    ${viewSection('Executive Summary')}
    ${viewCard(`<div style="font-size:13px;color:var(--text);line-height:1.8;">
      <p style="margin-bottom:10px;">West Coast office markets showed mixed signals in Q1 2026. LA metro continues its recovery trajectory with vacancy declining to 14.2%, driven by TAMI sector absorption in Westside submarkets. San Francisco remains challenged at 21.1% average vacancy, though AI/ML startups are beginning to backfill some of the tech downsizing. Seattle metro is the strongest performer at 10.1%, buoyed by Amazon's RTO policies.</p>
      <p>Key themes: flight to quality in Class A, creative office outperformance, and growing healthcare sector demand in suburban markets.</p>
    </div>`)}
    ${viewSection('LA Metro ‚Äî 10 Submarkets')}
    ${viewCard(`<div style="overflow-x:auto;">
      <table style="width:100%;border-collapse:collapse;font-size:11px;">
        <thead><tr style="border-bottom:1px solid var(--border);">
          <th style="text-align:left;padding:8px;font-family:'JetBrains Mono',monospace;font-size:8px;color:var(--text-dim);letter-spacing:0.1em;">SUBMARKET</th>
          <th style="text-align:right;padding:8px;font-family:'JetBrains Mono',monospace;font-size:8px;color:var(--text-dim);">VACANCY</th>
          <th style="text-align:right;padding:8px;font-family:'JetBrains Mono',monospace;font-size:8px;color:var(--text-dim);">90D TREND</th>
          <th style="text-align:right;padding:8px;font-family:'JetBrains Mono',monospace;font-size:8px;color:var(--text-dim);">AVG RENT</th>
          <th style="text-align:right;padding:8px;font-family:'JetBrains Mono',monospace;font-size:8px;color:var(--text-dim);">OUTLOOK</th>
        </tr></thead>
        <tbody>
          ${[
            ['Manhattan Beach', '5.9%', '‚ñº 0.2%', '$56/SF', 'Very Tight'],
            ['El Segundo', '6.7%', '‚ñº 0.4%', '$48/SF', 'Tight'],
            ['West Hollywood', '7.3%', '‚ñº 0.5%', '$58/SF', 'Tight'],
            ['Playa Vista', '8.1%', '‚ñº 0.9%', '$68/SF', 'Tightening'],
            ['Santa Monica', '9.8%', '‚ñº 1.1%', '$72/SF', 'Tightening'],
            ['Burbank', '10.4%', '‚ñº 0.7%', '$52/SF', 'Stable'],
            ['Culver City', '11.2%', '‚ñº 0.6%', '$62/SF', 'Tightening'],
            ['Century City', '12.6%', '‚ñº 0.3%', '$82/SF', 'Premium'],
            ['Wilshire Corridor', '16.1%', '‚ñ≤ 0.4%', '$46/SF', 'Soft'],
            ['DTLA', '18.4%', '‚ñ≤ 1.2%', '$54/SF', 'Elevated']
          ].map(r => `<tr style="border-bottom:1px solid var(--border);">
            <td style="padding:8px;color:var(--cream);font-weight:600;">${r[0]}</td>
            <td style="text-align:right;padding:8px;color:${parseFloat(r[1]) > 15 ? 'var(--red)' : parseFloat(r[1]) > 10 ? 'var(--amber)' : 'var(--green)'};">${r[1]}</td>
            <td style="text-align:right;padding:8px;color:${r[2].includes('‚ñº') ? 'var(--green)' : 'var(--red)'};">${r[2]}</td>
            <td style="text-align:right;padding:8px;color:var(--gold);">${r[3]}</td>
            <td style="text-align:right;padding:8px;color:var(--text-mid);">${r[4]}</td>
          </tr>`).join('')}
        </tbody>
      </table>
    </div>`)}
    ${viewSection('SF & Seattle Metros')}
    ${viewCard(`<div style="overflow-x:auto;">
      <table style="width:100%;border-collapse:collapse;font-size:11px;">
        <thead><tr style="border-bottom:1px solid var(--border);">
          <th style="text-align:left;padding:8px;font-family:'JetBrains Mono',monospace;font-size:8px;color:var(--text-dim);letter-spacing:0.1em;">SUBMARKET</th>
          <th style="text-align:right;padding:8px;font-family:'JetBrains Mono',monospace;font-size:8px;color:var(--text-dim);">VACANCY</th>
          <th style="text-align:right;padding:8px;font-family:'JetBrains Mono',monospace;font-size:8px;color:var(--text-dim);">90D TREND</th>
          <th style="text-align:right;padding:8px;font-family:'JetBrains Mono',monospace;font-size:8px;color:var(--text-dim);">AVG RENT</th>
          <th style="text-align:right;padding:8px;font-family:'JetBrains Mono',monospace;font-size:8px;color:var(--text-dim);">OUTLOOK</th>
        </tr></thead>
        <tbody>
          ${[
            ['Bellevue WA', '9.2%', '‚ñº 1.0%', '$58/SF', 'Recovering'],
            ['Seattle SLU', '11.0%', '‚ñº 0.6%', '$52/SF', 'Recovering'],
            ['SF Mission', '14.8%', '‚ñº 0.3%', '$54/SF', 'Stabilizing'],
            ['SF SOMA', '22.1%', '‚ñ≤ 1.4%', '$62/SF', 'Distressed'],
            ['SF Financial', '26.3%', '‚ñ≤ 2.1%', '$68/SF', 'Distressed']
          ].map(r => `<tr style="border-bottom:1px solid var(--border);">
            <td style="padding:8px;color:var(--cream);font-weight:600;">${r[0]}</td>
            <td style="text-align:right;padding:8px;color:${parseFloat(r[1]) > 15 ? 'var(--red)' : parseFloat(r[1]) > 10 ? 'var(--amber)' : 'var(--green)'};">${r[1]}</td>
            <td style="text-align:right;padding:8px;color:${r[2].includes('‚ñº') ? 'var(--green)' : 'var(--red)'};">${r[2]}</td>
            <td style="text-align:right;padding:8px;color:var(--gold);">${r[3]}</td>
            <td style="text-align:right;padding:8px;color:var(--text-mid);">${r[4]}</td>
          </tr>`).join('')}
        </tbody>
      </table>
    </div>`)}
    <div style="margin-top:20px;text-align:center;"><button onclick="switchView('dashboard')" style="padding:10px 24px;background:var(--surface-2);border:1px solid var(--border);border-radius:4px;color:var(--text);font-family:'Syne',sans-serif;font-size:12px;cursor:pointer;">‚Üê Back to Dashboard</button></div>
  </div>`;
}

function renderSubmarketTracker() {
  return `<div style="max-width:900px;">
    <div style="font-family:'Cormorant Garamond',serif;font-size:28px;font-weight:600;color:var(--cream);margin-bottom:4px;">Submarket Tracker</div>
    <div style="font-size:12px;color:var(--text-dim);margin-bottom:20px;">24-month historical trends ¬∑ 15 submarkets</div>
    ${viewSection('Vacancy Trends ‚Äî Last 6 Quarters')}
    ${viewCard(`<div style="overflow-x:auto;">
      <table style="width:100%;border-collapse:collapse;font-size:11px;">
        <thead><tr style="border-bottom:1px solid var(--border);">
          <th style="text-align:left;padding:8px;font-family:'JetBrains Mono',monospace;font-size:8px;color:var(--text-dim);">SUBMARKET</th>
          <th style="text-align:right;padding:8px;font-family:'JetBrains Mono',monospace;font-size:8px;color:var(--text-dim);">Q4 '24</th>
          <th style="text-align:right;padding:8px;font-family:'JetBrains Mono',monospace;font-size:8px;color:var(--text-dim);">Q1 '25</th>
          <th style="text-align:right;padding:8px;font-family:'JetBrains Mono',monospace;font-size:8px;color:var(--text-dim);">Q2 '25</th>
          <th style="text-align:right;padding:8px;font-family:'JetBrains Mono',monospace;font-size:8px;color:var(--text-dim);">Q3 '25</th>
          <th style="text-align:right;padding:8px;font-family:'JetBrains Mono',monospace;font-size:8px;color:var(--text-dim);">Q4 '25</th>
          <th style="text-align:right;padding:8px;font-family:'JetBrains Mono',monospace;font-size:8px;color:var(--gold);">NOW</th>
        </tr></thead>
        <tbody>
          ${[
            ['Santa Monica', '12.1%', '11.4%', '10.8%', '10.5%', '10.2%', '9.8%'],
            ['Playa Vista', '10.2%', '9.8%', '9.4%', '8.9%', '8.5%', '8.1%'],
            ['Culver City', '13.1%', '12.6%', '12.2%', '11.8%', '11.5%', '11.2%'],
            ['DTLA', '16.8%', '17.2%', '17.5%', '17.9%', '18.1%', '18.4%'],
            ['SF Financial', '22.4%', '23.1%', '23.8%', '24.5%', '25.4%', '26.3%']
          ].map(r => `<tr style="border-bottom:1px solid var(--border);">
            <td style="padding:8px;color:var(--cream);font-weight:600;">${r[0]}</td>
            ${r.slice(1).map((v,i) => `<td style="text-align:right;padding:8px;color:${i === 5 ? 'var(--gold)' : 'var(--text-mid)'};">${v}</td>`).join('')}
          </tr>`).join('')}
        </tbody>
      </table>
    </div>`)}
    <div style="margin-top:20px;text-align:center;"><button onclick="switchView('dashboard')" style="padding:10px 24px;background:var(--surface-2);border:1px solid var(--border);border-radius:4px;color:var(--text);font-family:'Syne',sans-serif;font-size:12px;cursor:pointer;">‚Üê Back to Dashboard</button></div>
  </div>`;
}

function renderPortfolioAnalysis() {
  return `<div style="max-width:900px;">
    <div style="font-family:'Cormorant Garamond',serif;font-size:28px;font-weight:600;color:var(--cream);margin-bottom:4px;">Portfolio Analysis</div>
    <div style="font-size:12px;color:var(--text-dim);margin-bottom:20px;">Deal performance metrics and projections</div>
    ${viewSection('Pipeline Performance')}
    <div style="display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:12px;margin-bottom:16px;">
      ${[
        { label: 'Win Rate (12mo)', val: '68%', color: 'var(--green)' },
        { label: 'Avg. Close Time', val: '94 days', color: 'var(--cream)' },
        { label: 'Avg. Deal Size', val: '$15.6M', color: 'var(--gold)' },
        { label: 'Revenue (YTD)', val: '$3.2M', color: 'var(--green)' }
      ].map(k => viewCard(`
        <div style="text-align:center;">
          <div style="font-family:'JetBrains Mono',monospace;font-size:7px;letter-spacing:0.15em;color:var(--text-dim);margin-bottom:6px;">${k.label.toUpperCase()}</div>
          <div style="font-family:'Cormorant Garamond',serif;font-size:28px;color:${k.color};">${k.val}</div>
        </div>
      `)).join('')}
    </div>
    ${viewSection('Revenue Projection')}
    ${viewCard(`
      ${detailRow('Committed Revenue (LOI+Closing)', '$2.1M', 'var(--green)')}
      ${detailRow('Weighted Pipeline Revenue', '$4.8M', 'var(--gold)')}
      ${detailRow('Best Case (all deals close)', '$8.4M', 'var(--cream)')}
      ${detailRow('Expected Annual', '$6.2M', 'var(--gold)')}
    `)}
    ${viewSection('Deal Velocity')}
    ${viewCard(`
      ${detailRow('Prospect ‚Üí Qualifying', 'Avg. 12 days', 'var(--cream)')}
      ${detailRow('Qualifying ‚Üí Proposal', 'Avg. 28 days', 'var(--cream)')}
      ${detailRow('Proposal ‚Üí LOI', 'Avg. 35 days', 'var(--cream)')}
      ${detailRow('LOI ‚Üí Closing', 'Avg. 19 days', 'var(--cream)')}
    `)}
    <div style="margin-top:20px;text-align:center;"><button onclick="switchView('dashboard')" style="padding:10px 24px;background:var(--surface-2);border:1px solid var(--border);border-radius:4px;color:var(--text);font-family:'Syne',sans-serif;font-size:12px;cursor:pointer;">‚Üê Back to Dashboard</button></div>
  </div>`;
}

// ‚îÄ‚îÄ‚îÄ SETTINGS VIEWS ‚îÄ‚îÄ‚îÄ
function renderPreferences() {
  return `<div style="max-width:700px;">
    <div style="font-family:'Cormorant Garamond',serif;font-size:28px;font-weight:600;color:var(--cream);margin-bottom:4px;">Settings & Preferences</div>
    <div style="font-size:12px;color:var(--text-dim);margin-bottom:20px;">Customize your LandMarq experience</div>
    ${viewSection('Profile')}
    ${viewCard(
      editableRow('Display Name', 'Mark Sullivan', 'pref-name')
      + editableRow('Company', 'Savills North America', 'pref-company')
      + editableRow('Title', 'Executive Vice President', 'pref-title')
      + editableRow('Email', 'msullivan@savills.com', 'pref-email', 'email')
    )}
    ${viewSection('Morning Brief')}
    ${viewCard(
      editableRow('Delivery Time', '06:00', 'pref-brief-time', 'time')
      + editableRow('Timezone', 'America/Los_Angeles', 'pref-tz', 'select', ['America/Los_Angeles', 'America/New_York', 'America/Chicago', 'America/Denver', 'UTC'])
      + editableRow('Frequency', 'Daily', 'pref-brief-freq', 'select', ['Daily', 'Weekdays Only', 'Mon/Wed/Fri', 'Weekly (Monday)'])
      + editableRow('Delivery Method', 'Dashboard + Email', 'pref-delivery', 'select', ['Dashboard Only', 'Dashboard + Email', 'Dashboard + Email + Slack', 'Email Only'])
    )}
    ${viewSection('Notifications & Alerts')}
    ${viewCard(
      editableRow('Alert Priority Threshold', 'Medium + High', 'pref-alert-threshold', 'select', ['All Alerts', 'Medium + High', 'High Only', 'Critical Only'])
      + editableRow('Email Notifications', true, 'pref-email-notif', 'toggle')
      + editableRow('Browser Notifications', true, 'pref-browser-notif', 'toggle')
      + editableRow('Slack Notifications', false, 'pref-slack-notif', 'toggle')
      + editableRow('Daily Digest Email', true, 'pref-digest', 'toggle')
    )}
    ${viewSection('Markets & Coverage')}
    ${viewCard(
      editableRow('Primary Metro', 'Los Angeles', 'pref-metro', 'select', ['Los Angeles', 'San Francisco', 'Seattle', 'Phoenix', 'Denver', 'All West Coast'])
      + editableRow('Monitored Submarkets', '15', 'pref-submarkets')
      + editableRow('Property Types', 'Office, Industrial', 'pref-types', 'select', ['Office Only', 'Office, Industrial', 'Office, Industrial, Retail', 'All Types'])
      + editableRow('Industry Focus', 'TAMI, Healthcare, Financial', 'pref-industries')
    )}
    ${viewSection('Agent Configuration')}
    ${viewCard(
      editableRow('Intel Agent', true, 'pref-agent-intel', 'toggle')
      + editableRow('Lead Finder', true, 'pref-agent-lead', 'toggle')
      + editableRow('LOI Review', true, 'pref-agent-loi', 'toggle')
      + editableRow('Outreach Agent', true, 'pref-agent-outreach', 'toggle')
      + editableRow('Zoning Monitor', true, 'pref-agent-zoning', 'toggle')
      + editableRow('Macro Analyst', true, 'pref-agent-macro', 'toggle')
    )}
    ${viewSection('Plan & Billing')}
    ${viewCard(
      detailRow('Current Plan', 'Pro ¬∑ 3 seats', 'var(--gold)')
      + detailRow('Billing Cycle', 'Annual', 'var(--cream)')
      + detailRow('Next Renewal', 'Jan 15, 2027', 'var(--text-mid)')
      + `<button style="margin-top:12px;padding:8px 16px;background:var(--surface-2);border:1px solid var(--border);border-radius:4px;color:var(--text);font-family:'Syne',sans-serif;font-size:11px;cursor:pointer;">Manage Billing ‚Üí</button>`
    )}
    ${viewSection('Data & Privacy')}
    ${viewCard(
      editableRow('Data Retention', '12 months', 'pref-retention', 'select', ['6 months', '12 months', '24 months', 'Indefinite'])
      + editableRow('Share Analytics with Team', true, 'pref-share-analytics', 'toggle')
      + `<div style="display:flex;gap:8px;margin-top:12px;">
        <button style="padding:8px 16px;background:var(--surface-2);border:1px solid var(--border);border-radius:4px;color:var(--text);font-family:'Syne',sans-serif;font-size:11px;cursor:pointer;">Export My Data</button>
        <button style="padding:8px 16px;background:var(--red-dim);border:1px solid rgba(192,83,58,0.2);border-radius:4px;color:var(--red);font-family:'Syne',sans-serif;font-size:11px;cursor:pointer;">Delete Account</button>
      </div>`
    )}
    <button id="settings-save-btn" onclick="saveSettings()" style="width:100%;margin-top:16px;padding:14px;background:var(--gold);color:#0A0C0E;border:none;border-radius:4px;font-weight:700;font-family:'Syne',sans-serif;font-size:14px;cursor:pointer;opacity:0.5;" disabled>Save Changes</button>
    <div style="margin-top:20px;text-align:center;"><button onclick="switchView('dashboard')" style="padding:10px 24px;background:var(--surface-2);border:1px solid var(--border);border-radius:4px;color:var(--text);font-family:'Syne',sans-serif;font-size:12px;cursor:pointer;">‚Üê Back to Dashboard</button></div>
  </div>`;
}

function renderBriefSchedule() {
  return `<div style="max-width:700px;">
    <div style="font-family:'Cormorant Garamond',serif;font-size:28px;font-weight:600;color:var(--cream);margin-bottom:4px;">Brief Schedule</div>
    <div style="font-size:12px;color:var(--text-dim);margin-bottom:20px;">Configure when and how your intelligence briefs are delivered</div>
    ${viewSection('Morning Brief')}
    ${viewCard(
      editableRow('Delivery Time', '06:00', 'sched-morning-time', 'time')
      + editableRow('Days', 'Weekdays Only', 'sched-morning-days', 'select', ['Every Day', 'Weekdays Only', 'Mon/Wed/Fri', 'Monday Only'])
      + editableRow('Delivery', 'Dashboard + Email', 'sched-morning-delivery', 'select', ['Dashboard Only', 'Dashboard + Email', 'Email Only'])
      + editableRow('Include Market Data', true, 'sched-morning-market', 'toggle')
      + editableRow('Include Agent Activity', true, 'sched-morning-agents', 'toggle')
      + editableRow('Include Pipeline Updates', true, 'sched-morning-pipeline', 'toggle')
    )}
    ${viewSection('Weekly Digest')}
    ${viewCard(
      editableRow('Delivery Day', 'Monday', 'sched-weekly-day', 'select', ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'])
      + editableRow('Delivery Time', '08:00', 'sched-weekly-time', 'time')
      + editableRow('Enabled', true, 'sched-weekly-enabled', 'toggle')
    )}
    ${viewSection('Alert Notifications')}
    ${viewCard(
      editableRow('Realtime Alerts', true, 'sched-realtime', 'toggle')
      + editableRow('Minimum Priority', 'Medium', 'sched-min-priority', 'select', ['Low', 'Medium', 'High', 'Critical Only'])
      + editableRow('Quiet Hours', '10:00 PM - 6:00 AM', 'sched-quiet')
      + editableRow('Weekend Alerts', false, 'sched-weekend', 'toggle')
    )}
    <button id="settings-save-btn" onclick="saveSettings()" style="width:100%;margin-top:16px;padding:14px;background:var(--gold);color:#0A0C0E;border:none;border-radius:4px;font-weight:700;font-family:'Syne',sans-serif;font-size:14px;cursor:pointer;opacity:0.5;" disabled>Save Changes</button>
    <div style="margin-top:20px;text-align:center;"><button onclick="switchView('dashboard')" style="padding:10px 24px;background:var(--surface-2);border:1px solid var(--border);border-radius:4px;color:var(--text);font-family:'Syne',sans-serif;font-size:12px;cursor:pointer;">‚Üê Back to Dashboard</button></div>
  </div>`;
}

// ‚îÄ‚îÄ‚îÄ REBIND EVENTS AFTER RESTORING DASHBOARD ‚îÄ‚îÄ‚îÄ
function rebindDashboardEvents() {
  // Re-bind heatmap clicks
  document.querySelectorAll('.heatmap-cell').forEach(cell => {
    cell.style.cursor = 'pointer';
    cell.addEventListener('click', () => {
      const market = cell.querySelector('.heat-market')?.textContent;
      if (market) showHeatmapDetail(market);
    });
  });
  // Re-bind KPI clicks
  document.querySelectorAll('.kpi-card').forEach((card, i) => {
    card.style.cursor = 'pointer';
    card.addEventListener('click', () => {
      const d = kpiData[i];
      if (d) showModal(d.badge, d.title, d.body());
    });
  });
  // Re-bind pipeline clicks
  document.querySelectorAll('.pipeline-table tbody tr').forEach((row, i) => {
    row.style.cursor = 'pointer';
    row.addEventListener('click', () => showDealDetail(i));
  });
  // Re-bind stream item clicks
  document.querySelectorAll('.stream-item').forEach((item, i) => {
    item.style.cursor = 'pointer';
    item.addEventListener('click', () => {
      const d = agentFeedDetails[i];
      if (d) showModal(d.badge, d.title, d.body());
    });
  });
  // Re-bind alert clicks
  document.querySelectorAll('.alert-item').forEach((item, i) => {
    item.style.cursor = 'pointer';
    item.addEventListener('click', () => {
      const wf = alertWorkflows[i];
      const title = item.querySelector('.alert-title')?.textContent || 'Alert';
      const body = item.querySelector('.alert-body')?.textContent || '';
      const agent = item.querySelector('.alert-agent')?.textContent || '';
      const time = item.querySelector('.alert-time')?.textContent || '';
      let stepsHtml = '';
      if (wf) {
        stepsHtml = `<div style="font-family:'JetBrains Mono',monospace;font-size:9px;color:var(--gold);letter-spacing:0.1em;margin:16px 0 10px;">NEXT STEPS</div>`;
        wf.steps.forEach((s, si) => {
          const colors = { done: { bg: 'var(--green-dim)', border: 'rgba(74,155,111,0.2)', icon: '‚úì', iconColor: 'var(--green)' }, ready: { bg: 'var(--gold-dim)', border: 'var(--border-gold)', icon: '‚Üí', iconColor: 'var(--gold)' }, upcoming: { bg: 'var(--surface-2)', border: 'var(--border)', icon: (si+1).toString(), iconColor: 'var(--text-dim)' } };
          const c = colors[s.status];
          stepsHtml += `<div style="display:flex;gap:10px;align-items:flex-start;padding:10px 12px;background:${c.bg};border:1px solid ${c.border};border-radius:6px;margin-bottom:6px;"><div style="width:22px;height:22px;border-radius:50%;background:${s.status === 'done' ? 'var(--green)' : s.status === 'ready' ? 'var(--gold)' : 'var(--surface-3)'};display:flex;align-items:center;justify-content:center;font-size:10px;font-weight:700;color:${s.status === 'upcoming' ? 'var(--text-dim)' : '#0A0C0E'};flex-shrink:0;">${c.icon}</div><div><div style="font-size:12px;font-weight:600;color:var(--cream);${s.status === 'done' ? 'text-decoration:line-through;opacity:0.6;' : ''}">${s.label}</div><div style="font-size:11px;color:var(--text-mid);margin-top:2px;">${s.desc}</div></div></div>`;
        });
      }
      showModal('Alert Detail', title,
        `<div style="font-size:13px;color:var(--text);line-height:1.6;margin-bottom:12px;">${body}</div>`
        + detailRow('Source Agent', agent, 'var(--gold)')
        + detailRow('Time', time, 'var(--text-mid)')
        + stepsHtml
      );
    });
  });
  // Re-bind alert action buttons
  document.querySelectorAll('.alert-action-btn').forEach(btn => {
    btn.style.cursor = 'pointer';
  });
  // Re-bind card action links
  document.querySelectorAll('.card-action').forEach(action => {
    action.style.cursor = 'pointer';
  });
}

// ‚îÄ‚îÄ‚îÄ SIDEBAR NAV CLICK HANDLERS ‚îÄ‚îÄ‚îÄ
(function() {
  // Sidebar items with IDs ‚Äî now use view system
  const viewMap = {
    'nav-brief': 'morning-brief',
    'nav-agents': 'agent-fleet',
    'nav-pipeline': 'pipeline',
    'nav-leads': 'tenant-leads'
  };

  Object.keys(viewMap).forEach(id => {
    const el = document.getElementById(id);
    if (el) {
      el.style.cursor = 'pointer';
      el.addEventListener('click', (e) => {
        e.stopPropagation();
        document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
        el.classList.add('active');
        switchView(viewMap[id]);
      });
    }
  });

  // Sidebar items without IDs ‚Äî use view system for full pages
  document.querySelectorAll('.nav-item').forEach(item => {
    const text = item.textContent.trim();
    let viewName = null;
    if (text.includes('Market Intel')) viewName = 'market-intel';
    else if (text.includes('West Coast Markets')) viewName = 'west-coast-report';
    else if (text.includes('Submarket Tracker')) viewName = 'submarket-tracker';
    else if (text.includes('Portfolio Analysis')) viewName = 'portfolio-analysis';
    else if (text.includes('Preferences')) viewName = 'preferences';
    else if (text.includes('Brief Schedule')) viewName = 'brief-schedule';

    if (viewName) {
      item.style.cursor = 'pointer';
      item.addEventListener('click', (e) => {
        e.stopPropagation();
        document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
        item.classList.add('active');
        switchView(viewName);
      });
    }
  });

  // Profile card click
  const profileCard = document.getElementById('nav-profile');
  if (profileCard) {
    profileCard.style.cursor = 'pointer';
    profileCard.addEventListener('click', () => {
      switchView('preferences');
    });
  }
})();

// ‚îÄ‚îÄ‚îÄ MAKE NEW STREAM ITEMS CLICKABLE (rich views) ‚îÄ‚îÄ‚îÄ
const streamEl = document.getElementById('agentStream');
if (streamEl) {
  const newStreamDetails = [
    { badge: 'Intel Agent', title: 'SF Financial District ‚Äî Vacancy Update',
      body: `<div style="font-size:13px;color:var(--text);line-height:1.7;margin-bottom:16px;">Intel Agent updated SF Financial District vacancy to 26.3% ‚Äî the highest in 18 months. This is driven by continued tech sector downsizing and remote work adoption.</div>`
      + detailRow('Current Vacancy', '26.3%', 'var(--red)')
      + detailRow('Previous (90d ago)', '24.2%', 'var(--text-mid)')
      + detailRow('Trend', '‚ñ≤ 2.1% (rising)', 'var(--red)')
      + detailRow('Largest Vacancies', 'Salesforce Tower 22F, 555 California 8-10F', 'var(--cream)')
      + `<div style="margin-top:12px;padding:10px;background:var(--red-dim);border:1px solid rgba(192,83,58,0.2);border-radius:6px;font-size:12px;color:var(--red);">SF Financial now ranks as the most distressed Class A submarket on the West Coast. Sublease inventory at 3.1M SF.</div>` },
    { badge: 'Lead Agent', title: 'New Lead ‚Äî Shopify Sublease Exit',
      body: `<div style="font-size:13px;color:var(--text);line-height:1.7;margin-bottom:16px;">Shopify is subletting 18K SF of creative office in Santa Monica. Lead Agent detected early vacancy signal from sublease listing filed 48 hours ago.</div>`
      + detailRow('Company', 'Shopify ¬∑ E-commerce ¬∑ Public', 'var(--cream)')
      + detailRow('Space', '18,000 SF ¬∑ Creative Office', 'var(--cream)')
      + detailRow('Location', 'Santa Monica ¬∑ 2nd St Corridor', 'var(--cream)')
      + detailRow('Available', 'Q2 2026 (sublease)', 'var(--amber)')
      + detailRow('Asking', '$66/SF NNN (below market)', 'var(--gold)')
      + `<div style="display:flex;gap:8px;margin-top:16px;"><button onclick="actionDraftOutreachAll(['TechCo Inc.','WestShore Media'],'Shopify Sublease ¬∑ 18K SF SM')" style="flex:1;padding:10px;background:var(--gold);color:#0A0C0E;border:none;border-radius:4px;font-weight:700;font-family:'Syne',sans-serif;font-size:12px;cursor:pointer;">Match with Tenants ‚Üí</button><button onclick="actionViewProperty('1520 2nd St','Santa Monica','18,000 SF','Creative Office','$66/SF NNN')" style="flex:1;padding:10px;background:var(--surface-2);border:1px solid var(--border);border-radius:4px;color:var(--text);font-family:'Syne',sans-serif;font-size:12px;cursor:pointer;">View Listing</button></div>` },
    { badge: 'LOI Agent', title: 'Document Review ‚Äî Apex Capital (Updated)',
      body: `<div style="font-size:13px;color:var(--text);line-height:1.7;margin-bottom:16px;">LOI Agent completed secondary review after Apex Capital's counsel responded. Assignment clause (Sec 7) has been updated to partial match.</div>`
      + detailRow('Original Flags', '2 non-standard clauses', 'var(--red)')
      + detailRow('Resolved', 'Sec 7 (Assignment) ‚Äî partial match', 'var(--amber)')
      + detailRow('Remaining', 'Sec 4.2 (Co-tenancy) ‚Äî still non-standard', 'var(--red)')
      + `<div style="display:flex;gap:8px;margin-top:16px;"><button onclick="actionGenerateRedline()" style="flex:1;padding:10px;background:var(--gold);color:#0A0C0E;border:none;border-radius:4px;font-weight:700;font-family:'Syne',sans-serif;font-size:12px;cursor:pointer;">View Updated Redline ‚Üí</button></div>` }
  ];
  let newStreamIdx = 0;

  const observer = new MutationObserver(mutations => {
    mutations.forEach(m => {
      m.addedNodes.forEach(node => {
        if (node.nodeType === 1 && node.classList.contains('stream-item') && !node._clickBound) {
          node._clickBound = true;
          node.style.cursor = 'pointer';
          const detail = newStreamDetails[newStreamIdx % newStreamDetails.length];
          newStreamIdx++;
          node.addEventListener('click', () => {
            showModal(detail.badge, detail.title, detail.body);
          });
        }
      });
    });
  });
  observer.observe(streamEl, { childList: true });
}
</script>

<!-- ‚îÄ‚îÄ‚îÄ AUTH GATE ‚îÄ‚îÄ‚îÄ -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
<script src="/js/supabase-config.js"></script>
<script>
(async function dashboardAuth() {
  try {
    // Check if Supabase loaded
    if (typeof LandMarqAuth === 'undefined') {
      console.error('LandMarq: Auth library not loaded');
      window.location.href = '/login?returnTo=/dashboard';
      return;
    }

    // Gate: require login
    const session = await LandMarqAuth.requireAuth();
    if (!session) return; // redirect happening

    // Populate user info in sidebar
    const user = session.user;
    const email = user.email || '';
    const meta = user.user_metadata || {};
    const displayName = meta.full_name || meta.name || email.split('@')[0];
    const initials = displayName.charAt(0).toUpperCase();

    const avatarEl = document.querySelector('#nav-profile .user-avatar');
    const nameEl = document.querySelector('#nav-profile .user-name');
    const titleEl = document.querySelector('#nav-profile .user-title');

    if (avatarEl) avatarEl.textContent = initials;
    if (nameEl) nameEl.textContent = displayName;
    if (titleEl) titleEl.textContent = email;

    // Show the page
    document.body.classList.add('auth-ready');
  } catch (err) {
    console.error('LandMarq auth error:', err);
    window.location.href = '/login?returnTo=/dashboard';
  }
})();
</script>

</body>
</html>
